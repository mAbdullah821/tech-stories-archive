<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>المحرر المطور - Writer Pro v25 (Fixed Code Preview)</title>

    <!-- Fonts & Tailwind -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@300;400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Highlight.js CSS for Code Coloring -->
    <link
      id="hljs-light-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css"
    />
    <link
      id="hljs-dark-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
      disabled
    />
    <!-- 
      ⚠️ SHARED STYLES - منسوخ من shared-styles.css
      المرجع الرئيسي: shared-styles.css
      عند التعديل: عدّل أولاً في shared-styles.css ثم انسخ المحتوى هنا
    -->
    <style>
      /**
       * Shared Styles for Blog System
       * This file contains all shared CSS between viewer.html and writer.html
       * to ensure consistent preview/display across both applications.
       * 
       * Version: 1.0
       */

      /* ============================================
         ANIMATIONS
         ============================================ */
      .animate-fade-in {
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Toast Notification Animation */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }

      @keyframes slideOut {
        from {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        to {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
      }

      .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
      }

      .toast-exit {
        animation: slideOut 0.3s ease-in forwards;
      }

      /* ============================================
         PROSE RTL - Typography for Markdown Content
         ============================================ */
      .prose-rtl {
        direction: rtl;
        text-align: right;
        line-height: 1.8;
        color: #334155;
      }

      .dark .prose-rtl {
        color: #cbd5e1;
      }

      /* Headers */
      .prose-rtl h1,
      .prose-rtl h2,
      .prose-rtl h3 {
        color: #0f172a;
        font-weight: 800;
        margin-top: 1.5em;
        margin-bottom: 0.8em;
      }

      .dark .prose-rtl h1,
      .dark .prose-rtl h2,
      .dark .prose-rtl h3 {
        color: #f8fafc;
      }

      .prose-rtl h1 {
        font-size: 2.25em;
      }

      .prose-rtl h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5em;
      }

      .dark .prose-rtl h2 {
        border-color: #334155;
      }

      .prose-rtl h3 {
        font-size: 1.25em;
      }

      /* Paragraphs */
      .prose-rtl p {
        margin-bottom: 1.2em;
      }

      /* Lists */
      .prose-rtl ul {
        list-style-type: disc;
        padding-right: 1.5em;
        margin-bottom: 1.2em;
      }

      .prose-rtl ol {
        list-style-type: decimal;
        padding-right: 1.5em;
        margin-bottom: 1.2em;
      }

      /* Blockquotes */
      .prose-rtl blockquote {
        border-right: 4px solid #10b981;
        padding-right: 1em;
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5em;
        font-style: italic;
      }

      .dark .prose-rtl blockquote {
        background: #1e293b;
        border-color: #34d399;
      }

      /* Images */
      .prose-rtl img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem auto;
        display: block;
        cursor: zoom-in;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .prose-rtl img:hover {
        transform: scale(1.01);
      }

      /* Images inside flex containers should not have auto margins */
      .prose-rtl .flex img {
        margin: 0;
      }

      /* ============================================
         FLEX LAYOUT UTILITIES
         ============================================ */
      .prose-rtl .flex {
        display: flex;
      }

      .prose-rtl .flex-wrap {
        flex-wrap: wrap;
      }

      .prose-rtl .flex-row {
        flex-direction: row;
      }

      .prose-rtl .flex-col {
        flex-direction: column;
      }

      .prose-rtl .gap-2 {
        gap: 0.5rem;
      }

      .prose-rtl .gap-3 {
        gap: 0.75rem;
      }

      .prose-rtl .gap-4 {
        gap: 1rem;
      }

      .prose-rtl .items-center {
        align-items: center;
      }

      .prose-rtl .justify-center {
        justify-content: center;
      }

      .prose-rtl .flex-shrink-0 {
        flex-shrink: 0;
      }

      .prose-rtl .flex-shrink-0 img {
        margin: 0;
        max-width: 300px;
        display: block;
      }

      .prose-rtl .mx-2 {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
      }

      .prose-rtl .flex-row img {
        max-width: 300px;
        max-height: 400px;
      }

      .prose-rtl .flex-col img {
        max-width: 100%;
        max-height: 400px;
      }

      /* ============================================
         GRID LAYOUT FOR IMAGES
         ============================================ */
      .prose-rtl .grid {
        display: grid;
        gap: 0.5rem;
      }

      .prose-rtl .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      .prose-rtl .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .prose-rtl .grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .prose-rtl .grid img {
        margin: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Smaller images for inline layout */
      .prose-rtl .grid.grid-cols-3 img {
        max-height: 120px !important;
        min-height: 80px !important;
      }

      .prose-rtl .grid.grid-cols-2 img {
        max-height: 120px !important;
        min-height: 80px !important;
      }

      .prose-rtl .grid.grid-cols-1 img {
        max-width: 100%;
      }

      /* Grid utilities */
      .prose-rtl .grid .relative {
        position: relative;
        cursor: pointer;
      }

      .prose-rtl .grid .absolute {
        position: absolute;
      }

      .prose-rtl .grid .inset-0 {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .prose-rtl .grid .bg-black\/60 {
        background-color: rgba(0, 0, 0, 0.6);
        pointer-events: auto;
        cursor: pointer;
      }

      .prose-rtl .grid .flex {
        display: flex;
      }

      .prose-rtl .grid .items-center {
        align-items: center;
      }

      .prose-rtl .grid .justify-center {
        justify-content: center;
      }

      .prose-rtl .grid .text-white {
        color: white;
      }

      .prose-rtl .grid .text-2xl {
        font-size: 1.5rem;
        line-height: 2rem;
      }

      .prose-rtl .grid .font-bold {
        font-weight: 700;
      }

      .prose-rtl .grid .w-full {
        width: 100%;
      }

      .prose-rtl .grid .h-full {
        height: 100%;
      }

      .prose-rtl .grid .object-cover {
        object-fit: cover;
      }

      .prose-rtl .grid .rounded-lg {
        border-radius: 0.5rem;
      }

      .prose-rtl .grid .cursor-zoom-in {
        cursor: zoom-in;
      }

      .prose-rtl .grid .border {
        border-width: 1px;
      }

      .prose-rtl .grid .border-gray-200 {
        border-color: rgb(229 231 235);
      }

      .dark .prose-rtl .grid .border-gray-700 {
        border-color: rgb(55 65 81);
      }

      /* ============================================
         CODE BLOCK STYLING
         ============================================ */
      .prose-rtl :not(pre) > code {
        direction: ltr;
        display: inline-block;
        font-family: "Fira Code", monospace;
        background: #e2e8f0;
        color: #be185d;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
      }

      .dark .prose-rtl :not(pre) > code {
        background: #334155;
        color: #f472b6;
      }

      .prose-rtl pre {
        position: relative;
        direction: ltr;
        text-align: left;
        background: #fafafa !important;
        border: 1px solid #e5e7eb !important;
        padding: 1.5rem;
        border-radius: 0.75rem;
        overflow-x: auto;
        margin-bottom: 1.5em;
        font-family: "Fira Code", monospace;
        font-size: 0.9em;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .dark .prose-rtl pre {
        background: #282c34 !important;
        border: 1px solid #3e4451 !important;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3),
          0 1px 2px 0 rgba(0, 0, 0, 0.2);
      }

      .prose-rtl pre:hover .copy-code-btn {
        opacity: 1;
      }

      .prose-rtl pre code {
        background: transparent !important;
        color: inherit !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        display: inline;
        font-size: 100% !important;
      }

      /* ============================================
         LINK STYLING
         ============================================ */
      .prose-rtl a {
        color: #10b981;
        text-decoration: underline;
        font-weight: 500;
      }

      .prose-rtl a.no-underline {
        text-decoration: none !important;
      }

      .prose-rtl strong {
        color: #0f172a;
        font-weight: 700;
      }

      .dark .prose-rtl strong {
        color: #f1f5f9;
      }

      /* ============================================
         CUSTOM SCROLLBAR
         ============================================ */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
      }

      /* ============================================
         THEMES - Tiny Stars in Colorful Space
         Very gentle drift - like floating in space
         Small stars with soft glow - peaceful & calming
         ============================================ */

      /* ---- Theme Base Setup ---- */
      .theme-modern,
      .theme-sepia,
      .theme-ocean,
      .theme-forest,
      .theme-midnight {
        position: relative;
        overflow: hidden;
      }

      /* ============================================
         PLAIN THEME - No Animation (for accessibility)
         ============================================ */
      .theme-plain {
        position: relative;
      }

      .theme-plain::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background-image: radial-gradient(
            circle,
            rgba(100, 116, 139, 0.15) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(148, 163, 184, 0.1) 1px, transparent 1px);
        background-size: 200px 200px, 300px 300px;
        /* No animation - static stars */
      }

      .dark .theme-plain::before {
        background-image: radial-gradient(
            circle,
            rgba(148, 163, 184, 0.3) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(203, 213, 225, 0.2) 1px, transparent 1px);
        background-size: 220px 220px, 320px 320px;
      }

      .theme-plain > * {
        position: relative;
        z-index: 1;
      }

      .theme-modern::before,
      .theme-sepia::before,
      .theme-ocean::before,
      .theme-forest::before,
      .theme-midnight::before {
        content: "";
        position: fixed;
        top: -100%;
        left: -100%;
        width: 400%;
        height: 400%;
        pointer-events: none;
        z-index: 0;
      }

      /* Ensure content appears above stars */
      .theme-modern > *,
      .theme-sepia > *,
      .theme-ocean > *,
      .theme-forest > *,
      .theme-midnight > * {
        position: relative;
        z-index: 1;
      }

      /* ============================================
         MODERN THEME - Emerald Stars
         ============================================ */
      .theme-modern::before {
        background-image: radial-gradient(
            circle,
            rgba(16, 185, 129, 0.7) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(52, 211, 153, 0.5) 1px, transparent 1px);
        background-size: 180px 180px, 260px 260px;
        animation: stars-drift 500s linear infinite;
      }

      .dark .theme-modern::before {
        background-image: radial-gradient(
            circle,
            rgba(52, 211, 153, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(74, 222, 128, 0.6) 1px, transparent 1px);
        background-size: 200px 200px, 280px 280px;
      }

      /* ============================================
         SEPIA THEME - Golden Stars
         ============================================ */
      .theme-sepia::before {
        background-image: radial-gradient(
            circle,
            rgba(180, 120, 60, 0.6) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(139, 90, 43, 0.4) 1px, transparent 1px);
        background-size: 190px 190px, 270px 270px;
        animation: stars-drift 550s linear infinite;
      }

      .dark .theme-sepia::before {
        background-image: radial-gradient(
            circle,
            rgba(251, 191, 36, 0.8) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(245, 158, 11, 0.55) 1px, transparent 1px);
        background-size: 210px 210px, 290px 290px;
      }

      /* ============================================
         OCEAN THEME - Cyan Stars Rising
         ============================================ */
      .theme-ocean::before {
        background-image: radial-gradient(
            circle,
            rgba(6, 182, 212, 0.65) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(34, 211, 238, 0.45) 1px, transparent 1px);
        background-size: 170px 170px, 250px 250px;
        animation: stars-rise 480s linear infinite;
      }

      .dark .theme-ocean::before {
        background-image: radial-gradient(
            circle,
            rgba(34, 211, 238, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(103, 232, 249, 0.6) 1px, transparent 1px);
        background-size: 190px 190px, 270px 270px;
      }

      /* ============================================
         FOREST THEME - Green Stars
         ============================================ */
      .theme-forest::before {
        background-image: radial-gradient(
            circle,
            rgba(74, 222, 128, 0.7) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(52, 211, 153, 0.5) 1px, transparent 1px);
        background-size: 200px 200px, 300px 300px;
        animation: stars-drift 580s linear infinite;
      }

      .dark .theme-forest::before {
        background-image: radial-gradient(
            circle,
            rgba(52, 211, 153, 0.5) 1px,
            transparent 1px
          ),
          radial-gradient(
            circle,
            rgba(110, 231, 183, 0.35) 1px,
            transparent 1px
          );
        background-size: 220px 220px, 320px 320px;
      }

      /* ============================================
         MIDNIGHT THEME - White Stars in Purple Space
         ============================================ */
      .theme-midnight::before {
        background-image: radial-gradient(
            circle,
            rgba(139, 92, 246, 0.65) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(168, 85, 247, 0.45) 1px, transparent 1px);
        background-size: 160px 160px, 240px 240px;
        animation: stars-drift 450s linear infinite;
      }

      .dark .theme-midnight::before {
        background-image: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(196, 181, 253, 0.6) 1px, transparent 1px);
        background-size: 180px 180px, 260px 260px;
      }

      /* ============================================
         ANIMATIONS - Seamless Infinite Drift
         Like floating peacefully in space forever
         ============================================ */

      /* Diagonal drift - NW to SE (seamless loop) */
      @keyframes stars-drift {
        from {
          transform: translate(0, 0);
        }
        to {
          transform: translate(25%, 25%);
        }
      }

      /* Rising drift - for ocean theme (seamless loop) */
      @keyframes stars-rise {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-25%);
        }
      }

      /* ============================================
         TOAST NOTIFICATION
         ============================================ */
      .toast-notification {
        position: fixed;
        top: 5rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        pointer-events: none;
      }

      .toast-notification.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .toast-notification.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .toast-notification.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
      }

      /* ============================================
         FULLSCREEN PREVIEW MODE
         ============================================ */
      .fullscreen-preview {
        position: fixed;
        inset: 0;
        z-index: 100;
        overflow-y: auto;
      }

      .fullscreen-preview-close {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 110;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        border-radius: 9999px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .dark .fullscreen-preview-close {
        background: rgba(30, 41, 59, 0.9);
        border-color: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .fullscreen-preview-close:hover {
        transform: scale(1.1);
      }

      /* Writer-specific styles */
      .ltr {
        direction: ltr;
        text-align: left;
      }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Tajawal", "sans-serif"],
              mono: ["Fira Code", "monospace"],
            },
            colors: { primary: "#10b981", dark: "#0f172a", surface: "#1e293b" },
          },
        },
      };
    </script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>
  <body
    class="bg-gray-100 dark:bg-dark text-slate-800 dark:text-slate-100 transition-colors duration-300 overflow-hidden"
  >
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- Firebase Configuration (Fixed) ---
      const firebaseConfig = {
        apiKey: "AIzaSyAquezWzOJ5w5CZPuQFC01RxdGM2i9oYss",
        authDomain: "tech-stories-archive.firebaseapp.com",
        projectId: "tech-stories-archive",
        storageBucket: "tech-stories-archive.firebasestorage.app",
        messagingSenderId: "345367195836",
        appId: "1:345367195836:web:14719979eaad7bb43220b9",
      };

      // Initialize Firebase
      let auth = null;
      let db = null;
      let firebaseInitialized = false;

      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseInitialized = true;
      } catch (error) {
        console.error("Firebase Init Error:", error);
      }

      // --- Icons Definitions (SVG Components) ---
      const IconBase = ({ children, size = 24, className = "" }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {children}
        </svg>
      );

      const GripVertical = (props) => (
        <IconBase {...props}>
          <circle cx="9" cy="12" r="1" />
          <circle cx="9" cy="5" r="1" />
          <circle cx="9" cy="19" r="1" />
          <circle cx="15" cy="12" r="1" />
          <circle cx="15" cy="5" r="1" />
          <circle cx="15" cy="19" r="1" />
        </IconBase>
      );
      const X = (props) => (
        <IconBase {...props}>
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </IconBase>
      );
      const ArrowUp = (props) => (
        <IconBase {...props}>
          <path d="m18 15-6-6-6 6" />
        </IconBase>
      );
      const ArrowDown = (props) => (
        <IconBase {...props}>
          <path d="m6 9 6 6 6-6" />
        </IconBase>
      );
      const ImageIcon = (props) => (
        <IconBase {...props}>
          <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
          <circle cx="9" cy="9" r="2" />
          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
        </IconBase>
      );
      const Type = (props) => (
        <IconBase {...props}>
          <polyline points="4 7 4 4 20 4 20 7" />
          <line x1="9" y1="20" x2="15" y2="20" />
          <line x1="12" y1="4" x2="12" y2="20" />
        </IconBase>
      );
      const Save = (props) => (
        <IconBase {...props}>
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
          <polyline points="17 21 17 13 7 13 7 21" />
          <polyline points="7 3 7 8 15 8" />
        </IconBase>
      );
      const Moon = (props) => (
        <IconBase {...props}>
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
        </IconBase>
      );
      const Sun = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="4" />
          <path d="M12 2v2" />
          <path d="M12 20v2" />
          <path d="m4.93 4.93 1.41 1.41" />
          <path d="m17.66 17.66 1.41 1.41" />
          <path d="M2 12h2" />
          <path d="M20 12h2" />
          <path d="m6.34 17.66-1.41-1.41" />
          <path d="m19.07 4.93-1.41 1.41" />
        </IconBase>
      );
      const FolderOpen = (props) => (
        <IconBase {...props}>
          <path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v2" />
        </IconBase>
      );
      const RefreshCw = (props) => (
        <IconBase {...props}>
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M8 16H3v5" />
        </IconBase>
      );
      const Trash2 = (props) => (
        <IconBase {...props}>
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </IconBase>
      );
      const LinkIcon = (props) => (
        <IconBase {...props}>
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
        </IconBase>
      );
      const Hash = (props) => (
        <IconBase {...props}>
          <line x1="4" y1="9" x2="20" y2="9" />
          <line x1="4" y1="15" x2="20" y2="15" />
          <line x1="10" y1="3" x2="8" y2="21" />
          <line x1="16" y1="3" x2="14" y2="21" />
        </IconBase>
      );
      const Palette = (props) => (
        <IconBase {...props}>
          <circle cx="13.5" cy="6.5" r=".5" />
          <circle cx="17.5" cy="10.5" r=".5" />
          <circle cx="8.5" cy="7.5" r=".5" />
          <circle cx="6.5" cy="12.5" r=".5" />
          <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
        </IconBase>
      );
      const Eye = (props) => (
        <IconBase {...props}>
          <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
          <circle cx="12" cy="12" r="3" />
        </IconBase>
      );
      const Cloud = (props) => (
        <IconBase {...props}>
          <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.9-2.4-5.2-5.3-5.2-2.6 0-4.8 1.9-5.2 4.4C1.2 16 2.3 18 4.5 18h13Z" />
        </IconBase>
      );
      const CloudDownload = (props) => (
        <IconBase {...props}>
          <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
          <path d="M12 12v9" />
          <path d="m8 17 4 4 4-4" />
        </IconBase>
      );
      const Loader = (props) => (
        <IconBase
          {...props}
          className={(props.className || "") + " animate-spin"}
        >
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </IconBase>
      );
      const Edit = (props) => (
        <IconBase {...props}>
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
        </IconBase>
      );
      const Monitor = (props) => (
        <IconBase {...props}>
          <rect width="20" height="14" x="2" y="3" rx="2" />
          <line x1="8" x2="16" y1="21" y2="21" />
          <line x1="12" x2="12" y1="17" y2="21" />
        </IconBase>
      );
      const CloudUpload = (props) => (
        <IconBase {...props}>
          <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
          <path d="M12 12v9" />
          <path d="m16 16-4-4-4 4" />
        </IconBase>
      );
      const Settings = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </IconBase>
      );
      const CheckCircle = (props) => (
        <IconBase {...props}>
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </IconBase>
      );
      const AlertCircle = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="10" />
          <line x1="12" x2="12" y1="8" y2="12" />
          <line x1="12" x2="12.01" y1="16" y2="16" />
        </IconBase>
      );
      const Key = (props) => (
        <IconBase {...props}>
          <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4" />
        </IconBase>
      );
      const User = (props) => (
        <IconBase {...props}>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </IconBase>
      );
      const Lock = (props) => (
        <IconBase {...props}>
          <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </IconBase>
      );
      const AlignLeft = (props) => (
        <IconBase {...props}>
          <line x1="17" x2="3" y1="12" y2="12" />
          <line x1="21" x2="3" y1="6" y2="6" />
          <line x1="21" x2="3" y1="18" y2="18" />
        </IconBase>
      );
      const AlignRight = (props) => (
        <IconBase {...props}>
          <line x1="21" x2="7" y1="12" y2="12" />
          <line x1="21" x2="3" y1="6" y2="6" />
          <line x1="21" x2="3" y1="18" y2="18" />
        </IconBase>
      );
      const LogOut = (props) => (
        <IconBase {...props}>
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" x2="9" y1="12" y2="12" />
        </IconBase>
      );
      const Menu = (props) => (
        <IconBase {...props}>
          <line x1="4" x2="20" y1="12" y2="12" />
          <line x1="4" x2="20" y1="6" y2="6" />
          <line x1="4" x2="20" y1="18" y2="18" />
        </IconBase>
      );

      // --- Utils ---
      const getContrastColor = (hexcolor) => {
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0, 2), 16);
        const g = parseInt(hexcolor.substr(2, 2), 16);
        const b = parseInt(hexcolor.substr(4, 2), 16);
        const yiq = (r * 299 + g * 587 + b * 114) / 1000;
        return yiq >= 128 ? "#000000" : "#ffffff";
      };

      // --- Settings Modal ---
      const SettingsModal = ({ isOpen, onClose, currentImgbbKey, user }) => {
        const [localImgbbKey, setLocalImgbbKey] = useState(currentImgbbKey);
        const savedEmail = localStorage.getItem("saved_email") || "";
        const savedPass = localStorage.getItem("saved_pass") ? "••••••••" : "";

        if (!isOpen) return null;

        const handleSave = () => {
          localStorage.setItem("imgbb_key", localImgbbKey);
          alert("تم حفظ مفتاح ImgBB API.");
          onClose();
          // تحديث imgbbApiKey بدون إعادة تحميل الصفحة
          window.dispatchEvent(new Event("imgbbKeyUpdated"));
        };

        return (
          <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
            <div className="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-6 border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold flex items-center gap-2">
                  <Settings className="text-primary" /> الإعدادات العامة
                </h3>
                <button onClick={onClose}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-6">
                {/* ImgBB Section */}
                <div>
                  <label className="block text-sm font-bold text-gray-500 mb-2 flex items-center gap-2">
                    <ImageIcon size={16} /> مفتاح ImgBB API
                  </label>
                  <input
                    type="text"
                    value={localImgbbKey}
                    onChange={(e) => setLocalImgbbKey(e.target.value)}
                    className="w-full p-3 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-gray-700 rounded-lg outline-none ltr"
                    placeholder="أدخل مفتاح ImgBB API (اختياري)"
                  />
                  <p className="text-xs text-gray-400 mt-2">
                    مفتاح ImgBB API اختياري. يمكنك الحصول عليه من{" "}
                    <a
                      href="https://api.imgbb.com/"
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-primary hover:underline"
                    >
                      imgbb.com
                    </a>
                  </p>
                </div>

                {user && (
                  <>
                    <div className="h-px bg-gray-200 dark:bg-gray-700 my-4"></div>

                    {/* Account Info Section - للقراءة فقط */}
                    <div>
                      <h4 className="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2">
                        <Key size={18} /> معلومات الحساب
                      </h4>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-xs font-bold text-gray-400 mb-1">
                            البريد الإلكتروني
                          </label>
                          <input
                            type="email"
                            value={user.email || savedEmail}
                            disabled
                            className="w-full p-3 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-gray-600 rounded-lg outline-none ltr cursor-not-allowed opacity-70"
                            readOnly
                          />
                          <p className="text-xs text-gray-400 mt-1">
                            لا يمكن تعديل البريد الإلكتروني. لتغيير الحساب، قم
                            بتسجيل الخروج.
                          </p>
                        </div>
                        {savedPass && (
                          <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1">
                              كلمة المرور
                            </label>
                            <input
                              type="text"
                              value={savedPass}
                              disabled
                              className="w-full p-3 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-gray-600 rounded-lg outline-none cursor-not-allowed opacity-70"
                              readOnly
                            />
                            <p className="text-xs text-gray-400 mt-1">
                              لا يمكن تعديل كلمة المرور. لتغيير الحساب، قم
                              بتسجيل الخروج.
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  </>
                )}

                <button
                  onClick={handleSave}
                  className="w-full bg-primary hover:bg-emerald-600 text-white py-3 rounded-xl font-bold transition-all shadow-lg"
                >
                  حفظ مفتاح ImgBB
                </button>
              </div>
            </div>
          </div>
        );
      };

      // --- Helper Components ---
      const ImageUploader = ({
        image,
        onChange,
        imgbbApiKey,
        placeholder = "اختر صورة",
        heightClass = "max-h-64",
      }) => {
        const fileInputRef = useRef(null);
        const [uploading, setUploading] = useState(false);

        // Handle both string (old format) and object (new format)
        const imageData =
          typeof image === "string" ? { url: image } : { ...image };

        const handleFileChange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          if (!imgbbApiKey) {
            alert(
              "مفتاح ImgBB API غير موجود. يرجى إضافته من الإعدادات (⚙️) في شريط الأدوات."
            );
            return;
          }
          if (file.size > 5 * 1024 * 1024) return alert("الصورة كبيرة جداً.");
          setUploading(true);
          try {
            const formData = new FormData();
            formData.append("image", file);
            const response = await fetch(
              `https://api.imgbb.com/1/upload?key=${imgbbApiKey}`,
              { method: "POST", body: formData }
            );
            const result = await response.json();
            if (result.success) {
              onChange(result.data.url);
            } else throw new Error(result.error?.message);
          } catch (error) {
            alert("فشل الرفع: " + error.message);
          } finally {
            setUploading(false);
          }
        };
        if (uploading)
          return (
            <div
              className={`flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 bg-gray-50 dark:bg-slate-800 ${heightClass}`}
            >
              <Loader className="text-primary w-8 h-8 mb-2" />
              <p className="text-sm text-gray-500">جاري الرفع...</p>
            </div>
          );
        if (imageData.url)
          return (
            <div className="relative group rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-black/20 w-full">
              <img
                src={imageData.url}
                className={`${heightClass} w-full object-cover`}
              />
              <button
                onClick={() => onChange("")}
                className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full"
              >
                <X size={16} />
              </button>
            </div>
          );
        return (
          <div
            className="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer"
            onClick={() => fileInputRef.current.click()}
          >
            <CloudUpload className="text-gray-400 mb-2" size={32} />
            <p className="text-sm text-gray-500">{placeholder}</p>
            <input
              type="file"
              accept="image/*"
              className="hidden"
              ref={fileInputRef}
              onChange={handleFileChange}
            />
          </div>
        );
      };

      const ButtonGroupBlock = ({ content, onChange }) => {
        const data = content || { buttons: [], layout: "block" };
        const addButton = () => {
          onChange({
            ...data,
            buttons: [
              ...(data.buttons || []),
              { text: "", url: "", color: "#10b981", textColorMode: "auto" },
            ],
          });
        };
        const updateButton = (index, updates) => {
          const newButtons = [...(data.buttons || [])];
          newButtons[index] = { ...newButtons[index], ...updates };
          onChange({ ...data, buttons: newButtons });
        };
        const removeButton = (index) => {
          const newButtons = [...(data.buttons || [])];
          newButtons.splice(index, 1);
          onChange({ ...data, buttons: newButtons });
        };

        const moveButton = (fromIndex, toIndex) => {
          if (fromIndex === toIndex) return;
          const newButtons = [...(data.buttons || [])];
          const [movedItem] = newButtons.splice(fromIndex, 1);
          newButtons.splice(toIndex, 0, movedItem);
          onChange({ ...data, buttons: newButtons });
        };

        return (
          <div className="flex flex-col gap-3 p-4 bg-gray-50 dark:bg-slate-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-bold text-gray-700 dark:text-gray-300">
                مجموعة أزرار
              </span>
              <div className="flex gap-2">
                <button
                  onClick={() => onChange({ ...data, layout: "block" })}
                  className={`px-3 py-1 rounded text-xs ${
                    data.layout === "block"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600 dark:bg-slate-700 dark:text-gray-300"
                  }`}
                >
                  عمودي
                </button>
                <button
                  onClick={() => onChange({ ...data, layout: "inline" })}
                  className={`px-3 py-1 rounded text-xs ${
                    data.layout === "inline"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600 dark:bg-slate-700 dark:text-gray-300"
                  }`}
                >
                  أفقي
                </button>
              </div>
            </div>
            {(data.buttons || []).map((btn, index) => {
              const textColor =
                btn.textColorMode === "white"
                  ? "#ffffff"
                  : btn.textColorMode === "black"
                  ? "#000000"
                  : getContrastColor(btn.color || "#10b981");
              const buttonsCount = (data.buttons || []).length;
              return (
                <div key={index} className="relative">
                  <div className="flex flex-col gap-2 p-3 bg-white dark:bg-slate-900 rounded border border-gray-200 dark:border-gray-600">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      <input
                        type="text"
                        value={btn.text || ""}
                        onChange={(e) =>
                          updateButton(index, { text: e.target.value })
                        }
                        placeholder="نص الزر"
                        className="w-full p-2 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-900 focus:border-primary outline-none"
                      />
                      <input
                        type="text"
                        value={btn.url || ""}
                        onChange={(e) =>
                          updateButton(index, { url: e.target.value })
                        }
                        placeholder="الرابط"
                        className="w-full p-2 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-900 focus:border-primary outline-none ltr text-left"
                      />
                    </div>
                    <div className="flex items-center gap-2 justify-between">
                      <div className="flex items-center gap-2">
                        <Palette size={14} className="text-gray-400" />
                        <input
                          type="color"
                          value={btn.color || "#10b981"}
                          onChange={(e) =>
                            updateButton(index, { color: e.target.value })
                          }
                          className="w-6 h-6 rounded cursor-pointer border-0 p-0"
                        />
                      </div>
                      <div className="flex gap-1 text-xs">
                        <button
                          onClick={() =>
                            updateButton(index, { textColorMode: "auto" })
                          }
                          className={`px-2 py-1 rounded ${
                            btn.textColorMode === "auto"
                              ? "bg-primary text-white"
                              : "bg-gray-200 text-gray-600"
                          }`}
                        >
                          تلقائي
                        </button>
                        <button
                          onClick={() =>
                            updateButton(index, { textColorMode: "white" })
                          }
                          className={`px-2 py-1 rounded ${
                            btn.textColorMode === "white"
                              ? "bg-primary text-white"
                              : "bg-gray-200 text-gray-600"
                          }`}
                        >
                          أبيض
                        </button>
                        <button
                          onClick={() =>
                            updateButton(index, { textColorMode: "black" })
                          }
                          className={`px-2 py-1 rounded ${
                            btn.textColorMode === "black"
                              ? "bg-primary text-white"
                              : "bg-gray-200 text-gray-600"
                          }`}
                        >
                          أسود
                        </button>
                      </div>
                      <div className="flex gap-1 items-center">
                        <div className="flex flex-col gap-0.5">
                          <button
                            onClick={() => moveButton(index, index - 1)}
                            disabled={index === 0}
                            className={`p-0.5 rounded transition-colors ${
                              index === 0
                                ? "text-gray-300 cursor-not-allowed"
                                : "text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-slate-700"
                            }`}
                            title="تحريك لأعلى"
                          >
                            <ArrowUp size={14} />
                          </button>
                          <button
                            onClick={() => moveButton(index, index + 1)}
                            disabled={index === buttonsCount - 1}
                            className={`p-0.5 rounded transition-colors ${
                              index === buttonsCount - 1
                                ? "text-gray-300 cursor-not-allowed"
                                : "text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-slate-700"
                            }`}
                            title="تحريك لأسفل"
                          >
                            <ArrowDown size={14} />
                          </button>
                        </div>
                        <button
                          onClick={() => removeButton(index)}
                          className="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                        >
                          حذف
                        </button>
                      </div>
                    </div>
                    <span
                      className="px-4 py-2 rounded-full text-xs font-bold shadow-sm w-fit"
                      style={{
                        backgroundColor: btn.color || "#10b981",
                        color: textColor,
                      }}
                    >
                      {btn.text || "معاينة"}
                    </span>
                  </div>
                </div>
              );
            })}
            <button
              onClick={addButton}
              className="mt-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-emerald-600 transition-colors"
            >
              + إضافة زر
            </button>
          </div>
        );
      };

      const ImageGroupBlock = ({ content, onChange, imgbbApiKey }) => {
        const data = content || { images: [], layout: "block" };
        const fileInputRefs = useRef({});
        const [uploading, setUploading] = useState({});

        const handleFileChange = async (index, e) => {
          const file = e.target.files[0];
          if (!file) return;
          if (!imgbbApiKey) {
            alert(
              "مفتاح ImgBB API غير موجود. يرجى إضافته من الإعدادات (⚙️) في شريط الأدوات."
            );
            return;
          }
          if (file.size > 5 * 1024 * 1024) return alert("الصورة كبيرة جداً.");
          setUploading({ ...uploading, [index]: true });
          try {
            const formData = new FormData();
            formData.append("image", file);
            const response = await fetch(
              `https://api.imgbb.com/1/upload?key=${imgbbApiKey}`,
              { method: "POST", body: formData }
            );
            const result = await response.json();
            if (result.success) {
              const newImages = [...(data.images || [])];
              newImages[index] = result.data.url;
              onChange({ ...data, images: newImages });
            } else throw new Error(result.error?.message);
          } catch (error) {
            alert("فشل الرفع: " + error.message);
          } finally {
            setUploading({ ...uploading, [index]: false });
          }
        };

        const addImage = () => {
          onChange({
            ...data,
            images: [...(data.images || []), ""],
          });
        };

        const removeImage = (index) => {
          const newImages = [...(data.images || [])];
          newImages.splice(index, 1);
          onChange({ ...data, images: newImages });
        };

        const moveImage = (fromIndex, toIndex) => {
          if (
            fromIndex === toIndex ||
            toIndex < 0 ||
            toIndex >= (data.images || []).length
          )
            return;
          const newImages = [...(data.images || [])];
          const [movedItem] = newImages.splice(fromIndex, 1);
          newImages.splice(toIndex, 0, movedItem);
          onChange({ ...data, images: newImages });
        };

        return (
          <div className="flex flex-col gap-3 p-4 bg-gray-50 dark:bg-slate-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-bold text-gray-700 dark:text-gray-300">
                مجموعة صور
              </span>
              <div className="flex gap-2">
                <button
                  onClick={() => onChange({ ...data, layout: "block" })}
                  className={`px-3 py-1 rounded text-xs ${
                    data.layout === "block"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600 dark:bg-slate-700 dark:text-gray-300"
                  }`}
                >
                  عمودي
                </button>
                <button
                  onClick={() => onChange({ ...data, layout: "inline" })}
                  className={`px-3 py-1 rounded text-xs ${
                    data.layout === "inline"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600 dark:bg-slate-700 dark:text-gray-300"
                  }`}
                >
                  أفقي
                </button>
              </div>
            </div>
            <div
              className={`gap-3 ${
                data.layout === "inline" ? "grid grid-cols-3" : "flex flex-col"
              }`}
            >
              {(data.images || []).map((imgUrl, index) => {
                const imagesCount = (data.images || []).length;
                return (
                  <div key={index} className="relative">
                    <div
                      className={`relative border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-50 dark:bg-slate-900 ${
                        data.layout === "inline" ? "" : "w-full"
                      }`}
                    >
                      {uploading[index] ? (
                        <div className="flex flex-col items-center justify-center p-6">
                          <Loader className="text-primary w-6 h-6 mb-2" />
                          <p className="text-xs text-gray-500">جاري الرفع...</p>
                        </div>
                      ) : imgUrl ? (
                        <>
                          <img
                            src={imgUrl}
                            className={`w-full object-contain rounded-lg ${
                              data.layout === "inline" ? "max-h-32" : "max-h-48"
                            }`}
                          />
                          <div className="absolute top-2 right-2 flex gap-1">
                            <button
                              onClick={() => moveImage(index, index - 1)}
                              disabled={index === 0}
                              className={`p-1 rounded-full transition-colors ${
                                index === 0
                                  ? "bg-gray-400/50 text-gray-300 cursor-not-allowed"
                                  : "bg-gray-800/70 text-white hover:bg-blue-500"
                              }`}
                              title="تحريك لليسار/لأعلى"
                            >
                              <ArrowUp size={14} />
                            </button>
                            <button
                              onClick={() => moveImage(index, index + 1)}
                              disabled={index === imagesCount - 1}
                              className={`p-1 rounded-full transition-colors ${
                                index === imagesCount - 1
                                  ? "bg-gray-400/50 text-gray-300 cursor-not-allowed"
                                  : "bg-gray-800/70 text-white hover:bg-blue-500"
                              }`}
                              title="تحريك لليمين/لأسفل"
                            >
                              <ArrowDown size={14} />
                            </button>
                            <button
                              onClick={() => removeImage(index)}
                              className="bg-red-500 text-white p-1 rounded-full hover:bg-red-600"
                              title="حذف الصورة"
                            >
                              <X size={14} />
                            </button>
                          </div>
                        </>
                      ) : (
                        <div
                          className="flex flex-col items-center justify-center p-6 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors"
                          onClick={() => fileInputRefs.current[index]?.click()}
                        >
                          <CloudUpload
                            className="text-gray-400 mb-2"
                            size={24}
                          />
                          <p className="text-xs text-gray-500">اختر صورة</p>
                          <input
                            type="file"
                            accept="image/*"
                            className="hidden"
                            ref={(el) => (fileInputRefs.current[index] = el)}
                            onChange={(e) => handleFileChange(index, e)}
                          />
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            <button
              onClick={addImage}
              className="mt-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-emerald-600 transition-colors"
            >
              + إضافة صورة
            </button>
          </div>
        );
      };

      const ButtonBlock = ({ content, onChange }) => {
        const data =
          typeof content === "string"
            ? {
                text: "",
                url: "",
                color: "#10b981",
                textColorMode: "auto",
              }
            : {
                color: "#10b981",
                textColorMode: "auto",
                ...content,
              };
        const textColor =
          data.textColorMode === "white"
            ? "#ffffff"
            : data.textColorMode === "black"
            ? "#000000"
            : getContrastColor(data.color);
        return (
          <div className="flex flex-col gap-3 p-4 bg-gray-50 dark:bg-slate-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input
                type="text"
                value={data.text}
                onChange={(e) => onChange({ ...data, text: e.target.value })}
                placeholder="نص الزر"
                className="w-full p-2 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-900 focus:border-primary outline-none"
              />
              <input
                type="text"
                value={data.url}
                onChange={(e) => onChange({ ...data, url: e.target.value })}
                placeholder="الرابط"
                className="w-full p-2 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-900 focus:border-primary outline-none ltr text-left"
              />
            </div>
            <div className="flex items-center gap-3 mt-2 bg-white dark:bg-slate-900 p-2 rounded border border-gray-200 dark:border-gray-600 justify-between">
              <div className="flex items-center gap-2">
                <Palette size={16} className="text-gray-400" />
                <input
                  type="color"
                  value={data.color}
                  onChange={(e) => onChange({ ...data, color: e.target.value })}
                  className="w-8 h-8 rounded cursor-pointer border-0 p-0"
                />
              </div>
              <div className="flex gap-2 text-xs">
                <button
                  onClick={() => onChange({ ...data, textColorMode: "auto" })}
                  className={`px-2 py-1 rounded ${
                    data.textColorMode === "auto"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600"
                  }`}
                >
                  تلقائي
                </button>
                <button
                  onClick={() => onChange({ ...data, textColorMode: "white" })}
                  className={`px-2 py-1 rounded ${
                    data.textColorMode === "white"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600"
                  }`}
                >
                  أبيض
                </button>
                <button
                  onClick={() => onChange({ ...data, textColorMode: "black" })}
                  className={`px-2 py-1 rounded ${
                    data.textColorMode === "black"
                      ? "bg-primary text-white"
                      : "bg-gray-200 text-gray-600"
                  }`}
                >
                  أسود
                </button>
              </div>
              <span
                className="px-6 py-2 rounded-full text-xs font-bold shadow-sm"
                style={{ backgroundColor: data.color, color: textColor }}
              >
                {data.text || "معاينة"}
              </span>
            </div>
          </div>
        );
      };

      const TextBlock = ({ content, dir, onChange, onDirChange }) => {
        return (
          <div className="relative group">
            <textarea
              value={content}
              onChange={(e) => onChange(e.target.value)}
              placeholder="اكتب هنا... (Markdown)"
              className="w-full min-h-[120px] p-3 pt-8 bg-transparent outline-none resize-y font-mono text-sm leading-relaxed focus:bg-gray-50/50 dark:focus:bg-slate-800/50 rounded-lg transition-colors"
              style={{
                direction: dir || "rtl",
                textAlign: dir === "ltr" ? "left" : "right",
              }}
            />
          </div>
        );
      };

      // --- Post List Modal ---
      // --- Post List Modal (Updated with Soft Delete) ---
      const PostListModal = ({ isOpen, onClose, onSelect, onShowToast }) => {
        const [postsList, setPostsList] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showTrash, setShowTrash] = useState(false); // حالة للتبديل بين المنشور والمحذوف

        // دالة لجلب المقالات بناءً على الحالة (محذوفة أم لا)
        const fetchPosts = () => {
          if (!db) return;
          setLoading(true);

          let query = db.collection("posts").orderBy("updatedAt", "desc");

          // ملاحظة: لجعل هذا الفلتر يعمل بكفاءة مع orderBy في Firebase
          // قد يطلب منك المتصفح إنشاء Index من خلال الرابط الذي سيظهر في الـ Console
          // ولكن للتسهيل سنقوم بجلب أخر 50 مقال ونفلترهم محلياً (Client-side filtering)
          // هذا يمنع مشاكل الـ Index للمشاريع الصغيرة

          query
            .limit(50)
            .get()
            .then((snap) => {
              const allPosts = snap.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));

              // الفلترة هنا
              const filteredPosts = showTrash
                ? allPosts.filter((p) => p.deleted === true) // المحذوفات فقط
                : allPosts.filter((p) => !p.deleted); // غير المحذوف (المنشور)

              setPostsList(filteredPosts);
              setLoading(false);
            })
            .catch((err) => {
              console.error(err);
              setLoading(false);
            });
        };

        useEffect(() => {
          if (isOpen) {
            fetchPosts();
          }
        }, [isOpen, showTrash]); // إعادة الجلب عند تغيير التبويب

        // 1. الحذف المؤقت (Soft Delete)
        const handleSoftDelete = async (postId, e) => {
          e.stopPropagation();
          if (!confirm("هل تريد نقل هذا المقال إلى سلة المحذوفات؟")) return;
          try {
            await db.collection("posts").doc(postId).update({ deleted: true });
            setPostsList((prev) => prev.filter((p) => p.id !== postId)); // إزالة من القائمة الحالية
            if (onShowToast)
              onShowToast("success", "تم نقل المقال إلى سلة المحذوفات");
          } catch (err) {
            if (onShowToast) onShowToast("error", "حدث خطأ: " + err.message);
          }
        };

        // 2. الاستعادة (Restore)
        const handleRestore = async (postId, e) => {
          e.stopPropagation();
          try {
            await db.collection("posts").doc(postId).update({ deleted: false });
            setPostsList((prev) => prev.filter((p) => p.id !== postId)); // إزالة من سلة المحذوفات
            if (onShowToast) onShowToast("success", "تم استعادة المقال بنجاح");
          } catch (err) {
            if (onShowToast) onShowToast("error", "حدث خطأ: " + err.message);
          }
        };

        // 3. الحذف النهائي (Hard Delete)
        const handleHardDelete = async (postId, e) => {
          e.stopPropagation();
          if (
            !confirm(
              "تحذير: سيتم حذف المقال نهائياً ولا يمكن استرجاعه. هل أنت متأكد؟"
            )
          )
            return;
          try {
            await db.collection("posts").doc(postId).delete();
            setPostsList((prev) => prev.filter((p) => p.id !== postId));
            if (onShowToast) onShowToast("success", "تم حذف المقال نهائياً");
          } catch (err) {
            if (onShowToast)
              onShowToast("error", "خطأ في الحذف: " + err.message);
          }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div className="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
              {/* Header with Tabs */}
              <div className="p-4 border-b border-gray-100 dark:border-gray-700">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold flex items-center gap-2 text-lg">
                    {showTrash ? (
                      <span className="text-red-500 flex items-center gap-2">
                        <Trash2 size={20} /> سلة المحذوفات
                      </span>
                    ) : (
                      <span className="text-primary flex items-center gap-2">
                        <CloudDownload size={20} /> المقالات المنشورة
                      </span>
                    )}
                  </h3>
                  <button onClick={onClose}>
                    <X size={20} />
                  </button>
                </div>

                {/* Tabs Switcher */}
                <div className="flex bg-gray-100 dark:bg-slate-900 p-1 rounded-lg">
                  <button
                    onClick={() => setShowTrash(false)}
                    className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${
                      !showTrash
                        ? "bg-white dark:bg-slate-700 shadow text-primary"
                        : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
                    }`}
                  >
                    المنشورة
                  </button>
                  <button
                    onClick={() => setShowTrash(true)}
                    className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${
                      showTrash
                        ? "bg-white dark:bg-slate-700 shadow text-red-500"
                        : "text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
                    }`}
                  >
                    سلة المحذوفات
                  </button>
                </div>
              </div>

              <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                {loading ? (
                  <div className="flex justify-center p-4">
                    <Loader
                      className={`animate-spin ${
                        showTrash ? "text-red-500" : "text-primary"
                      }`}
                      size={24}
                    />
                  </div>
                ) : postsList.length === 0 ? (
                  <div className="text-center text-gray-500 py-10 flex flex-col items-center gap-2">
                    {showTrash ? (
                      <Trash2 size={40} className="opacity-20" />
                    ) : (
                      <FolderOpen size={40} className="opacity-20" />
                    )}
                    <p>
                      {showTrash
                        ? "سلة المحذوفات فارغة"
                        : "لا توجد مقالات منشورة"}
                    </p>
                  </div>
                ) : (
                  postsList.map((post) => (
                    <div
                      key={post.id}
                      onClick={() => !showTrash && onSelect(post)} // لا يمكن فتح المقال وهو في السلة
                      className={`p-3 mb-2 rounded-xl border transition-colors flex justify-between items-center group relative overflow-hidden ${
                        showTrash
                          ? "border-red-100 dark:border-red-900/30 bg-red-50/50 dark:bg-red-900/10 cursor-default"
                          : "border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-slate-700 cursor-pointer"
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        {post.coverImage && (
                          <img
                            src={post.coverImage}
                            className={`w-12 h-12 rounded-lg object-cover ${
                              showTrash ? "grayscale opacity-50" : ""
                            }`}
                          />
                        )}
                        <div>
                          <h4
                            className={`font-bold text-sm ${
                              showTrash ? "text-gray-500 line-through" : ""
                            }`}
                          >
                            {post.title || "بدون عنوان"}
                          </h4>
                          <div className="flex gap-1 mt-1 text-[10px]">
                            {post.topics?.slice(0, 3).map((t, i) => (
                              <span
                                key={t}
                                className={`px-1.5 py-0.5 rounded ${
                                  showTrash
                                    ? "bg-gray-200 dark:bg-slate-700 text-gray-500"
                                    : "bg-primary/10 text-primary"
                                }`}
                              >
                                #{t}
                              </span>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        {showTrash ? (
                          <>
                            {/* أزرار سلة المحذوفات */}
                            <button
                              onClick={(e) => handleRestore(post.id, e)}
                              className="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors"
                              title="استعادة"
                            >
                              <RefreshCw size={16} />
                            </button>
                            <button
                              onClick={(e) => handleHardDelete(post.id, e)}
                              className="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
                              title="حذف نهائي"
                            >
                              <X size={16} />
                            </button>
                          </>
                        ) : (
                          /* زر الحذف المؤقت للقائمة العادية */
                          <button
                            onClick={(e) => handleSoftDelete(post.id, e)}
                            className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg opacity-0 group-hover:opacity-100 transition-all"
                            title="نقل للمحذوفات"
                          >
                            <Trash2 size={16} />
                          </button>
                        )}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        );
      };

      const AuthScreen = ({ onLogin, onOpenSettings }) => {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);
        const handleLogin = async (e) => {
          e.preventDefault();
          setLoading(true);
          setError("");
          try {
            await auth.signInWithEmailAndPassword(email, password);
            onLogin();
          } catch (err) {
            setError(
              "فشل تسجيل الدخول: " + (err.message || "يرجى التحقق من البيانات")
            );
            setLoading(false);
          }
        };

        useEffect(() => {
          const savedEmail = localStorage.getItem("saved_email");
          const savedPass = localStorage.getItem("saved_pass");
          if (savedEmail) setEmail(savedEmail);
          if (savedPass) setPassword(savedPass);
        }, []);

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-dark p-4 relative">
            <button
              onClick={onOpenSettings}
              className="absolute top-6 left-6 p-2 bg-white dark:bg-surface rounded-full shadow text-gray-500 hover:text-primary transition-colors"
              title="إعدادات الاتصال"
            >
              <Settings size={24} />
            </button>
            <div className="bg-white dark:bg-surface p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-primary mb-2">
                  Writer Pro
                </h1>
                <p className="text-gray-500">تسجيل دخول المشرف</p>
              </div>
              <form onSubmit={handleLogin} className="flex flex-col gap-4">
                <div className="relative">
                  <User className="absolute top-3 left-3 text-gray-400 w-5 h-5" />
                  <input
                    type="email"
                    placeholder="البريد الإلكتروني"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="p-3 pl-10 rounded-lg border dark:bg-slate-900 dark:border-gray-600 focus:border-primary outline-none w-full"
                    required
                  />
                </div>
                <div className="relative">
                  <Lock className="absolute top-3 left-3 text-gray-400 w-5 h-5" />
                  <input
                    type="password"
                    placeholder="كلمة المرور"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="p-3 pl-10 rounded-lg border dark:bg-slate-900 dark:border-gray-600 focus:border-primary outline-none w-full"
                    required
                  />
                </div>
                {error && (
                  <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-100">
                    {error}
                  </p>
                )}
                <button
                  type="submit"
                  disabled={loading}
                  className="bg-primary text-white p-3 rounded-lg font-bold hover:bg-emerald-600 transition-colors flex justify-center disabled:opacity-50"
                >
                  {loading ? <Loader className="w-6 h-6 text-white" /> : "دخول"}
                </button>
              </form>
            </div>
          </div>
        );
      };

      // --- Themes Configuration ---
      const themes = {
        plain: {
          name: "بسيط",
          bgLight: "bg-gradient-to-br from-gray-50 to-gray-100",
          bgDark:
            "dark:bg-gradient-to-br dark:from-slate-900 dark:to-slate-800",
          accent: "text-primary",
          className: "theme-plain",
        },
        sepia: {
          name: "ورقي (Sepia)",
          bgLight: "bg-[#f4ecd8] text-slate-800",
          bgDark: "dark:bg-[#463a2a] dark:text-[#f4ecd8]",
          accent: "text-amber-600",
          className: "theme-sepia",
        },
        ocean: {
          name: "محيط (Ocean)",
          bgLight:
            "bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a1929] dark:via-[#0d1b2a] dark:to-[#0f172a] dark:text-cyan-100",
          accent: "text-cyan-500",
          className: "theme-ocean",
        },
        forest: {
          name: "غابة (Forest)",
          bgLight:
            "bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#022c22] dark:via-[#064e3b] dark:to-[#065f46] dark:text-emerald-100",
          accent: "text-emerald-500",
          className: "theme-forest",
        },
        midnight: {
          name: "فضاء (Midnight)",
          bgLight:
            "bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a0e27] dark:via-[#1a1b3a] dark:to-[#2d1b3d] dark:text-indigo-100",
          accent: "text-indigo-400",
          className: "theme-midnight",
        },
      };

      function App() {
        const [user, setUser] = useState(null);
        const [authChecking, setAuthChecking] = useState(true);
        const [viewMode, setViewMode] = useState("edit");

        const [postId, setPostId] = useState(null);
        const [title, setTitle] = useState("");
        const [coverImage, setCoverImage] = useState("");
        const [topics, setTopics] = useState([]);
        const [tagInput, setTagInput] = useState("");
        const [blocks, setBlocks] = useState([
          { id: "1", type: "text", content: "", dir: "rtl" },
        ]);

        const [isSaving, setIsSaving] = useState(false);
        const [showLoadModal, setShowLoadModal] = useState(false);
        const [showSettings, setShowSettings] = useState(false);
        const [showMobileMenu, setShowMobileMenu] = useState(false);
        const [notification, setNotification] = useState(null);
        const [showFullPreview, setShowFullPreview] = useState(false);

        // Load saved preferences from localStorage
        const [darkMode, setDarkMode] = useState(() => {
          const saved = localStorage.getItem("blog-darkMode");
          return saved !== null ? saved === "true" : true;
        });
        const [currentTheme, setCurrentTheme] = useState(() => {
          return localStorage.getItem("blog-theme") || "midnight";
        });

        const [showThemeMenu, setShowThemeMenu] = useState(false);
        const [draggedItemIndex, setDraggedItemIndex] = useState(null);
        const [dropGapIndex, setDropGapIndex] = useState(null); // index of the gap where drop will happen (0 = before first, 1 = after first, etc.)
        const importFileRef = useRef(null);
        const [imgbbApiKey, setImgbbApiKey] = useState(
          () => localStorage.getItem("imgbb_key") || ""
        );

        // Ref for code highlighting
        const previewRef = useRef(null);

        // Save preferences to localStorage when they change
        useEffect(() => {
          localStorage.setItem("blog-darkMode", darkMode);
        }, [darkMode]);

        useEffect(() => {
          localStorage.setItem("blog-theme", currentTheme);
        }, [currentTheme]);

        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((u) => {
            setUser(u);
            setAuthChecking(false);
            if (u) {
              const params = new URLSearchParams(window.location.search);
              const idFromUrl = params.get("id");
              if (idFromUrl) loadPostById(idFromUrl);
              // قراءة imgbbApiKey من localStorage عند تسجيل الدخول
              const savedKey = localStorage.getItem("imgbb_key") || "";
              setImgbbApiKey(savedKey);
            }
          });
          return () => unsubscribe();
        }, []);

        // تحديث imgbbApiKey عند الحفظ من الإعدادات
        useEffect(() => {
          const handleKeyUpdate = () => {
            const savedKey = localStorage.getItem("imgbb_key") || "";
            setImgbbApiKey(savedKey);
          };
          window.addEventListener("imgbbKeyUpdated", handleKeyUpdate);
          return () =>
            window.removeEventListener("imgbbKeyUpdated", handleKeyUpdate);
        }, []);

        useEffect(() => {
          const postToEdit = localStorage.getItem("postToEdit");
          if (postToEdit && user) {
            try {
              loadPostData(JSON.parse(postToEdit));
              localStorage.removeItem("postToEdit");
            } catch (e) {
              console.error(e);
            }
          }
        }, [user]);

        useEffect(() => {
          const lightTheme = document.getElementById("hljs-light-theme");
          const darkTheme = document.getElementById("hljs-dark-theme");

          if (darkMode) {
            document.documentElement.classList.add("dark");
            // Switch to dark theme for code highlighting
            if (lightTheme) lightTheme.disabled = true;
            if (darkTheme) darkTheme.disabled = false;
          } else {
            document.documentElement.classList.remove("dark");
            // Switch to light theme for code highlighting
            if (lightTheme) lightTheme.disabled = false;
            if (darkTheme) darkTheme.disabled = true;
          }
        }, [darkMode]);

        // Theme is now saved in localStorage, no auto-change needed

        // Keyboard handler for fullscreen preview (ESC to close)
        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.key === "Escape" && showFullPreview) {
              setShowFullPreview(false);
            }
          };
          window.addEventListener("keydown", handleKeyDown);
          return () => window.removeEventListener("keydown", handleKeyDown);
        }, [showFullPreview]);

        // Get theme classes
        const getThemeClass = () => {
          const theme = themes[currentTheme];
          return `${theme.bgLight} ${theme.bgDark} ${theme.className || ""}`;
        };

        // Re-highlight code when dark mode changes
        useEffect(() => {
          if (previewRef.current) {
            setTimeout(() => {
              previewRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 150);
          }
        }, [darkMode]);

        // Syntax Highlight Effect for Preview
        useEffect(() => {
          if (previewRef.current) {
            setTimeout(() => {
              previewRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 100);

            // Inject Copy Buttons
            previewRef.current.querySelectorAll("pre").forEach((preBlock) => {
              if (preBlock.querySelector(".copy-code-btn")) return;

              const button = document.createElement("button");
              button.className =
                "copy-code-btn absolute top-2 right-2 bg-gray-800/50 dark:bg-slate-700/50 hover:bg-gray-700 dark:hover:bg-slate-700 text-gray-200 dark:text-slate-300 p-1.5 rounded-md text-xs transition-all opacity-0 group-hover:opacity-100 z-10 flex items-center justify-center backdrop-blur-sm border border-gray-600/30 dark:border-white/10";
              button.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
              button.title = "نسخ الكود";

              button.addEventListener("click", () => {
                const code = preBlock.querySelector("code").innerText;
                navigator.clipboard.writeText(code).then(() => {
                  button.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
                  setTimeout(() => {
                    button.innerHTML =
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
                  }, 2000);
                });
              });
              preBlock.appendChild(button);
            });
          }
        }, [viewMode, blocks, title, coverImage]);

        const handleAuthSuccess = () => {
          // قراءة imgbbApiKey من localStorage بعد تسجيل الدخول
          const savedKey = localStorage.getItem("imgbb_key") || "";
          setImgbbApiKey(savedKey);
        };

        const handleLogout = async () => {
          if (
            !confirm(
              "هل أنت متأكد من تسجيل الخروج؟ سيتم مسح جميع البيانات المحفوظة."
            )
          ) {
            return;
          }

          try {
            // تسجيل الخروج من Firebase
            await auth.signOut();

            // مسح جميع البيانات من localStorage (باستثناء imgbb_key)
            const imgbbKey = localStorage.getItem("imgbb_key");
            localStorage.clear();
            if (imgbbKey) {
              localStorage.setItem("imgbb_key", imgbbKey);
            }

            // مسح sessionStorage
            sessionStorage.clear();

            // إعادة تحميل الصفحة
            window.location.reload();
          } catch (error) {
            console.error("Error signing out:", error);
            alert("حدث خطأ أثناء تسجيل الخروج");
          }
        };
        const loadPostById = async (id) => {
          try {
            const doc = await db.collection("posts").doc(id).get();
            if (doc.exists) loadPostData({ id: doc.id, ...doc.data() });
          } catch (e) {
            console.error(e);
          }
        };

        const loadPostData = (post) => {
          setPostId(post.id);
          setTitle(post.title || "");
          setCoverImage(post.coverImage || "");
          setTopics(post.topics || []);
          const loadedBlocks = (
            post.blocks ||
            (post.content
              ? [
                  {
                    id: crypto.randomUUID(),
                    type: "text",
                    content: post.content,
                  },
                ]
              : [])
          )
            .map((b) => {
              // Convert old format to new format for compatibility
              if (b.type === "text" && !b.dir) {
                return { ...b, dir: "rtl" };
              }
              // Convert old image to image-group
              if (b.type === "image") {
                const imageUrl =
                  typeof b.content === "string"
                    ? b.content
                    : b.content?.url || "";
                if (imageUrl) {
                  return {
                    ...b,
                    type: "image-group",
                    content: { images: [imageUrl], layout: "block" },
                  };
                }
                return null; // Skip empty images
              }
              // Convert old button to button-group
              if (b.type === "button" && b.content) {
                const { layout, ...buttonContent } = b.content;
                if (buttonContent.text) {
                  return {
                    ...b,
                    type: "button-group",
                    content: { buttons: [buttonContent], layout: "block" },
                  };
                }
                return null; // Skip empty buttons
              }
              return b;
            })
            .filter(Boolean); // Remove null entries
          setBlocks(loadedBlocks);
          setShowLoadModal(false);
        };

        const handleTagInputKeyDown = (e) => {
          if (e.key === "Enter" && tagInput.trim()) {
            e.preventDefault();
            if (!topics.includes(tagInput.trim()))
              setTopics([...topics, tagInput.trim()]);
            setTagInput("");
          }
        };
        const removeTag = (t) => setTopics(topics.filter((tag) => tag !== t));

        const addBlock = (type) => {
          let content = "";
          if (type === "button-group") {
            content = {
              buttons: [],
              layout: "block",
            };
          } else if (type === "image-group") {
            content = {
              images: [],
              layout: "block",
            };
          }
          setBlocks([
            ...blocks,
            {
              id: crypto.randomUUID(),
              type,
              content,
              dir: "rtl",
            },
          ]);
        };
        const updateBlock = (id, val) =>
          setBlocks(
            blocks.map((b) => (b.id === id ? { ...b, content: val } : b))
          );
        const updateBlockDir = (id) =>
          setBlocks(
            blocks.map((b) =>
              b.id === id ? { ...b, dir: b.dir === "ltr" ? "rtl" : "ltr" } : b
            )
          );
        const removeBlock = (id) =>
          setBlocks(blocks.filter((b) => b.id !== id));

        const handleDragStart = (index) => setDraggedItemIndex(index);

        // حساب أي gap هو المستهدف بناءً على موضع الماوس
        const calculateDropGap = (e, container) => {
          if (!container) return null;
          const containerRect = container.getBoundingClientRect();
          const mouseY = e.clientY - containerRect.top;

          // الحصول على جميع العناصر (divs فقط، وليس drop-indicator)
          const children = Array.from(container.children).filter(
            (child) =>
              child.tagName === "DIV" &&
              !child.classList.contains("drop-indicator")
          );

          if (children.length === 0) return 0;

          // حساب مواضع العناصر والـ gaps
          for (let i = 0; i < children.length; i++) {
            const childRect = children[i].getBoundingClientRect();
            const childTop = childRect.top - containerRect.top;
            const childBottom = childRect.bottom - containerRect.top;

            // حساب الـ gap قبل العنصر (النصف العلوي من المسافة بين العناصر)
            const gapBeforeTop = i === 0 ? 0 : childTop - 16; // 16px هو gap-4 في Tailwind
            const gapBeforeBottom = childTop;

            // حساب الـ gap بعد العنصر (النصف السفلي من المسافة بين العناصر)
            const gapAfterTop = childBottom;
            const gapAfterBottom =
              i === children.length - 1
                ? containerRect.height
                : childBottom + 16;

            // إذا كان الماوس في الـ gap قبل العنصر
            if (mouseY >= gapBeforeTop && mouseY < gapBeforeBottom) {
              return i;
            }

            // إذا كان الماوس في العنصر نفسه
            if (mouseY >= childTop && mouseY <= childBottom) {
              const midpoint = childTop + (childBottom - childTop) / 2;
              if (mouseY < midpoint) {
                return i; // النصف العلوي = gap قبل
              } else {
                return i + 1; // النصف السفلي = gap بعد
              }
            }

            // إذا كان الماوس في الـ gap بعد العنصر
            if (mouseY > childBottom && mouseY <= gapAfterBottom) {
              return i + 1;
            }
          }

          // إذا كان الماوس بعد كل العناصر، الإسقاط في آخر gap
          return children.length;
        };

        const handleDragOver = (e) => {
          e.preventDefault();
          if (draggedItemIndex === null) return;

          const container = e.currentTarget.closest(".blocks-container");
          if (!container) return;

          const gapIndex = calculateDropGap(e, container);
          if (gapIndex !== null && gapIndex !== dropGapIndex) {
            setDropGapIndex(gapIndex);
          }
        };

        const handleDragEnter = (e) => {
          if (draggedItemIndex === null) return;

          const container = e.currentTarget.closest(".blocks-container");
          if (!container) return;

          const gapIndex = calculateDropGap(e, container);
          if (gapIndex !== null) {
            setDropGapIndex(gapIndex);
          }
        };

        const handleDragLeave = (e) => {
          // فقط إذا خرجنا من الـ container بالكامل
          const container = e.currentTarget.closest(".blocks-container");
          if (!container || !container.contains(e.relatedTarget)) {
            setDropGapIndex(null);
          }
        };

        const handleDrop = (e) => {
          e.preventDefault();
          if (draggedItemIndex === null || dropGapIndex === null) {
            setDraggedItemIndex(null);
            setDropGapIndex(null);
            return;
          }

          const newBlocks = [...blocks];
          const item = newBlocks[draggedItemIndex];

          // إزالة العنصر من موضعه الأصلي
          newBlocks.splice(draggedItemIndex, 1);

          // حساب الموضع النهائي بناءً على gap index
          let insertIndex = dropGapIndex;

          // إذا كان العنصر المسحوب قبل الموضع الجديد، نصحح الموضع
          if (draggedItemIndex < dropGapIndex) {
            insertIndex -= 1;
          }

          newBlocks.splice(insertIndex, 0, item);
          setBlocks(newBlocks);
          setDraggedItemIndex(null);
          setDropGapIndex(null);
        };

        const handleMoveUp = (index) => {
          if (index === 0) return;
          const newBlocks = [...blocks];
          [newBlocks[index - 1], newBlocks[index]] = [
            newBlocks[index],
            newBlocks[index - 1],
          ];
          setBlocks(newBlocks);
        };

        const handleMoveDown = (index) => {
          if (index === blocks.length - 1) return;
          const newBlocks = [...blocks];
          [newBlocks[index + 1], newBlocks[index]] = [
            newBlocks[index],
            newBlocks[index + 1],
          ];
          setBlocks(newBlocks);
        };

        const handleImportClick = () => importFileRef.current.click();
        const handleFileImport = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              loadPostData(JSON.parse(event.target.result));
              e.target.value = null;
              alert("تم الاستيراد.");
            } catch (err) {
              alert("ملف تالف.");
            }
          };
          reader.readAsText(file);
        };

        const handleDeleteCurrent = async () => {
          if (!postId) return;
          // تغيير نص التأكيد
          if (!confirm("هل أنت متأكد من نقل هذا المقال إلى سلة المحذوفات؟"))
            return;
          try {
            // تحديث الحقل deleted بدلاً من delete()
            await db.collection("posts").doc(postId).update({ deleted: true });

            setNotification({
              type: "success",
              message: "تم نقل المقال إلى سلة المحذوفات",
            });
            setTimeout(() => setNotification(null), 3000);
            reset(true); // تفريغ المحرر بدون تأكيد (لأن المستخدم أكد بالفعل عند الحذف)
          } catch (e) {
            setNotification({ type: "error", message: "خطأ: " + e.message });
            setTimeout(() => setNotification(null), 3000);
          }
        };

        const handleSave = async () => {
          if (!title) {
            setNotification({ type: "error", message: "اكتب العنوان!" });
            setTimeout(() => setNotification(null), 3000);
            return;
          }
          setIsSaving(true);
          const fullContent = renderPreview();
          // Extract text from HTML for excerpt
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = fullContent;
          const textContent = tempDiv.textContent || tempDiv.innerText || "";
          const postData = {
            title,
            coverImage,
            topics,
            blocks,
            content: fullContent,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            deleted: false, // <--- أضف هذا السطر لضمان أن المقال يعتبر "منشور" عند الحفظ
            excerpt:
              textContent.substring(0, 150) +
              (textContent.length > 150 ? "..." : ""),
          };
          try {
            const idToUse = postId || crypto.randomUUID();
            const docRef = db.collection("posts").doc(idToUse);
            if (!postId)
              postData.createdAt =
                firebase.firestore.FieldValue.serverTimestamp();
            await docRef.set(postData, { merge: true });
            setPostId(idToUse);
            window.history.pushState({ id: idToUse }, "", `?id=${idToUse}`);
            setNotification({ type: "success", message: "تم الحفظ!" });
            setTimeout(() => setNotification(null), 3000);
          } catch (e) {
            setNotification({ type: "error", message: "خطأ: " + e.message });
            setTimeout(() => setNotification(null), 3000);
          } finally {
            setIsSaving(false);
          }
        };

        const handleDownload = () => {
          if (!title) return alert("العنوان مطلوب");
          const fileName = `${title
            .trim()
            .replace(/\s+/g, "-")
            .replace(/[^a-zA-Z0-9\u0621-\u064A-]/g, "")}.json`;
          const blob = new Blob(
            [JSON.stringify({ id: postId, title, blocks }, null, 2)],
            { type: "application/json" }
          );
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const goToViewer = () => {
          try {
            window.location.href = "viewer.html";
          } catch (e) {
            alert("افتح viewer.html");
          }
        };
        const reset = (skipConfirm = false) => {
          // إذا لم يكن skipConfirm، نطلب التأكيد من المستخدم
          if (!skipConfirm) {
            if (
              !confirm(
                "هل أنت متأكد من إعادة تعيين المحرر؟ سيتم مسح جميع المحتويات غير المحفوظة."
              )
            ) {
              return;
            }
          }

          setPostId(null);
          setTitle("");
          setCoverImage("");
          setTopics([]);
          setBlocks([
            {
              id: crypto.randomUUID(),
              type: "text",
              content: "",
              dir: "rtl",
            },
          ]);
          window.history.pushState({}, "", window.location.pathname);
        };

        const renderPreview = () => {
          const parts = blocks
            .map((b, idx) => {
              if (b.type === "text") {
                // Text blocks - use markdown with placeholder
                if (b.dir === "ltr") {
                  return {
                    type: "markdown",
                    content: `\n<div dir="ltr" style="text-align: left;">\n\n${b.content}\n\n</div>\n`,
                    index: idx,
                  };
                }
                return {
                  type: "markdown",
                  content: `\n${b.content}\n`,
                  index: idx,
                };
              } else if (b.type === "image") {
                // Old format - convert to markdown
                const imageUrl =
                  typeof b.content === "string"
                    ? b.content
                    : b.content?.url || "";
                return imageUrl
                  ? {
                      type: "markdown",
                      content: `\n![Image](${imageUrl})\n`,
                      index: idx,
                    }
                  : null;
              } else if (b.type === "button") {
                // Old format - convert to HTML
                const buttonData = b.content || {};
                const { text, url, color, textColorMode } = buttonData;
                if (!text) return null;
                const textColor =
                  textColorMode === "white"
                    ? "#ffffff"
                    : textColorMode === "black"
                    ? "#000000"
                    : getContrastColor(color);
                return {
                  type: "html",
                  content: `<div class="my-6 text-center"><a href="${url}" style="background-color: ${color}; color: ${textColor} !important; text-decoration: none !important;" class="inline-block font-bold py-3 px-8 rounded-full shadow-lg no-underline">${text}</a></div>`,
                  index: idx,
                };
              } else if (b.type === "button-group") {
                // Button groups - HTML directly
                const groupData = b.content || {};
                const { buttons = [], layout = "block" } = groupData;
                if (buttons.length === 0) return null;
                const buttonsHtml = buttons
                  .map((btn) => {
                    if (!btn.text) return "";
                    const textColor =
                      btn.textColorMode === "white"
                        ? "#ffffff"
                        : btn.textColorMode === "black"
                        ? "#000000"
                        : getContrastColor(btn.color || "#10b981");
                    return `<a href="${
                      btn.url || "#"
                    }" style="background-color: ${
                      btn.color || "#10b981"
                    }; color: ${textColor} !important; text-decoration: none !important;" class="inline-block font-bold py-3 px-8 rounded-full shadow-lg no-underline mx-2 mb-2">${
                      btn.text
                    }</a>`;
                  })
                  .filter(Boolean)
                  .join("");
                const containerClass =
                  layout === "inline"
                    ? "my-6 text-center flex flex-wrap gap-2 justify-center"
                    : "my-6 text-center flex flex-col gap-2 items-center";
                return {
                  type: "html",
                  content: `<div class="${containerClass}">${buttonsHtml}</div>`,
                  index: idx,
                };
              } else if (b.type === "image-group") {
                // Image groups - HTML directly
                const groupData = b.content || {};
                const { images = [], layout = "block" } = groupData;
                const validImages = images.filter((img) => img && img.trim());
                if (validImages.length === 0) return null;

                // Grid layout based on number of images (like LinkedIn)
                let gridClass = "";
                let showMore = false;
                let displayImages = validImages;
                let remainingCount = 0;

                if (layout === "inline") {
                  if (validImages.length === 1) {
                    gridClass = "grid grid-cols-1";
                  } else if (validImages.length === 2) {
                    gridClass = "grid grid-cols-2";
                  } else if (validImages.length === 3) {
                    gridClass = "grid grid-cols-3";
                  } else {
                    // 4 or more: show first 3 + overlay with count starting from +1
                    displayImages = validImages.slice(0, 3);
                    remainingCount = validImages.length - 3;
                    showMore = remainingCount > 0;
                    gridClass = "grid grid-cols-3";
                  }
                } else {
                  // Block layout: vertical stack
                  gridClass = "grid grid-cols-1";
                }

                const imagesHtml = displayImages
                  .map((imgUrl, imgIdx) => {
                    if (!imgUrl) return "";
                    const isLastInGrid =
                      imgIdx === displayImages.length - 1 && showMore;
                    return `<div class="relative">
                    <img src="${imgUrl}" alt="Image" class="w-full h-full object-cover rounded-lg border border-gray-200 dark:border-gray-700 cursor-zoom-in" style="max-height: ${
                      layout === "inline" ? "120px" : "400px"
                    }; min-height: ${
                      layout === "inline" ? "80px" : "300px"
                    }; max-width: ${layout === "inline" ? "100%" : "100%"};" />
                    ${
                      isLastInGrid
                        ? `<div class="absolute inset-0 bg-black/60 rounded-lg flex items-center justify-center">
                      <span class="text-white text-2xl font-bold">+${remainingCount}</span>
                    </div>`
                        : ""
                    }
                  </div>`;
                  })
                  .filter(Boolean)
                  .join("");

                const containerClass = `my-6 ${gridClass} gap-2`;
                return {
                  type: "html",
                  content: `<div class="${containerClass}" data-all-images='${JSON.stringify(
                    validImages
                  ).replace(/'/g, "&#39;")}'>${imagesHtml}</div>`,
                  index: idx,
                };
              }
              return null;
            })
            .filter(Boolean);

          // Build final HTML by processing markdown and inserting HTML
          let result = "";
          let markdownBuffer = "";

          parts.forEach((part) => {
            if (part.type === "markdown") {
              markdownBuffer += part.content;
            } else {
              // Flush markdown buffer
              if (markdownBuffer) {
                result += marked.parse(markdownBuffer);
                markdownBuffer = "";
              }
              // Add HTML directly
              result += part.content;
            }
          });

          // Flush remaining markdown
          if (markdownBuffer) {
            result += marked.parse(markdownBuffer);
          }

          return result;
        };

        if (authChecking)
          return (
            <div className="min-h-screen flex items-center justify-center bg-dark text-white">
              <Loader className="w-8 h-8" />
            </div>
          );
        if (!user)
          return (
            <>
              <AuthScreen
                onLogin={handleAuthSuccess}
                onOpenSettings={() => setShowSettings(true)}
              />
              <SettingsModal
                isOpen={showSettings}
                onClose={() => setShowSettings(false)}
                currentImgbbKey={imgbbApiKey}
                user={user}
              />
            </>
          );

        return (
          <div
            className={`min-h-screen flex flex-col font-sans h-screen overflow-hidden transition-colors duration-500 ${getThemeClass()}`}
          >
            <header className="bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-b border-gray-200 dark:border-slate-700 p-4 shrink-0 z-50">
              <div className="max-w-7xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <h1 className="text-xl font-bold text-primary flex items-center gap-2">
                    WP Cloud
                  </h1>
                  <div className="flex gap-1 bg-gray-100 dark:bg-slate-900 px-2 py-1 rounded-full border border-gray-200 dark:border-gray-700">
                    {firebaseInitialized ? (
                      <CheckCircle size={14} className="text-green-500" />
                    ) : (
                      <AlertCircle size={14} className="text-red-500" />
                    )}
                    <div className="w-px h-3 bg-gray-300 dark:bg-gray-600"></div>
                    {imgbbApiKey ? (
                      <CheckCircle size={14} className="text-green-500" />
                    ) : (
                      <AlertCircle size={14} className="text-yellow-500" />
                    )}
                  </div>
                </div>
                <div className="flex gap-2 items-center">
                  {/* Mobile Menu Button - يظهر فقط على الشاشات الصغيرة */}
                  <button
                    onClick={() => setShowMobileMenu(!showMobileMenu)}
                    className="lg:hidden bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 p-2 rounded-lg"
                    title="القائمة"
                  >
                    <Menu size={20} />
                  </button>

                  {/* Desktop Buttons - تظهر فقط على الشاشات الكبيرة */}
                  <div className="hidden lg:flex gap-2">
                    <button
                      onClick={goToViewer}
                      className="bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-800/50 text-indigo-700 dark:text-indigo-300 p-2 rounded-lg"
                      title="تطبيق القارئ"
                    >
                      <Monitor size={18} />
                    </button>
                    <button
                      onClick={() => setShowSettings(true)}
                      className="bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 p-2 rounded-lg"
                      title="الإعدادات"
                    >
                      <Settings size={18} />
                    </button>
                    <button
                      onClick={handleLogout}
                      className="bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 p-2 rounded-lg"
                      title="تسجيل الخروج"
                    >
                      <LogOut size={18} />
                    </button>
                    <button
                      onClick={() => setShowLoadModal(true)}
                      className="bg-gray-100 dark:bg-slate-700 p-2 rounded-lg"
                      title="فتح من السحابة"
                    >
                      <CloudDownload size={18} />
                    </button>
                    <input
                      type="file"
                      ref={importFileRef}
                      onChange={handleFileImport}
                      accept=".json"
                      className="hidden"
                    />
                    <button
                      onClick={handleImportClick}
                      className="bg-gray-100 dark:bg-slate-700 p-2 rounded-lg"
                      title="فتح ملف محلي"
                    >
                      <FolderOpen size={18} />
                    </button>
                    <button
                      onClick={handleDownload}
                      className="bg-gray-100 dark:bg-slate-700 p-2 rounded-lg"
                      title="تصدير ملف"
                    >
                      <Save size={18} />
                    </button>
                  </div>

                  {/* View Mode Toggle - يظهر فقط على الشاشات الصغيرة */}
                  <button
                    onClick={() =>
                      setViewMode((prev) =>
                        prev === "edit" ? "preview" : "edit"
                      )
                    }
                    className={`lg:hidden px-3 py-2 rounded-lg font-bold flex items-center gap-1 text-sm transition-colors ${
                      viewMode === "preview"
                        ? "bg-indigo-500 text-white"
                        : "bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300"
                    }`}
                  >
                    {viewMode === "edit" ? (
                      <Eye size={16} />
                    ) : (
                      <Edit size={16} />
                    )}{" "}
                    <span className="hidden sm:inline">
                      {viewMode === "edit" ? "معاينة" : "تحرير"}
                    </span>
                  </button>
                  {/* Desktop Only Buttons - مخفية على الشاشات الصغيرة */}
                  <div className="hidden lg:flex items-center gap-2">
                    {postId && (
                      <button
                        onClick={handleDeleteCurrent}
                        className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-2 rounded-lg"
                        title="حذف المقال الحالي"
                      >
                        <Trash2 size={18} />
                      </button>
                    )}
                    <button
                      onClick={() => reset()}
                      className="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                    >
                      <RefreshCw size={18} />
                    </button>
                    <div className="w-px h-8 bg-gray-300 mx-1"></div>
                    <button
                      onClick={() => setShowFullPreview(true)}
                      className="p-2 text-indigo-500 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors flex items-center gap-1"
                      title="معاينة كاملة"
                    >
                      <Eye size={18} />
                      <span className="text-sm font-bold">معاينة</span>
                    </button>
                    <div className="w-px h-8 bg-gray-300 mx-1"></div>
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => setDarkMode(!darkMode)}
                        className="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                        title={darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                      >
                        {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                      </button>
                      <div className="relative">
                        <button
                          onClick={() => setShowThemeMenu(!showThemeMenu)}
                          className="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                          title="تغيير المظهر"
                        >
                          <Palette size={18} />
                        </button>
                        {showThemeMenu && (
                          <div className="absolute top-12 left-0 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-[100] flex flex-col gap-1">
                            {Object.entries(themes).map(([key, t]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setCurrentTheme(key);
                                  setShowThemeMenu(false);
                                }}
                                className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                  currentTheme === key
                                    ? "text-primary font-bold"
                                    : ""
                                }`}
                              >
                                {t.name}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={handleSave}
                    disabled={isSaving}
                    className="bg-primary text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"
                  >
                    {isSaving ? (
                      <Loader className="w-4 h-4" />
                    ) : (
                      <Cloud size={16} />
                    )}{" "}
                    <span className="hidden sm:inline">حفظ</span>
                  </button>
                </div>
              </div>
            </header>

            {/* Notification */}
            {notification && (
              <div
                className={`fixed top-20 left-1/2 transform -translate-x-1/2 z-[100] px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
                  notification.type === "success"
                    ? "bg-green-500 text-white"
                    : "bg-red-500 text-white"
                }`}
                style={{
                  animation: "fadeIn 0.3s ease-in",
                }}
              >
                {notification.type === "success" ? (
                  <CheckCircle size={20} />
                ) : (
                  <AlertCircle size={20} />
                )}
                <span className="font-bold">{notification.message}</span>
              </div>
            )}

            {/* Fullscreen Preview Mode */}
            {showFullPreview && (
              <div className={`fullscreen-preview ${getThemeClass()}`}>
                <button
                  onClick={() => setShowFullPreview(false)}
                  className="fullscreen-preview-close"
                  title="إغلاق المعاينة (ESC)"
                >
                  <X size={24} />
                </button>
                <div className="min-h-screen pb-20">
                  {coverImage && (
                    <div className="w-full h-64 md:h-96 relative">
                      <img
                        src={coverImage}
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute inset-0 bg-gradient-to-t from-gray-50/100 dark:from-dark to-transparent pointer-events-none"></div>
                    </div>
                  )}
                  <div
                    className={`max-w-3xl mx-auto px-4 ${
                      coverImage ? "-mt-20 relative z-10" : "pt-24"
                    }`}
                  >
                    <article className="animate-fade-in bg-white/90 dark:bg-slate-800/90 p-6 md:p-8 rounded-2xl shadow-sm backdrop-blur-md border border-gray-100 dark:border-gray-700">
                      <div className="mb-8 border-b border-gray-100 dark:border-gray-700 pb-6">
                        {topics.length > 0 && (
                          <div className="flex flex-wrap gap-2 mb-4">
                            {topics.map((t, i) => (
                              <span
                                key={i}
                                className="px-3 py-1 bg-primary/10 text-primary text-xs font-bold rounded-full"
                              >
                                #{t}
                              </span>
                            ))}
                          </div>
                        )}
                        <h1 className="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white leading-tight mb-4">
                          {title || "عنوان المقال"}
                        </h1>
                        <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                          <span>معاينة</span>
                          <span>•</span>
                          <span>قراءة ممتعة ☕</span>
                        </div>
                      </div>
                      <div
                        className="prose-rtl"
                        dangerouslySetInnerHTML={{ __html: renderPreview() }}
                      />
                    </article>
                  </div>
                </div>
              </div>
            )}

            {/* Mobile Menu - قائمة منسدلة عمودية للشاشات الصغيرة */}
            {showMobileMenu && (
              <div className="lg:hidden fixed top-16 left-0 right-0 z-40 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 shadow-lg max-h-[calc(100vh-4rem)] overflow-y-auto">
                <div className="flex flex-col gap-1 p-2">
                  <button
                    onClick={() => {
                      goToViewer();
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-800/50 text-indigo-700 dark:text-indigo-300 text-right"
                  >
                    <Monitor size={20} />
                    <span className="font-bold">تطبيق القارئ</span>
                  </button>
                  <button
                    onClick={() => {
                      setShowSettings(true);
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 text-right"
                  >
                    <Settings size={20} />
                    <span className="font-bold">الإعدادات</span>
                  </button>
                  <button
                    onClick={() => {
                      handleLogout();
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 text-right"
                  >
                    <LogOut size={20} />
                    <span className="font-bold">تسجيل الخروج</span>
                  </button>
                  <button
                    onClick={() => {
                      setShowLoadModal(true);
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 text-right"
                  >
                    <CloudDownload size={20} />
                    <span className="font-bold">فتح من السحابة</span>
                  </button>
                  <input
                    type="file"
                    ref={importFileRef}
                    onChange={handleFileImport}
                    accept=".json"
                    className="hidden"
                  />
                  <button
                    onClick={() => {
                      handleImportClick();
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 text-right"
                  >
                    <FolderOpen size={20} />
                    <span className="font-bold">فتح ملف محلي</span>
                  </button>
                  <button
                    onClick={() => {
                      handleDownload();
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 text-right"
                  >
                    <Save size={20} />
                    <span className="font-bold">تصدير ملف</span>
                  </button>
                  {postId && (
                    <button
                      onClick={() => {
                        handleDeleteCurrent();
                        setShowMobileMenu(false);
                      }}
                      className="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 text-right"
                    >
                      <Trash2 size={20} />
                      <span className="font-bold">حذف المقال الحالي</span>
                    </button>
                  )}
                  <button
                    onClick={() => {
                      reset();
                      setShowMobileMenu(false);
                    }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-right"
                  >
                    <RefreshCw size={20} />
                    <span className="font-bold">إعادة تعيين</span>
                  </button>
                  <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                  <div className="flex items-center justify-between px-4 py-3">
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => setDarkMode(!darkMode)}
                        className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                        title={darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                      >
                        {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                      </button>
                      <div className="relative">
                        <button
                          onClick={() => setShowThemeMenu(!showThemeMenu)}
                          className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                          title="تغيير المظهر"
                        >
                          <Palette size={20} />
                        </button>
                        {showThemeMenu && (
                          <div className="absolute top-12 left-0 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-[100] flex flex-col gap-1">
                            {Object.entries(themes).map(([key, t]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setCurrentTheme(key);
                                  setShowThemeMenu(false);
                                }}
                                className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                  currentTheme === key
                                    ? "text-primary font-bold"
                                    : ""
                                }`}
                              >
                                {t.name}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    <button
                      onClick={() => setShowMobileMenu(false)}
                      className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500"
                    >
                      <X size={20} />
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Overlay لإغلاق القائمة عند الضغط خارجها */}
            {showMobileMenu && (
              <div
                className="lg:hidden fixed inset-0 bg-black/20 z-30"
                onClick={() => setShowMobileMenu(false)}
              ></div>
            )}

            <SettingsModal
              isOpen={showSettings}
              onClose={() => setShowSettings(false)}
              currentImgbbKey={imgbbApiKey}
            />
            <PostListModal
              isOpen={showLoadModal}
              onClose={() => setShowLoadModal(false)}
              onSelect={loadPostData}
              onShowToast={(type, message) => {
                setNotification({ type, message });
                setTimeout(() => setNotification(null), 3000);
              }}
            />

            <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 items-start h-[calc(100vh-80px)] overflow-hidden">
              {/* Editor Column - Independent Scroll */}
              <div
                className={`flex flex-col gap-6 pb-20 h-full overflow-y-auto custom-scrollbar ${
                  viewMode === "preview" ? "hidden lg:flex" : "flex"
                }`}
              >
                <div className="bg-white dark:bg-surface p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col gap-4">
                  <div className="flex justify-between items-center">
                    <span className="text-sm font-bold text-gray-400">
                      العنوان
                    </span>
                    <span className="text-[10px] text-gray-400 font-mono">
                      {postId
                        ? "تعديل: " + postId.substring(0, 6)
                        : "مقال جديد"}
                    </span>
                  </div>
                  <input
                    type="text"
                    placeholder="عنوان المقال..."
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className="w-full p-3 text-xl font-bold rounded-lg bg-gray-50 dark:bg-slate-900/50 border border-gray-200 dark:border-gray-600 focus:border-primary outline-none"
                  />
                  <ImageUploader
                    image={coverImage}
                    onChange={setCoverImage}
                    imgbbApiKey={imgbbApiKey}
                    heightClass="max-h-48"
                  />
                  <div>
                    <div className="flex flex-wrap gap-2 mb-2">
                      {topics.map((t) => (
                        <span
                          key={t}
                          className="text-xs bg-primary/10 text-primary px-2 py-1 rounded flex items-center gap-1"
                        >
                          #{t}{" "}
                          <button onClick={() => removeTag(t)}>
                            <X size={10} />
                          </button>
                        </span>
                      ))}
                    </div>
                    <input
                      type="text"
                      placeholder="أضف تاج واضغط Enter"
                      value={tagInput}
                      onChange={(e) => setTagInput(e.target.value)}
                      onKeyDown={handleTagInputKeyDown}
                      className="w-full p-2 text-sm rounded bg-gray-50 dark:bg-slate-900/50 border dark:border-gray-600 focus:border-primary outline-none"
                    />
                  </div>
                </div>
                <div
                  className="blocks-container flex flex-col gap-4"
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={handleDrop}
                >
                  {blocks.map((block, index) => (
                    <React.Fragment key={block.id}>
                      {/* Drop Indicator Line - في الـ gap قبل العنصر */}
                      {dropGapIndex === index &&
                        draggedItemIndex !== null &&
                        draggedItemIndex !== index && (
                          <div className="drop-indicator h-2 bg-primary rounded-full mx-4 animate-pulse shadow-lg shadow-primary/50 border-2 border-primary flex items-center">
                            <div className="w-3 h-3 bg-primary rounded-full -mr-2 border-2 border-white dark:border-slate-800"></div>
                            <div className="flex-1 h-0.5 bg-primary"></div>
                            <div className="w-3 h-3 bg-primary rounded-full -ml-2 border-2 border-white dark:border-slate-800"></div>
                          </div>
                        )}
                      <div
                        draggable={false}
                        onDragStart={(e) => {
                          // منع السحب من العنصر نفسه
                          if (e.target.closest('[draggable="true"]') === null) {
                            e.preventDefault();
                          }
                        }}
                        className={`group relative bg-white dark:bg-surface rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm transition-all ${
                          draggedItemIndex === index
                            ? "opacity-50 scale-95"
                            : ""
                        }`}
                      >
                        <div
                          draggable={true}
                          onDragStart={(e) => {
                            e.stopPropagation();
                            e.dataTransfer.effectAllowed = "move";
                            handleDragStart(index);
                          }}
                          onDragEnd={() => {
                            setDraggedItemIndex(null);
                            setDropGapIndex(null);
                          }}
                          onMouseDown={(e) => {
                            e.stopPropagation();
                          }}
                          className="absolute top-0 right-0 bottom-0 w-8 flex flex-col items-center justify-center border-l border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50 rounded-r-xl cursor-grab active:cursor-grabbing text-gray-400 hover:text-primary hover:bg-gray-100 dark:hover:bg-slate-700 z-10 transition-colors select-none touch-none"
                          style={{
                            userSelect: "none",
                            WebkitUserSelect: "none",
                            WebkitTouchCallout: "none",
                            touchAction: "none",
                          }}
                        >
                          <GripVertical size={16} />
                        </div>
                        <div
                          className="flex justify-between items-center px-4 py-2 border-b border-gray-100 dark:border-gray-700 mr-8"
                          draggable={false}
                          onDragStart={(e) => e.preventDefault()}
                        >
                          <span className="text-xs font-bold text-gray-400 flex items-center gap-2">
                            {block.type === "text" && <Type size={14} />}
                            {block.type === "button-group" && (
                              <LinkIcon size={14} />
                            )}
                            {block.type === "image-group" && (
                              <ImageIcon size={14} />
                            )}
                            {block.type === "text"
                              ? "نص"
                              : block.type === "button-group"
                              ? "أزرار"
                              : block.type === "image-group"
                              ? "صور"
                              : "غير معروف"}
                          </span>
                          {/* Alignment Button for Text Blocks Moved Here */}
                          {block.type === "text" && (
                            <button
                              onClick={() => updateBlockDir(block.id)}
                              title="تغيير اتجاه النص"
                              className="text-gray-500 hover:text-primary p-1 rounded hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                            >
                              {block.dir === "ltr" ? (
                                <AlignRight size={14} />
                              ) : (
                                <AlignLeft size={14} />
                              )}
                            </button>
                          )}
                          <div className="flex items-center gap-1">
                            <button
                              onClick={() => handleMoveUp(index)}
                              disabled={index === 0}
                              className="p-1 text-gray-400 hover:text-primary disabled:opacity-30"
                            >
                              <ArrowUp size={14} />
                            </button>
                            <button
                              onClick={() => handleMoveDown(index)}
                              disabled={index === blocks.length - 1}
                              className="p-1 text-gray-400 hover:text-primary disabled:opacity-30"
                            >
                              <ArrowDown size={14} />
                            </button>
                            <button
                              onClick={() => removeBlock(block.id)}
                              className="text-red-400 hover:text-red-600"
                            >
                              <X size={16} />
                            </button>
                          </div>
                        </div>
                        <div
                          className="mr-8"
                          draggable={false}
                          onDragStart={(e) => e.preventDefault()}
                          onDrag={(e) => e.preventDefault()}
                        >
                          {block.type === "text" && (
                            <TextBlock
                              content={block.content}
                              dir={block.dir}
                              onChange={(val) => updateBlock(block.id, val)}
                            />
                          )}
                          {block.type === "button-group" && (
                            <ButtonGroupBlock
                              content={block.content}
                              onChange={(val) => updateBlock(block.id, val)}
                            />
                          )}
                          {block.type === "image-group" && (
                            <ImageGroupBlock
                              content={block.content}
                              onChange={(val) => updateBlock(block.id, val)}
                              imgbbApiKey={imgbbApiKey}
                            />
                          )}
                        </div>
                      </div>
                    </React.Fragment>
                  ))}
                  {/* Drop Indicator Line - في آخر gap (بعد آخر عنصر) */}
                  {dropGapIndex === blocks.length &&
                    draggedItemIndex !== null && (
                      <div className="drop-indicator h-2 bg-primary rounded-full mx-4 animate-pulse shadow-lg shadow-primary/50 border-2 border-primary flex items-center">
                        <div className="w-3 h-3 bg-primary rounded-full -mr-2 border-2 border-white dark:border-slate-800"></div>
                        <div className="flex-1 h-0.5 bg-primary"></div>
                        <div className="w-3 h-3 bg-primary rounded-full -ml-2 border-2 border-white dark:border-slate-800"></div>
                      </div>
                    )}
                </div>
                <div className="grid grid-cols-3 gap-3 p-4 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl">
                  <button
                    onClick={() => addBlock("text")}
                    className="p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded text-sm font-bold"
                  >
                    نص
                  </button>
                  <button
                    onClick={() => addBlock("button-group")}
                    className="p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded text-sm font-bold"
                  >
                    أزرار
                  </button>
                  <button
                    onClick={() => addBlock("image-group")}
                    className="p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded text-sm font-bold"
                  >
                    صور
                  </button>
                </div>
              </div>

              {/* Preview Column - Independent Scroll */}
              <div
                className={`h-full overflow-y-auto custom-scrollbar ${
                  viewMode === "edit" ? "hidden lg:block" : "block"
                }`}
              >
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 min-h-full">
                  {coverImage && (
                    <div className="w-full h-64 md:h-80 relative">
                      <img
                        src={coverImage}
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute inset-0 bg-gradient-to-t from-gray-900/60 to-transparent"></div>
                    </div>
                  )}
                  <div className="p-8 md:p-12">
                    <h1 className="text-4xl font-extrabold mb-4 text-slate-900 dark:text-white leading-tight">
                      {title || "عنوان المقال"}
                    </h1>
                    {topics.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-8">
                        {topics.map((t, i) => (
                          <span
                            key={i}
                            className="px-3 py-1 bg-primary/10 text-primary text-sm font-bold rounded-full"
                          >
                            #{t}
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="w-full h-px bg-gray-200 dark:bg-gray-700 my-8"></div>
                    <div
                      ref={previewRef}
                      className="prose-rtl"
                      dangerouslySetInnerHTML={{ __html: renderPreview() }}
                    ></div>
                  </div>
                </div>
              </div>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
    <style>
      /* Writer-specific styles only */
      .ltr {
        direction: ltr;
        text-align: left;
      }
    </style>
  </body>
</html>
