<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>حكاوي واحد غاوي</title>
    <meta
      name="description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />

    <!-- Open Graph / Facebook / Discord / Slack -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Tech Stories Archive" />
    <meta
      property="og:url"
      content="https://mabdullah821.github.io/tech-stories-archive/viewer.html"
    />
    <meta property="og:title" content="حكاوي واحد غاوي" />
    <meta
      property="og:description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />
    <meta
      property="og:image"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />
    <meta
      property="og:image:secure_url"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta
      property="og:image:alt"
      content="حكاوي واحد غاوي - ارشيف حكاوي واحد غاوي"
    />
    <meta property="og:locale" content="ar_EG" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="حكاوي واحد غاوي" />
    <meta
      name="twitter:description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />
    <meta
      name="twitter:image"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@300;400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Highlight.js CSS for Code Coloring -->
    <link
      id="hljs-light-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css"
    />
    <link
      id="hljs-dark-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
      disabled
    />
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared-styles.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Tajawal", "sans-serif"],
              mono: ["Fira Code", "monospace"],
            },
            colors: { primary: "#10b981", dark: "#0f172a" },
          },
        },
      };
    </script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>
  <body
    class="bg-gray-50 dark:bg-dark text-slate-800 dark:text-slate-100 transition-colors duration-300"
  >
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- Icons Definitions (SVG Components) ---
      const IconBase = ({ children, size = 24, className = "" }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {children}
        </svg>
      );

      const Sun = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="4" />
          <path d="M12 2v2" />
          <path d="M12 20v2" />
          <path d="m4.93 4.93 1.41 1.41" />
          <path d="m17.66 17.66 1.41 1.41" />
          <path d="M2 12h2" />
          <path d="M20 12h2" />
          <path d="m6.34 17.66-1.41-1.41" />
          <path d="m19.07 4.93-1.41 1.41" />
        </IconBase>
      );
      const Moon = (props) => (
        <IconBase {...props}>
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
        </IconBase>
      );
      const ArrowRight = (props) => (
        <IconBase {...props}>
          <path d="M5 12h14" />
          <path d="m12 5 7 7-7 7" />
        </IconBase>
      );
      const LoaderIcon = (props) => (
        <IconBase {...props}>
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </IconBase>
      );
      const X = (props) => (
        <IconBase {...props}>
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </IconBase>
      );
      const Edit = (props) => (
        <IconBase {...props}>
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
        </IconBase>
      );
      const TagIcon = (props) => (
        <IconBase {...props}>
          <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
          <path d="M7 7h.01" />
        </IconBase>
      );
      const ChevronDown = (props) => (
        <IconBase {...props}>
          <path d="m6 9 6 6 6-6" />
        </IconBase>
      );
      const ChevronUp = (props) => (
        <IconBase {...props}>
          <path d="m18 15-6-6-6 6" />
        </IconBase>
      );
      const ChevronLeft = (props) => (
        <IconBase {...props}>
          <path d="m15 18-6-6 6-6" />
        </IconBase>
      );
      const ChevronRight = (props) => (
        <IconBase {...props}>
          <path d="m9 18 6-6-6-6" />
        </IconBase>
      );
      const PlusCircle = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="10" />
          <path d="M8 12h8" />
          <path d="M12 8v8" />
        </IconBase>
      );
      const Palette = (props) => (
        <IconBase {...props}>
          <circle cx="13.5" cy="6.5" r=".5" />
          <circle cx="17.5" cy="10.5" r=".5" />
          <circle cx="8.5" cy="7.5" r=".5" />
          <circle cx="6.5" cy="12.5" r=".5" />
          <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
        </IconBase>
      );
      const ZoomIn = (props) => (
        <IconBase {...props}>
          <circle cx="11" cy="11" r="8" />
          <line x1="21" x2="16.65" y1="21" y2="16.65" />
          <line x1="11" x2="11" y1="8" y2="14" />
          <line x1="8" x2="14" y1="11" y2="11" />
        </IconBase>
      );
      const LinkIcon = (props) => (
        <IconBase {...props}>
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
        </IconBase>
      );
      const Copy = (props) => (
        <IconBase {...props}>
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
        </IconBase>
      );
      const Check = (props) => (
        <IconBase {...props}>
          <path d="M20 6 9 17l-5-5" />
        </IconBase>
      );
      const Layout = (props) => (
        <IconBase {...props}>
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
        </IconBase>
      );

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyAquezWzOJ5w5CZPuQFC01RxdGM2i9oYss",
        authDomain: "tech-stories-archive.firebaseapp.com",
        projectId: "tech-stories-archive",
        storageBucket: "tech-stories-archive.firebasestorage.app",
        messagingSenderId: "345367195836",
        appId: "1:345367195836:web:14719979eaad7bb43220b9",
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();

      // --- Themes Configuration ---
      const themes = {
        plain: {
          name: "بسيط",
          bgLight: "bg-gradient-to-br from-gray-50 to-gray-100",
          bgDark:
            "dark:bg-gradient-to-br dark:from-slate-900 dark:to-slate-800",
          accent: "text-primary",
          className: "theme-modern",
        },
        sepia: {
          name: "ورقي (Sepia)",
          bgLight: "bg-[#f4ecd8] text-slate-800",
          bgDark: "dark:bg-[#463a2a] dark:text-[#f4ecd8]",
          accent: "text-amber-600",
          className: "theme-sepia",
        },
        ocean: {
          name: "محيط (Ocean)",
          bgLight:
            "bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a1929] dark:via-[#0d1b2a] dark:to-[#0f172a] dark:text-cyan-100",
          accent: "text-cyan-500",
          className: "theme-ocean",
        },
        forest: {
          name: "غابة (Forest)",
          bgLight:
            "bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#022c22] dark:via-[#064e3b] dark:to-[#065f46] dark:text-emerald-100",
          accent: "text-emerald-500",
          className: "theme-forest",
        },
        midnight: {
          name: "فضاء (Midnight)",
          bgLight:
            "bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a0e27] dark:via-[#1a1b3a] dark:to-[#2d1b3d] dark:text-indigo-100",
          accent: "text-indigo-400",
          className: "theme-midnight",
        },
      };

      // --- Image Lightbox Component ---
      const ImageModal = ({
        images,
        currentIndex,
        onClose,
        onNext,
        onPrev,
      }) => {
        // Ensure images is an array
        const imagesArray = Array.isArray(images)
          ? images
          : images
          ? [images]
          : [];
        if (!imagesArray || imagesArray.length === 0) return null;

        // Ensure currentIndex is valid
        const validIndex = Math.max(
          0,
          Math.min(currentIndex || 0, imagesArray.length - 1)
        );
        const currentImage = imagesArray[validIndex];

        useEffect(() => {
          if (!imagesArray || imagesArray.length === 0) return;

          const handleKeyDown = (e) => {
            // Only handle if modal is open and not typing in input
            if (
              e.target.tagName === "INPUT" ||
              e.target.tagName === "TEXTAREA" ||
              e.target.isContentEditable
            ) {
              return;
            }

            if (e.key === "Escape") {
              e.preventDefault();
              e.stopPropagation();
              onClose();
            } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              onNext();
            } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              onPrev();
            }
          };

          // Add event listener with capture phase for better priority
          window.addEventListener("keydown", handleKeyDown, true);

          return () => {
            window.removeEventListener("keydown", handleKeyDown, true);
          };
        }, [onClose, onNext, onPrev, validIndex, imagesArray]);

        return (
          <div
            className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm cursor-zoom-out"
            onClick={onClose}
          >
            {/* Previous Button - Always show if more than 1 image */}
            {imagesArray.length > 1 && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onPrev();
                }}
                className={`absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/10 hover:bg-white/20 text-white p-3 rounded-full transition-colors z-[110] ${
                  validIndex === 0 ? "opacity-50 cursor-not-allowed" : ""
                }`}
                title="الصورة السابقة (←)"
                disabled={validIndex === 0}
                style={{ zIndex: 110 }}
              >
                <ChevronRight size={32} />
              </button>
            )}

            {/* Image Container - Maintain aspect ratio with smaller size */}
            <div className="flex items-center justify-center w-full h-full p-8 relative z-[105]">
              <img
                src={currentImage}
                className="max-w-[90%] max-h-[90%] w-auto h-auto object-contain rounded-lg shadow-2xl transition-transform duration-300"
                onClick={(e) => e.stopPropagation()}
                alt={`صورة ${validIndex + 1} من ${imagesArray.length}`}
                style={{
                  maxWidth: "90%",
                  maxHeight: "90%",
                  width: "auto",
                  height: "auto",
                  objectFit: "contain",
                }}
              />
            </div>

            {/* Next Button - Always show if more than 1 image */}
            {imagesArray.length > 1 && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onNext();
                }}
                className={`absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/10 hover:bg-white/20 text-white p-3 rounded-full transition-colors z-[110] ${
                  validIndex === imagesArray.length - 1
                    ? "opacity-50 cursor-not-allowed"
                    : ""
                }`}
                title="الصورة التالية (→)"
                disabled={validIndex === imagesArray.length - 1}
                style={{ zIndex: 110 }}
              >
                <ChevronLeft size={32} />
              </button>
            )}

            {/* Image Counter */}
            {imagesArray.length > 1 && (
              <div
                className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-full text-sm z-[110]"
                style={{ zIndex: 110 }}
              >
                {validIndex + 1} / {imagesArray.length}
              </div>
            )}

            {/* Close Button */}
            <button
              onClick={onClose}
              className="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white p-2 rounded-full transition-colors"
              title="إغلاق (ESC)"
            >
              <X size={24} />
            </button>
          </div>
        );
      };

      // --- Tag Cloud Component (Header) ---
      const TagCloud = ({ tags, selectedTags, onSelectTag }) => {
        const [isExpanded, setIsExpanded] = useState(false);
        const sortedTags = Object.entries(tags).sort((a, b) => b[1] - a[1]);

        if (sortedTags.length === 0) return null;

        return (
          <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 mb-6 transition-all duration-300">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-sm font-bold text-gray-500 flex items-center gap-2">
                <TagIcon size={16} /> استكشف المواضيع (اختر حتى 5)
              </h3>
              {selectedTags.length > 0 && (
                <button
                  onClick={() => onSelectTag(null, true)}
                  className="text-xs text-red-500 hover:underline"
                >
                  مسح الكل
                </button>
              )}
            </div>

            <div
              className={`flex flex-wrap gap-2 transition-all duration-500 ease-in-out ${
                isExpanded ? "max-h-[1000px]" : "max-h-[88px] overflow-hidden"
              }`}
            >
              {sortedTags.map(([tag, count]) => {
                const isSelected = selectedTags.includes(tag);
                return (
                  <button
                    key={tag}
                    onClick={() => onSelectTag(tag)}
                    className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 transition-all ${
                      isSelected
                        ? "bg-primary text-white shadow-lg scale-105"
                        : "bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600"
                    }`}
                  >
                    <span>#{tag}</span>
                    <span
                      className={`px-1.5 py-0.5 rounded-md text-[10px] ${
                        isSelected
                          ? "bg-white/20"
                          : "bg-gray-200 dark:bg-slate-800"
                      }`}
                    >
                      {count}
                    </span>
                  </button>
                );
              })}
            </div>

            {sortedTags.length > 10 && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="w-full mt-3 pt-2 border-t border-gray-100 dark:border-gray-700 text-xs font-bold text-primary flex items-center justify-center gap-1 hover:bg-gray-50 dark:hover:bg-slate-700/30 rounded-b-lg transition-colors"
              >
                {isExpanded ? (
                  <>
                    <span>عرض أقل</span> <ChevronUp size={14} />
                  </>
                ) : (
                  <>
                    <span>عرض المزيد ({sortedTags.length - 10}+)</span>{" "}
                    <ChevronDown size={14} />
                  </>
                )}
              </button>
            )}
          </div>
        );
      };

      // --- Single Post Tags Component ---
      const PostTags = ({ topics, onSelectTag }) => {
        const [isExpanded, setIsExpanded] = useState(false);

        if (!topics || topics.length === 0) return null;

        // Limit to 3 lines
        const VISIBLE_COUNT = 15;
        const showExpandButton = topics.length > VISIBLE_COUNT;
        const displayedTags = isExpanded
          ? topics
          : topics.slice(0, VISIBLE_COUNT);

        return (
          <div className="mb-4">
            <div className="flex flex-wrap gap-2">
              {displayedTags.map((tag, i) => (
                <span
                  key={i}
                  onClick={() => onSelectTag && onSelectTag(tag)}
                  className={`cursor-pointer px-3 py-1 bg-primary/10 text-primary text-xs font-bold rounded-full hover:bg-primary hover:text-white transition-colors`}
                >
                  #{tag}
                </span>
              ))}
            </div>
            {showExpandButton && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="mt-2 text-xs font-bold text-gray-500 hover:text-primary flex items-center gap-1"
              >
                {isExpanded ? (
                  <>
                    عرض أقل <ChevronUp size={12} />
                  </>
                ) : (
                  <>
                    عرض المزيد (+{topics.length - VISIBLE_COUNT}){" "}
                    <ChevronDown size={12} />
                  </>
                )}
              </button>
            )}
          </div>
        );
      };

      function App() {
        const [posts, setPosts] = useState([]);
        const [activePost, setActivePost] = useState(null);
        const [darkMode, setDarkMode] = useState(true);
        const [currentTheme, setCurrentTheme] = useState("midnight");
        const [showThemeMenu, setShowThemeMenu] = useState(false);
        const [showDisplayMenu, setShowDisplayMenu] = useState(false);

        // Image Zoom State
        const [zoomedImage, setZoomedImage] = useState(null);
        const [imageGallery, setImageGallery] = useState(null);
        const [currentImageIndex, setCurrentImageIndex] = useState(0);

        // Refs to keep latest state for handlers
        const imageGalleryRef = useRef(null);
        const currentImageIndexRef = useRef(0);

        // Update refs when state changes
        useEffect(() => {
          imageGalleryRef.current = imageGallery;
        }, [imageGallery]);

        useEffect(() => {
          currentImageIndexRef.current = currentImageIndex;
        }, [currentImageIndex]);

        // Pagination & Filter State
        const [lastDoc, setLastDoc] = useState(null);
        const [loading, setLoading] = useState(false);
        const [hasMore, setHasMore] = useState(true);
        const [selectedTags, setSelectedTags] = useState([]);

        // Tag Cloud State
        const [allTags, setAllTags] = useState({});

        // Copy Link State
        const [copiedPostId, setCopiedPostId] = useState(null);

        // Ref for content container
        const contentRef = useRef(null);

        useEffect(() => {
          const lightTheme = document.getElementById("hljs-light-theme");
          const darkTheme = document.getElementById("hljs-dark-theme");

          if (darkMode) {
            document.documentElement.classList.add("dark");
            // Switch to dark theme for code highlighting
            if (lightTheme) lightTheme.disabled = true;
            if (darkTheme) darkTheme.disabled = false;
          } else {
            document.documentElement.classList.remove("dark");
            // Switch to light theme for code highlighting
            if (lightTheme) lightTheme.disabled = false;
            if (darkTheme) darkTheme.disabled = true;
          }
        }, [darkMode]);

        // Auto-change theme based on dark mode
        useEffect(() => {
          if (darkMode) {
            setCurrentTheme("midnight");
          } else {
            setCurrentTheme("sepia");
          }
        }, [darkMode]);

        // Re-highlight code when dark mode changes
        useEffect(() => {
          if (activePost && contentRef.current) {
            setTimeout(() => {
              contentRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 150);
          }
        }, [darkMode, activePost]);

        // --- Click Handler for Images in Markdown ---
        useEffect(() => {
          const handleClick = (e) => {
            if (e.target.tagName === "IMG" && e.target.closest(".prose-rtl")) {
              setZoomedImage(e.target.src);
            }
          };

          document.addEventListener("click", handleClick);
          return () => document.removeEventListener("click", handleClick);
        }, []);

        // --- Close Display Menu when clicking outside ---
        useEffect(() => {
          const handleClickOutside = (e) => {
            if (showDisplayMenu && !e.target.closest("[data-display-menu]")) {
              setShowDisplayMenu(false);
            }
          };
          document.addEventListener("click", handleClickOutside);
          return () =>
            document.removeEventListener("click", handleClickOutside);
        }, [showDisplayMenu]);

        // --- Syntax Highlighting & Copy Button Injection ---
        useEffect(() => {
          if (activePost && contentRef.current) {
            // 1. Highlight Code (re-highlight when theme changes)
            setTimeout(() => {
              contentRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 100);

            // 2. Inject Copy Buttons
            contentRef.current.querySelectorAll("pre").forEach((preBlock) => {
              if (preBlock.querySelector(".copy-code-btn")) return;

              const button = document.createElement("button");
              button.className =
                "copy-code-btn absolute top-2 right-2 bg-gray-800/50 dark:bg-slate-700/50 hover:bg-gray-700 dark:hover:bg-slate-700 text-gray-200 dark:text-slate-300 p-1.5 rounded-md text-xs transition-all opacity-0 group-hover:opacity-100 z-10 flex items-center justify-center backdrop-blur-sm border border-gray-600/30 dark:border-white/10";
              button.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
              button.title = "نسخ الكود";

              button.addEventListener("click", () => {
                const code = preBlock.querySelector("code").innerText;
                navigator.clipboard.writeText(code).then(() => {
                  button.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
                  button.classList.add("text-green-500");
                  setTimeout(() => {
                    button.innerHTML =
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
                    button.classList.remove("text-green-500");
                  }, 2000);
                });
              });

              preBlock.classList.add("group");
              preBlock.appendChild(button);
            });
          }
        }, [activePost]);

        // --- URL Routing Logic ---
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          const idFromUrl = params.get("id");

          if (idFromUrl) {
            loadSinglePost(idFromUrl);
          }

          const handlePopState = () => {
            const newParams = new URLSearchParams(window.location.search);
            const newId = newParams.get("id");
            if (newId) loadSinglePost(newId);
            else setActivePost(null);
          };

          window.addEventListener("popstate", handlePopState);
          return () => window.removeEventListener("popstate", handlePopState);
        }, []);

        // --- Fetch Tags Stats ---
        useEffect(() => {
          db.collection("posts")
            .orderBy("createdAt", "desc")
            .limit(100)
            .get()
            .then((snapshot) => {
              const tagsMap = {};
              snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.topics && Array.isArray(data.topics)) {
                  data.topics.forEach((tag) => {
                    tagsMap[tag] = (tagsMap[tag] || 0) + 1;
                  });
                }
              });
              setAllTags(tagsMap);
            });
        }, []);

        // --- Helpers ---
        const updateUrl = (id) => {
          if (id) {
            window.history.pushState({ id }, "", `?id=${id}`);
          } else {
            window.history.pushState({}, "", window.location.pathname);
          }
        };

        const loadSinglePost = async (id) => {
          setLoading(true);
          try {
            const doc = await db.collection("posts").doc(id).get();
            if (doc.exists) {
              setActivePost({ id: doc.id, ...doc.data() });
            } else {
              updateUrl(null);
            }
          } catch (err) {
            console.error("Error loading post:", err);
          } finally {
            setLoading(false);
          }
        };

        const handlePostClick = (post) => {
          setActivePost(post);
          updateUrl(post.id);
        };

        const handleBackToList = () => {
          setActivePost(null);
          updateUrl(null);
        };

        // --- COPY LINK FUNCTION ---
        const handleCopyLink = (id, e) => {
          if (e) e.stopPropagation();
          const baseUrl =
            "https://mabdullah821.github.io/tech-stories-archive/viewer.html";
          const url = `${baseUrl}?id=${id}`;
          navigator.clipboard
            .writeText(url)
            .then(() => {
              setCopiedPostId(id);
              setTimeout(() => {
                setCopiedPostId(null);
              }, 2000);
            })
            .catch((err) => {
              console.error("Failed to copy: ", err);
            });
        };

        const handleTagSelection = (tag, reset = false) => {
          if (reset) {
            setSelectedTags([]);
            return;
          }

          if (selectedTags.includes(tag)) {
            setSelectedTags(selectedTags.filter((t) => t !== tag));
          } else {
            if (selectedTags.length < 5) {
              setSelectedTags([...selectedTags, tag]);
            } else {
              alert("يمكنك اختيار 5 مواضيع كحد أقصى.");
            }
          }
        };

        // --- Fetch List Posts Logic ---
        const fetchPosts = async (isNewFilter = false) => {
          if (loading || (!hasMore && !isNewFilter)) return;
          setLoading(true);

          try {
            let query = db.collection("posts");

            if (selectedTags.length > 0) {
              query = query.where("topics", "array-contains-any", selectedTags);
            }

            query = query.orderBy("createdAt", "desc");

            if (!isNewFilter && lastDoc) {
              query = query.startAfter(lastDoc);
            }

            query = query.limit(5);

            const snapshot = await query.get();

            if (snapshot.empty) {
              setHasMore(false);
              if (isNewFilter) setPosts([]);
            } else {
              const newPosts = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              setLastDoc(snapshot.docs[snapshot.docs.length - 1]);

              if (isNewFilter) {
                setPosts(newPosts);
              } else {
                setPosts((prev) => {
                  const existingIds = new Set(prev.map((p) => p.id));
                  const uniqueNewPosts = newPosts.filter(
                    (p) => !existingIds.has(p.id)
                  );
                  return [...prev, ...uniqueNewPosts];
                });
              }

              if (snapshot.docs.length < 5) setHasMore(false);
            }
          } catch (err) {
            console.error("Error fetching posts:", err);
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          if (!activePost) {
            setLastDoc(null);
            setHasMore(true);
            fetchPosts(true);
          }
        }, [selectedTags, activePost]);

        // Scroll Handler
        useEffect(() => {
          const handleScroll = () => {
            if (activePost) return;
            if (
              window.innerHeight + document.documentElement.scrollTop >=
              document.documentElement.offsetHeight - 100
            ) {
              fetchPosts(false);
            }
          };
          window.addEventListener("scroll", handleScroll);
          return () => window.removeEventListener("scroll", handleScroll);
        }, [lastDoc, loading, hasMore, activePost]);

        const renderMarkdown = (content) => {
          if (!content) return { __html: "" };
          // If content already contains HTML tags, use it directly
          // Otherwise parse as markdown
          if (
            content.includes("<div") ||
            content.includes("<img") ||
            content.includes("<a")
          ) {
            // Content already has HTML, process it to add click handlers for images
            let processedContent = content;

            // Process image groups with data-all-images attribute
            // Use simpler approach: just add data-image-group to divs that have data-all-images
            // The regex matches opening div tag with data-all-images attribute (using single quotes)
            let groupIndex = 0;

            // Match div opening tags with data-all-images='...' (single quotes contain JSON with double quotes)
            processedContent = processedContent.replace(
              /<div([^>]*)\s+data-all-images='([^']*)'([^>]*)>/g,
              (match, beforeAttr, allImagesJson, afterAttr) => {
                const groupId = `image-group-${groupIndex++}`;

                // Keep the original data-all-images and add data-image-group
                return `<div${beforeAttr} data-all-images='${allImagesJson}' data-image-group="${groupId}"${afterAttr}>`;
              }
            );

            // Also handle double quotes version (less common)
            processedContent = processedContent.replace(
              /<div([^>]*)\s+data-all-images="([^"]*)"([^>]*)>/g,
              (match, beforeAttr, allImagesJson, afterAttr) => {
                // Check if this div already has data-image-group (from previous replace)
                if (match.includes("data-image-group")) {
                  return match;
                }
                const groupId = `image-group-${groupIndex++}`;
                return `<div${beforeAttr} data-all-images="${allImagesJson}" data-image-group="${groupId}"${afterAttr}>`;
              }
            );

            // Also handle standalone images
            processedContent = processedContent.replace(
              /<img([^>]+)src="([^"]+)"([^>]*)>/g,
              (match, before, src, after) => {
                return `<img${before}src="${src}"${after} data-image-src="${src}" class="cursor-pointer">`;
              }
            );

            return { __html: processedContent };
          }
          return { __html: marked.parse(content) };
        };

        // Handlers for image gallery
        const handleImageClick = (images, index) => {
          // Ensure images is an array
          const imagesArray = Array.isArray(images)
            ? images
            : [images].filter(Boolean);
          if (imagesArray.length > 0) {
            setImageGallery(imagesArray);
            const validIndex = Math.max(
              0,
              Math.min(index, imagesArray.length - 1)
            );
            setCurrentImageIndex(validIndex);
          }
        };

        const handleNextImage = () => {
          const currentGallery = imageGalleryRef.current;
          const currentIndex = currentImageIndexRef.current;
          if (
            currentGallery &&
            Array.isArray(currentGallery) &&
            currentIndex < currentGallery.length - 1
          ) {
            setCurrentImageIndex(currentIndex + 1);
          }
        };

        const handlePrevImage = () => {
          const currentIndex = currentImageIndexRef.current;
          if (currentIndex > 0) {
            setCurrentImageIndex(currentIndex - 1);
          }
        };

        const handleCloseGallery = () => {
          setImageGallery(null);
          setCurrentImageIndex(0);
        };

        // Add click handlers to images after render
        useEffect(() => {
          if (!activePost) return;

          // Helper function to normalize URLs for comparison
          const normalizeUrl = (url) => {
            if (!url) return "";
            // Remove query parameters and fragments for comparison
            try {
              const urlObj = new URL(url, window.location.href);
              return urlObj.origin + urlObj.pathname;
            } catch {
              // If URL parsing fails, try to clean it manually
              return url.split("?")[0].split("#")[0];
            }
          };

          // Helper function to find image index in array - more flexible matching
          const findImageIndex = (imgSrc, imagesArray) => {
            if (!imgSrc || !imagesArray || imagesArray.length === 0) return -1;

            // Clean the source URL
            const cleanSrc = imgSrc.trim();

            // First try exact match (case-insensitive)
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              if (cleanSrc === img || cleanSrc === img.trim()) {
                return i;
              }
            }

            // Then try normalized comparison (without query params)
            const normalizedSrc = normalizeUrl(cleanSrc);
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              const normalizedImg = normalizeUrl(img);
              if (normalizedSrc === normalizedImg) {
                return i;
              }
            }

            // Try filename match (last part of URL)
            const srcFilename = cleanSrc
              .split("/")
              .pop()
              .split("?")[0]
              .split("#")[0];
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              const imgFilename = img
                .split("/")
                .pop()
                .split("?")[0]
                .split("#")[0];
              if (srcFilename && imgFilename && srcFilename === imgFilename) {
                return i;
              }
            }

            // Try if one URL contains the other (for relative vs absolute)
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              if (cleanSrc.includes(img) || img.includes(cleanSrc)) {
                return i;
              }
              const normalizedImg = normalizeUrl(img);
              if (
                normalizedSrc.includes(normalizedImg) ||
                normalizedImg.includes(normalizedSrc)
              ) {
                return i;
              }
            }

            return -1;
          };

          const handleClick = (e) => {
            // Find the clicked image (could be e.target itself or a parent)
            let clickedImg = null;
            if (e.target.tagName === "IMG") {
              clickedImg = e.target;
            } else {
              // Check if clicked on something inside an image (like overlay)
              clickedImg = e.target.closest("img");
            }

            // If we found an image, handle it
            if (clickedImg) {
              // Search for image group - try both data-image-group and data-all-images
              const imageGroup =
                clickedImg.closest("[data-image-group]") ||
                clickedImg.closest("[data-all-images]");

              if (imageGroup) {
                // Image is part of a group
                try {
                  // Try data-all-images first (original from writer), then data-images
                  let imagesJson =
                    imageGroup.getAttribute("data-all-images") ||
                    imageGroup.getAttribute("data-images");

                  if (imagesJson) {
                    // Handle HTML entities and quotes
                    const cleanedJson = imagesJson
                      .replace(/&#39;/g, "'")
                      .replace(/&quot;/g, '"')
                      .replace(/&amp;/g, "&");

                    let images;
                    try {
                      images = JSON.parse(cleanedJson);
                    } catch (parseErr) {
                      console.error("JSON parse error:", parseErr, cleanedJson);
                      return;
                    }

                    // Ensure images is an array
                    if (!Array.isArray(images) || images.length === 0) {
                      console.error("Invalid images array:", images);
                      return;
                    }

                    // Try multiple ways to get the image source
                    const imgSrc =
                      clickedImg.getAttribute("src") ||
                      clickedImg.getAttribute("data-image-src") ||
                      clickedImg.getAttribute("data-src") ||
                      clickedImg.currentSrc ||
                      clickedImg.src;

                    if (!imgSrc) {
                      console.error("Could not find image source");
                      return;
                    }

                    const index = findImageIndex(imgSrc, images);

                    if (index !== -1) {
                      // Found the image index - open gallery at that index
                      const imagesArray = Array.isArray(images)
                        ? images
                        : [images].filter(Boolean);
                      if (imagesArray.length > 0) {
                        setImageGallery(imagesArray);
                        const validIndex = Math.max(
                          0,
                          Math.min(index, imagesArray.length - 1)
                        );
                        setCurrentImageIndex(validIndex);
                      }
                      e.preventDefault();
                      e.stopPropagation();
                      return;
                    } else {
                      // If index not found, still open gallery with first image
                      // This can happen if URLs don't match exactly
                      const imagesArray = Array.isArray(images)
                        ? images
                        : [images].filter(Boolean);
                      if (imagesArray.length > 0) {
                        setImageGallery(imagesArray);
                        setCurrentImageIndex(0);
                      }
                      e.preventDefault();
                      e.stopPropagation();
                      return;
                    }
                  } else {
                    console.warn(
                      "No data-images or data-all-images attribute found"
                    );
                  }
                } catch (err) {
                  console.error("Error parsing image group:", err);
                }
              } else {
                // Standalone image
                const src =
                  clickedImg.getAttribute("data-image-src") ||
                  clickedImg.getAttribute("src") ||
                  clickedImg.getAttribute("data-src") ||
                  clickedImg.currentSrc ||
                  clickedImg.src;
                if (src) {
                  // Use the component-level handleImageClick
                  setImageGallery([src]);
                  setCurrentImageIndex(0);
                  e.preventDefault();
                  e.stopPropagation();
                  return;
                }
              }
            }

            // If no image was clicked, check if clicked on image group container
            const imageGroupContainer =
              e.target.closest("[data-image-group]") ||
              e.target.closest("[data-all-images]");
            if (imageGroupContainer && !clickedImg) {
              try {
                // Try data-all-images first (original from writer), then data-images
                let imagesJson =
                  imageGroupContainer.getAttribute("data-all-images") ||
                  imageGroupContainer.getAttribute("data-images");

                if (imagesJson) {
                  // Handle HTML entities and quotes
                  const cleanedJson = imagesJson
                    .replace(/&#39;/g, "'")
                    .replace(/&quot;/g, '"')
                    .replace(/&amp;/g, "&");

                  let images;
                  try {
                    images = JSON.parse(cleanedJson);
                  } catch (parseErr) {
                    console.error("JSON parse error:", parseErr, cleanedJson);
                    return;
                  }

                  // Ensure images is an array
                  if (Array.isArray(images) && images.length > 0) {
                    // Use the component-level handleImageClick
                    setImageGallery(images);
                    setCurrentImageIndex(0);
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                  } else {
                    console.error("Invalid images array:", images);
                  }
                } else {
                  console.warn(
                    "No data-images or data-all-images attribute found on container"
                  );
                }
              } catch (err) {
                console.error("Error parsing image group:", err);
              }
            }
          };

          const contentContainer = document.querySelector(".prose-rtl");
          if (contentContainer) {
            contentContainer.addEventListener("click", handleClick, true); // Use capture phase

            return () => {
              contentContainer.removeEventListener("click", handleClick, true);
            };
          }
        }, [activePost]);

        const handleEditPost = (post, e) => {
          e.stopPropagation();
          window.location.href = `writer.html?id=${post.id}`;
        };

        const handleCreateNew = () => {
          window.location.href = `writer.html`;
        };

        // --- Theme Classes ---
        const getThemeClass = () => {
          const theme = themes[currentTheme];
          return `${theme.bgLight} ${theme.bgDark} ${theme.className || ""}`;
        };

        // --- Single Post View ---
        if (activePost) {
          return (
            <div
              className={`min-h-screen pb-20 ${getThemeClass()} transition-colors duration-500`}
            >
              {/* Legacy single image modal */}
              {zoomedImage && (
                <ImageModal
                  images={[zoomedImage]}
                  currentIndex={0}
                  onClose={() => setZoomedImage(null)}
                  onNext={() => {}}
                  onPrev={() => {}}
                />
              )}

              {/* New image gallery modal */}
              {imageGallery && (
                <ImageModal
                  images={imageGallery}
                  currentIndex={currentImageIndex}
                  onClose={handleCloseGallery}
                  onNext={handleNextImage}
                  onPrev={handlePrevImage}
                />
              )}

              {/* Header Overlay for Single Post */}
              <header className="fixed top-0 z-50 w-full p-4 pointer-events-none">
                <div className="max-w-4xl mx-auto flex justify-between items-center pointer-events-auto">
                  <button
                    onClick={handleBackToList}
                    className="p-2 rounded-full bg-white/80 dark:bg-black/50 backdrop-blur-md shadow-sm transition-colors flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-white hover:bg-white dark:hover:bg-black/70 border border-gray-200 dark:border-transparent"
                    title="العودة للقائمة"
                  >
                    <ArrowRight size={18} />{" "}
                    <span className="hidden sm:inline">عودة</span>
                  </button>
                  <div className="flex gap-2 items-center">
                    {/* Desktop Display Settings - تظهر فقط على الشاشات الكبيرة */}
                    <div className="hidden md:flex gap-2 items-center">
                      <div className="relative">
                        <button
                          onClick={() => setShowThemeMenu(!showThemeMenu)}
                          className="p-2 rounded-full bg-white/80 dark:bg-black/50 backdrop-blur-md shadow-sm transition-colors border border-gray-200 dark:border-transparent"
                          title="تغيير المظهر"
                        >
                          <Palette size={20} />
                        </button>
                        {showThemeMenu && (
                          <div className="absolute top-12 left-0 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-[100] flex flex-col gap-1">
                            {Object.entries(themes).map(([key, t]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setCurrentTheme(key);
                                  setShowThemeMenu(false);
                                }}
                                className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                  currentTheme === key
                                    ? "text-primary font-bold"
                                    : ""
                                }`}
                              >
                                {t.name}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                      <button
                        onClick={() => setDarkMode(!darkMode)}
                        className="p-2 rounded-full bg-white/80 dark:bg-black/50 backdrop-blur-md shadow-sm transition-colors border border-gray-200 dark:border-transparent"
                        title={darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                      >
                        {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                      </button>
                    </div>

                    {/* Mobile Display Settings Button - يظهر فقط على الشاشات الصغيرة */}
                    <div className="relative md:hidden" data-display-menu>
                      <button
                        onClick={() => setShowDisplayMenu(!showDisplayMenu)}
                        className="p-2 rounded-full bg-white/80 dark:bg-black/50 backdrop-blur-md shadow-sm transition-colors border border-gray-200 dark:border-transparent"
                        title="إعدادات المظهر"
                      >
                        <Layout size={20} />
                      </button>
                      {showDisplayMenu && (
                        <div
                          className="absolute top-12 left-0 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-3 z-[100] flex flex-col gap-2"
                          data-display-menu
                        >
                          <div className="flex items-center gap-2 px-2 py-1 border-b border-gray-200 dark:border-gray-700 mb-1">
                            <Layout size={16} />
                            <span className="text-xs font-bold text-gray-500">
                              إعدادات المظهر
                            </span>
                          </div>
                          <button
                            onClick={() => setDarkMode(!darkMode)}
                            className="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-right"
                          >
                            <span className="font-bold text-sm">
                              {darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                            </span>
                            {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                          </button>
                          <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                          <div>
                            <div className="text-xs font-bold text-gray-500 px-2 py-1 mb-1">
                              السمات
                            </div>
                            <div className="flex flex-col gap-1">
                              {Object.entries(themes).map(([key, t]) => (
                                <button
                                  key={key}
                                  onClick={() => {
                                    setCurrentTheme(key);
                                    setShowDisplayMenu(false);
                                  }}
                                  className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-between ${
                                    currentTheme === key
                                      ? "text-primary font-bold bg-primary/10"
                                      : ""
                                  }`}
                                >
                                  <span>{t.name}</span>
                                  {currentTheme === key && <Check size={14} />}
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </header>

              {activePost.coverImage && (
                <div className="w-full h-64 md:h-96 relative">
                  <img
                    src={activePost.coverImage}
                    className="w-full h-full object-cover"
                    onClick={() => setZoomedImage(activePost.coverImage)}
                  />
                  <div className="absolute inset-0 bg-gradient-to-t from-gray-50/100 dark:from-dark to-transparent pointer-events-none"></div>
                </div>
              )}

              <div
                className={`max-w-3xl mx-auto px-4 ${
                  activePost.coverImage ? "-mt-20 relative z-10" : "pt-24"
                }`}
              >
                <article className="animate-fade-in bg-white/90 dark:bg-slate-800/90 p-6 md:p-8 rounded-2xl shadow-sm backdrop-blur-md relative group border border-gray-100 dark:border-gray-700">
                  {/* Action Buttons */}
                  <div className="absolute top-4 left-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-50">
                    <button
                      onClick={(e) => handleCopyLink(activePost.id, e)}
                      className={`p-2 rounded-full shadow-lg transition-all duration-300 ${
                        copiedPostId === activePost.id
                          ? "bg-green-500 text-white scale-110"
                          : "bg-white text-gray-700 hover:bg-gray-100 hover:scale-110"
                      }`}
                      title={
                        copiedPostId === activePost.id
                          ? "تم النسخ!"
                          : "نسخ رابط المقال"
                      }
                    >
                      {copiedPostId === activePost.id ? (
                        <Check size={18} />
                      ) : (
                        <LinkIcon size={18} />
                      )}
                    </button>
                    <button
                      onClick={(e) => handleEditPost(activePost, e)}
                      className="bg-primary text-white p-2 rounded-full shadow-lg hover:bg-emerald-600 transition-transform hover:scale-110"
                      title="تعديل هذا المقال"
                    >
                      <Edit size={18} />
                    </button>
                  </div>

                  <div className="mb-8 border-b border-gray-100 dark:border-gray-700 pb-6">
                    <PostTags
                      topics={activePost.topics}
                      onSelectTag={(tag) => {
                        setActivePost(null);
                        handleTagSelection(tag, true);
                        handleTagSelection(tag);
                      }}
                    />
                    <h1 className="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white leading-tight mb-4">
                      {activePost.title}
                    </h1>
                    <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                      <span>
                        {activePost.createdAt
                          ? new Date(
                              activePost.createdAt.toDate()
                            ).toLocaleDateString("ar-EG")
                          : "غير معروف"}
                      </span>
                      <span>•</span>
                      <span>قراءة ممتعة ☕</span>
                    </div>
                  </div>
                  <div
                    ref={contentRef}
                    className="prose-rtl"
                    dangerouslySetInnerHTML={renderMarkdown(activePost.content)}
                  />
                </article>
              </div>
            </div>
          );
        }

        // --- List View ---
        return (
          <div
            className={`min-h-screen ${getThemeClass()} transition-colors duration-500`}
          >
            <header className="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-gray-200 dark:border-slate-800 transition-colors">
              <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <h1
                  className="text-xl font-bold text-primary cursor-pointer"
                  onClick={() => {
                    setSelectedTags([]);
                    window.scrollTo(0, 0);
                  }}
                >
                  حكاوي واحد غاوي
                </h1>
                <div className="flex gap-2 items-center">
                  <button
                    onClick={handleCreateNew}
                    className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors text-primary border border-gray-200 dark:border-transparent"
                    title="إنشاء مقال جديد"
                  >
                    <PlusCircle size={20} />
                  </button>

                  {/* Desktop Display Settings - تظهر فقط على الشاشات الكبيرة */}
                  <div className="hidden md:flex gap-2 items-center">
                    <div className="relative">
                      <button
                        onClick={() => setShowThemeMenu(!showThemeMenu)}
                        className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-transparent"
                        title="السمات"
                      >
                        <Palette size={20} />
                      </button>
                      {showThemeMenu && (
                        <div className="absolute top-12 left-0 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-[100] flex flex-col gap-1">
                          {Object.entries(themes).map(([key, t]) => (
                            <button
                              key={key}
                              onClick={() => {
                                setCurrentTheme(key);
                                setShowThemeMenu(false);
                              }}
                              className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                currentTheme === key
                                  ? "text-primary font-bold"
                                  : ""
                              }`}
                            >
                              {t.name}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    <button
                      onClick={() => setDarkMode(!darkMode)}
                      className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-transparent"
                      title={darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                    >
                      {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                    </button>
                  </div>

                  {/* Mobile Display Settings Button - يظهر فقط على الشاشات الصغيرة */}
                  <div className="relative md:hidden" data-display-menu>
                    <button
                      onClick={() => setShowDisplayMenu(!showDisplayMenu)}
                      className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-transparent"
                      title="إعدادات المظهر"
                    >
                      <Layout size={20} />
                    </button>
                    {showDisplayMenu && (
                      <div
                        className="absolute top-12 left-0 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-3 z-[100] flex flex-col gap-2"
                        data-display-menu
                      >
                        <div className="flex items-center gap-2 px-2 py-1 border-b border-gray-200 dark:border-gray-700 mb-1">
                          <Layout size={16} />
                          <span className="text-xs font-bold text-gray-500">
                            إعدادات المظهر
                          </span>
                        </div>
                        <button
                          onClick={() => setDarkMode(!darkMode)}
                          className="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-right"
                        >
                          <span className="font-bold text-sm">
                            {darkMode ? "الوضع الفاتح" : "الوضع الداكن"}
                          </span>
                          {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                        </button>
                        <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                        <div>
                          <div className="text-xs font-bold text-gray-500 px-2 py-1 mb-1">
                            السمات
                          </div>
                          <div className="flex flex-col gap-1">
                            {Object.entries(themes).map(([key, t]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setCurrentTheme(key);
                                  setShowDisplayMenu(false);
                                }}
                                className={`text-right px-3 py-2 text-sm rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center justify-between ${
                                  currentTheme === key
                                    ? "text-primary font-bold bg-primary/10"
                                    : ""
                                }`}
                              >
                                <span>{t.name}</span>
                                {currentTheme === key && <Check size={14} />}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>

            <main className="max-w-4xl mx-auto px-4 py-8">
              {/* Tag Cloud Section */}
              {!activePost && (
                <TagCloud
                  tags={allTags}
                  selectedTags={selectedTags}
                  onSelectTag={handleTagSelection}
                />
              )}

              <div className="grid gap-6">
                {posts.map((post) => (
                  <div
                    key={post.id}
                    onClick={() => handlePostClick(post)}
                    className="group bg-white/90 dark:bg-slate-800/90 rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 dark:border-slate-700 overflow-hidden flex flex-col md:flex-row h-auto md:h-52 relative backdrop-blur-sm"
                  >
                    {/* Action Buttons in List View */}
                    <div className="absolute top-3 left-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                      <button
                        onClick={(e) => handleCopyLink(post.id, e)}
                        className={`p-2 rounded-full shadow-sm transition-all duration-300 ${
                          copiedPostId === post.id
                            ? "bg-green-500 text-white scale-110"
                            : "bg-white/90 dark:bg-black/50 hover:bg-gray-200 dark:hover:bg-gray-700"
                        }`}
                        title={
                          copiedPostId === post.id ? "تم النسخ!" : "نسخ الرابط"
                        }
                      >
                        {copiedPostId === post.id ? (
                          <Check size={16} />
                        ) : (
                          <LinkIcon size={16} />
                        )}
                      </button>
                      <button
                        onClick={(e) => handleEditPost(post, e)}
                        className="bg-white/90 dark:bg-black/50 p-2 rounded-full shadow-sm hover:bg-primary hover:text-white transition-colors"
                        title="تعديل سريع"
                      >
                        <Edit size={16} />
                      </button>
                    </div>

                    {post.coverImage && (
                      <div className="md:w-1/3 h-48 md:h-full overflow-hidden shrink-0">
                        <img
                          src={post.coverImage}
                          className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                          loading="lazy"
                        />
                      </div>
                    )}
                    <div className="p-6 flex-1 flex flex-col justify-center">
                      <h2 className="text-2xl font-bold mb-3 text-slate-900 dark:text-white group-hover:text-primary transition-colors line-clamp-2">
                        {post.title}
                      </h2>
                      <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mb-4">
                        {post.excerpt}
                      </p>
                      <div className="mt-auto w-full flex justify-between items-center">
                        <div className="flex gap-1 overflow-hidden max-w-[70%]">
                          {post.topics?.slice(0, 3).map((t, i) => (
                            <span
                              key={i}
                              className="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded font-bold whitespace-nowrap"
                            >
                              #{t}
                            </span>
                          ))}
                          {post.topics?.length > 3 && (
                            <span className="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 px-2 py-0.5 rounded font-bold">
                              +{post.topics.length - 3}
                            </span>
                          )}
                        </div>
                        <div className="text-xs text-gray-400 font-medium">
                          {post.createdAt
                            ? new Date(
                                post.createdAt.toDate()
                              ).toLocaleDateString("ar-EG")
                            : "الآن"}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {loading && (
                <div className="col-span-full flex justify-center py-8">
                  <LoaderIcon className="animate-spin text-primary" size={32} />
                </div>
              )}
              {!hasMore && posts.length > 0 && (
                <div className="col-span-full text-center text-gray-500 py-8 text-sm opacity-50">
                  -- تم عرض جميع المقالات --
                </div>
              )}
              {!loading && posts.length === 0 && (
                <div className="col-span-full text-center py-20 text-gray-500 bg-white/50 dark:bg-slate-800/50 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 backdrop-blur-sm">
                  لا توجد مقالات لعرضها حالياً.
                </div>
              )}
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
    <!-- Styles are now loaded from shared-styles.css -->
    <style>
      /* Viewer-specific styles only */
    </style>
  </body>
</html>
