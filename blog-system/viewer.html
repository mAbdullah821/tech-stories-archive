<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>حكاوي واحد غاوي</title>
    <meta
      name="description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />

    <!-- Open Graph / Facebook / Discord / Slack -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Tech Stories Archive" />
    <meta
      property="og:url"
      content="https://mabdullah821.github.io/tech-stories-archive/viewer.html"
    />
    <meta property="og:title" content="حكاوي واحد غاوي" />
    <meta
      property="og:description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />
    <meta
      property="og:image"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />
    <meta
      property="og:image:secure_url"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta
      property="og:image:alt"
      content="حكاوي واحد غاوي - ارشيف حكاوي واحد غاوي"
    />
    <meta property="og:locale" content="ar_EG" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="حكاوي واحد غاوي" />
    <meta
      name="twitter:description"
      content="ارشيف حكاوي واحد غاوي - رحلة في كواليس البرمجه وتجارب الBackend"
    />
    <meta
      name="twitter:image"
      content="https://i.ibb.co/zHTCX63W/Gemini-Generated-Image-3fa5kg3fa5kg3fa-1.jpg"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@300;400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Highlight.js CSS for Code Coloring -->
    <link
      id="hljs-light-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css"
    />
    <link
      id="hljs-dark-theme"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
      disabled
    />
    <!-- 
      ⚠️ SHARED STYLES - منسوخ من shared-styles.css
      المرجع الرئيسي: shared-styles.css
      عند التعديل: عدّل أولاً في shared-styles.css ثم انسخ المحتوى هنا
    -->
    <style>
      /**
       * Shared Styles for Blog System
       * This file contains all shared CSS between viewer.html and writer.html
       * to ensure consistent preview/display across both applications.
       * 
       * Version: 1.0
       */

      /* ============================================
         HIDE DEFAULT SCROLLBAR
         إخفاء شريط التمرير الافتراضي للمتصفح
         ============================================ */
      html {
        /* Hide scrollbar for Firefox */
        scrollbar-width: none;
        /* Hide scrollbar for IE and Edge */
        -ms-overflow-style: none;
      }

      html::-webkit-scrollbar {
        /* Hide scrollbar for Chrome, Safari, and Opera */
        display: none;
        width: 0;
        height: 0;
      }

      body {
        /* Hide scrollbar for Firefox */
        scrollbar-width: none;
        /* Hide scrollbar for IE and Edge */
        -ms-overflow-style: none;
      }

      body::-webkit-scrollbar {
        /* Hide scrollbar for Chrome, Safari, and Opera */
        display: none;
        width: 0;
        height: 0;
      }

      /* ============================================
         ANIMATIONS
         ============================================ */
      .animate-fade-in {
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Toast Notification Animation */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }

      @keyframes slideOut {
        from {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        to {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
      }

      /* Gift Bounce Animation - قفزة خفيفة للهدية */
      @keyframes gentleBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-4px); /* قفزة خفيفة جداً */
        }
      }

      .animate-gentle-bounce {
        animation: gentleBounce 1s ease-in-out infinite;
      }

      /* Clap Animation - تأثير التصفيق العائم */
      @keyframes floatUpFade {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1) rotate(0deg);
        }
        100% {
          opacity: 0;
          transform: translateY(-60px) scale(1.5) rotate(-20deg);
        }
      }

      .animate-float-clap {
        animation: floatUpFade 0.8s ease-out forwards;
        position: absolute;
        pointer-events: none; /* عشان الضغطات المتتالية متتعطلش */
      }

      .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
      }

      .toast-exit {
        animation: slideOut 0.3s ease-in forwards;
      }

      /* ============================================
         PROSE RTL - Typography for Markdown Content
         ============================================ */
      .prose-rtl {
        direction: rtl;
        text-align: right;
        line-height: 1.8;
        color: #334155;
      }

      .dark .prose-rtl {
        color: #cbd5e1;
      }

      /* Headers */
      .prose-rtl h1,
      .prose-rtl h2,
      .prose-rtl h3 {
        color: #0f172a;
        font-weight: 800;
        margin-top: 1.5em;
        margin-bottom: 0.8em;
      }

      .dark .prose-rtl h1,
      .dark .prose-rtl h2,
      .dark .prose-rtl h3 {
        color: #f8fafc;
      }

      .prose-rtl h1 {
        font-size: 1.75em;
      }

      .prose-rtl h2 {
        font-size: 1.25em;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.5em;
      }

      .dark .prose-rtl h2 {
        border-color: #334155;
      }

      .prose-rtl h3 {
        font-size: 1.1em;
      }

      /* Post Title - matches H1 size */
      .post-title {
        font-size: 1.75em !important;
        font-weight: 800;
        color: #0f172a;
        margin-top: 1.5em;
        margin-bottom: 0.8em;
      }

      .dark .post-title {
        color: #f8fafc;
      }

      /* Paragraphs */
      .prose-rtl p {
        margin-bottom: 1.2em;
      }

      /* Lists */
      .prose-rtl ul {
        list-style-type: disc;
        padding-right: 1.5em;
        margin-bottom: 1.2em;
      }

      .prose-rtl ol {
        list-style-type: decimal;
        padding-right: 1.5em;
        margin-bottom: 1.2em;
      }

      /* Blockquotes */
      .prose-rtl blockquote {
        border-right: 4px solid #10b981;
        padding-right: 1em;
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5em;
        font-style: italic;
      }

      .dark .prose-rtl blockquote {
        background: #1e293b;
        border-color: #34d399;
      }

      /* Images */
      .prose-rtl img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem auto;
        display: block;
        cursor: zoom-in;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .prose-rtl img:hover {
        transform: scale(1.01);
      }

      /* Images inside flex containers should not have auto margins */
      .prose-rtl .flex img {
        margin: 0;
      }

      /* ============================================
         FLEX LAYOUT UTILITIES
         ============================================ */
      .prose-rtl .flex {
        display: flex;
      }

      .prose-rtl .flex-wrap {
        flex-wrap: wrap;
      }

      .prose-rtl .flex-row {
        flex-direction: row;
      }

      .prose-rtl .flex-col {
        flex-direction: column;
      }

      .prose-rtl .gap-2 {
        gap: 0.5rem;
      }

      .prose-rtl .gap-3 {
        gap: 0.75rem;
      }

      .prose-rtl .gap-4 {
        gap: 1rem;
      }

      .prose-rtl .items-center {
        align-items: center;
      }

      .prose-rtl .justify-center {
        justify-content: center;
      }

      .prose-rtl .flex-shrink-0 {
        flex-shrink: 0;
      }

      .prose-rtl .flex-shrink-0 img {
        margin: 0;
        max-width: 300px;
        display: block;
      }

      .prose-rtl .mx-2 {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
      }

      .prose-rtl .flex-row img {
        max-width: 300px;
        max-height: 400px;
      }

      .prose-rtl .flex-col img {
        max-width: 100%;
        max-height: 400px;
      }

      /* ============================================
         GRID LAYOUT FOR IMAGES
         ============================================ */
      .prose-rtl .grid {
        display: grid;
        gap: 0.5rem;
      }

      .prose-rtl .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      .prose-rtl .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .prose-rtl .grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .prose-rtl .grid img {
        margin: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Smaller images for inline layout */
      .prose-rtl .grid.grid-cols-3 img {
        max-height: 120px !important;
        min-height: 80px !important;
      }

      .prose-rtl .grid.grid-cols-2 img {
        max-height: 120px !important;
        min-height: 80px !important;
      }

      .prose-rtl .grid.grid-cols-1 img {
        max-width: 100%;
      }

      /* Grid utilities */
      .prose-rtl .grid .relative {
        position: relative;
        cursor: pointer;
      }

      .prose-rtl .grid .absolute {
        position: absolute;
      }

      .prose-rtl .grid .inset-0 {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .prose-rtl .grid .bg-black\/60 {
        background-color: rgba(0, 0, 0, 0.6);
        pointer-events: auto;
        cursor: pointer;
      }

      .prose-rtl .grid .flex {
        display: flex;
      }

      .prose-rtl .grid .items-center {
        align-items: center;
      }

      .prose-rtl .grid .justify-center {
        justify-content: center;
      }

      .prose-rtl .grid .text-white {
        color: white;
      }

      .prose-rtl .grid .text-2xl {
        font-size: 1.5rem;
        line-height: 2rem;
      }

      .prose-rtl .grid .font-bold {
        font-weight: 700;
      }

      .prose-rtl .grid .w-full {
        width: 100%;
      }

      .prose-rtl .grid .h-full {
        height: 100%;
      }

      .prose-rtl .grid .object-cover {
        object-fit: cover;
      }

      .prose-rtl .grid .rounded-lg {
        border-radius: 0.5rem;
      }

      .prose-rtl .grid .cursor-zoom-in {
        cursor: zoom-in;
      }

      .prose-rtl .grid .border {
        border-width: 1px;
      }

      .prose-rtl .grid .border-gray-200 {
        border-color: rgb(229 231 235);
      }

      .dark .prose-rtl .grid .border-gray-700 {
        border-color: rgb(55 65 81);
      }

      /* ============================================
         CODE BLOCK STYLING
         ============================================ */
      .prose-rtl :not(pre) > code {
        direction: ltr;
        display: inline-block;
        font-family: "Fira Code", monospace;
        background: #e2e8f0;
        color: #be185d;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
      }

      .dark .prose-rtl :not(pre) > code {
        background: #334155;
        color: #f472b6;
      }

      .prose-rtl pre {
        position: relative;
        direction: ltr;
        text-align: left;
        background: #fafafa !important;
        border: 1px solid #e5e7eb !important;
        padding: 1.5rem;
        border-radius: 0.75rem;
        overflow-x: auto;
        margin-bottom: 1.5em;
        font-family: "Fira Code", monospace;
        font-size: 0.9em;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .dark .prose-rtl pre {
        background: #282c34 !important;
        border: 1px solid #3e4451 !important;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3),
          0 1px 2px 0 rgba(0, 0, 0, 0.2);
      }

      .prose-rtl pre:hover .copy-code-btn {
        opacity: 1;
      }

      .prose-rtl pre code {
        background: transparent !important;
        color: inherit !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        display: inline;
        font-size: 100% !important;
      }

      /* ============================================
         LINK STYLING
         ============================================ */
      .prose-rtl a {
        color: #10b981;
        text-decoration: underline;
        font-weight: 500;
      }

      .prose-rtl a.no-underline {
        text-decoration: none !important;
      }

      .prose-rtl strong {
        color: #0f172a;
        font-weight: 700;
      }

      .dark .prose-rtl strong {
        color: #f1f5f9;
      }

      /* ============================================
         CUSTOM SCROLLBAR
         ============================================ */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
      }

      /* ============================================
         THEME-SPECIFIC TEXT COLORS
         Comfortable, readable colors matched to each theme
         ============================================ */

      /* ============================================
         PLAIN THEME - Clean & Simple
         ============================================ */
      .theme-plain .prose-rtl {
        color: #1e293b; /* Dark slate for excellent readability */
      }

      .dark .theme-plain .prose-rtl {
        color: #e2e8f0; /* Light slate - comfortable on dark */
      }

      .theme-plain .prose-rtl h1,
      .theme-plain .prose-rtl h2,
      .theme-plain .prose-rtl h3 {
        color: #0f172a; /* Very dark for headers */
      }

      .dark .theme-plain .prose-rtl h1,
      .dark .theme-plain .prose-rtl h2,
      .dark .theme-plain .prose-rtl h3 {
        color: #f1f5f9; /* Very light for headers */
      }

      .theme-plain .prose-rtl a {
        color: #10b981; /* Emerald green */
      }

      .dark .theme-plain .prose-rtl a {
        color: #34d399; /* Lighter emerald */
      }

      .theme-plain .prose-rtl blockquote {
        border-color: #10b981;
        color: #475569;
      }

      .dark .theme-plain .prose-rtl blockquote {
        border-color: #34d399;
        color: #94a3b8;
      }

      /* ============================================
         SEPIA THEME - Celestial Antiquity
         ============================================ */
      .theme-sepia .prose-rtl {
        color: #3e2723; /* Rich dark brown - comfortable on sepia paper */
      }

      .dark .theme-sepia .prose-rtl {
        color: #e6dcca; /* Starlight Cream - perfect for dark sepia */
      }

      .theme-sepia .prose-rtl h1,
      .theme-sepia .prose-rtl h2,
      .theme-sepia .prose-rtl h3 {
        color: #5d4037; /* Darker brown for headers */
        font-weight: 800; /* Bold like other themes */
      }

      .dark .theme-sepia .prose-rtl h1,
      .dark .theme-sepia .prose-rtl h2,
      .dark .theme-sepia .prose-rtl h3 {
        color: #cfa76e; /* Constellation Gold */
        font-weight: 800; /* Bold like other themes */
        border-color: rgba(207, 167, 110, 0.3);
      }

      .theme-sepia .prose-rtl h1 {
        border-bottom: 1px solid rgba(139, 90, 43, 0.3);
        padding-bottom: 20px;
        margin-bottom: 40px;
      }

      .dark .theme-sepia .prose-rtl h1 {
        border-bottom: 1px solid rgba(207, 167, 110, 0.3);
        padding-bottom: 20px;
        margin-bottom: 40px;
      }

      .theme-sepia .prose-rtl h2 {
        border-bottom: 1px solid rgba(139, 90, 43, 0.2);
        padding-bottom: 0.5em;
      }

      .dark .theme-sepia .prose-rtl h2 {
        border-bottom: 1px solid rgba(207, 167, 110, 0.2);
        padding-bottom: 0.5em;
      }

      .theme-sepia .prose-rtl a {
        color: #d97706; /* Amber-600 */
      }

      .dark .theme-sepia .prose-rtl a {
        color: #cfa76e; /* Constellation Gold */
      }

      .theme-sepia .prose-rtl a:hover {
        color: #b45309; /* Darker amber */
      }

      .dark .theme-sepia .prose-rtl a:hover {
        color: #e6dcca; /* Starlight Cream on hover */
      }

      .theme-sepia .prose-rtl blockquote {
        background: rgba(244, 236, 216, 0.5);
        border-color: rgba(217, 119, 6, 0.4);
        color: #5d4037;
      }

      .dark .theme-sepia .prose-rtl blockquote {
        background: rgba(38, 32, 29, 0.6); /* Paper Overlay */
        border-color: rgba(207, 167, 110, 0.4);
        color: #a89f91; /* Faded Ink */
      }

      /* Removed special card styling to match other themes - no double border */

      /* ============================================
         OCEAN THEME - Deep Blue Waters
         ============================================ */
      .theme-ocean .prose-rtl {
        color: #1e3a5f; /* Deep blue-gray - readable on light cyan */
      }

      .dark .theme-ocean .prose-rtl {
        color: #cffafe; /* Light cyan - comfortable on dark ocean */
      }

      .theme-ocean .prose-rtl h1,
      .theme-ocean .prose-rtl h2,
      .theme-ocean .prose-rtl h3 {
        color: #0c4a6e; /* Very dark cyan-blue */
      }

      .dark .theme-ocean .prose-rtl h1,
      .dark .theme-ocean .prose-rtl h2,
      .dark .theme-ocean .prose-rtl h3 {
        color: #67e8f9; /* Bright cyan */
      }

      .theme-ocean .prose-rtl h2 {
        border-color: rgba(6, 182, 212, 0.3);
      }

      .dark .theme-ocean .prose-rtl h2 {
        border-color: rgba(103, 232, 249, 0.3);
      }

      .theme-ocean .prose-rtl a {
        color: #0891b2; /* Cyan-600 */
      }

      .dark .theme-ocean .prose-rtl a {
        color: #22d3ee; /* Cyan-400 */
      }

      .theme-ocean .prose-rtl a:hover {
        color: #0e7490; /* Darker cyan */
      }

      .dark .theme-ocean .prose-rtl a:hover {
        color: #67e8f9; /* Brighter cyan */
      }

      .theme-ocean .prose-rtl blockquote {
        background: rgba(207, 250, 254, 0.3);
        border-color: rgba(6, 182, 212, 0.4);
        color: #164e63;
      }

      .dark .theme-ocean .prose-rtl blockquote {
        background: rgba(8, 47, 73, 0.4);
        border-color: rgba(34, 211, 238, 0.4);
        color: #a5f3fc;
      }

      /* ============================================
         FOREST THEME - Natural Green
         ============================================ */
      .theme-forest .prose-rtl {
        color: #1a3a2e; /* Deep green-gray - readable on light green */
      }

      .dark .theme-forest .prose-rtl {
        color: #d1fae5; /* Light emerald - comfortable on dark forest */
      }

      .theme-forest .prose-rtl h1,
      .theme-forest .prose-rtl h2,
      .theme-forest .prose-rtl h3 {
        color: #064e3b; /* Very dark emerald */
      }

      .dark .theme-forest .prose-rtl h1,
      .dark .theme-forest .prose-rtl h2,
      .dark .theme-forest .prose-rtl h3 {
        color: #6ee7b7; /* Bright emerald */
      }

      .theme-forest .prose-rtl h2 {
        border-color: rgba(16, 185, 129, 0.3);
      }

      .dark .theme-forest .prose-rtl h2 {
        border-color: rgba(110, 231, 183, 0.3);
      }

      .theme-forest .prose-rtl a {
        color: #059669; /* Emerald-600 */
      }

      .dark .theme-forest .prose-rtl a {
        color: #34d399; /* Emerald-400 */
      }

      .theme-forest .prose-rtl a:hover {
        color: #047857; /* Darker emerald */
      }

      .dark .theme-forest .prose-rtl a:hover {
        color: #6ee7b7; /* Brighter emerald */
      }

      .theme-forest .prose-rtl blockquote {
        background: rgba(209, 250, 229, 0.3);
        border-color: rgba(16, 185, 129, 0.4);
        color: #065f46;
      }

      .dark .theme-forest .prose-rtl blockquote {
        background: rgba(2, 44, 34, 0.4);
        border-color: rgba(52, 211, 153, 0.4);
        color: #a7f3d0;
      }

      /* ============================================
         MIDNIGHT THEME - Deep Purple Space
         ============================================ */
      .theme-midnight .prose-rtl {
        color: #312e81; /* Deep indigo - readable on light purple */
      }

      .dark .theme-midnight .prose-rtl {
        color: #e0e7ff; /* Light indigo - comfortable on dark space */
      }

      .theme-midnight .prose-rtl h1,
      .theme-midnight .prose-rtl h2,
      .theme-midnight .prose-rtl h3 {
        color: #1e1b4b; /* Very dark indigo */
      }

      .dark .theme-midnight .prose-rtl h1,
      .dark .theme-midnight .prose-rtl h2,
      .dark .theme-midnight .prose-rtl h3 {
        color: #a5b4fc; /* Bright indigo */
      }

      .theme-midnight .prose-rtl h2 {
        border-color: rgba(99, 102, 241, 0.3);
      }

      .dark .theme-midnight .prose-rtl h2 {
        border-color: rgba(165, 180, 252, 0.3);
      }

      .theme-midnight .prose-rtl a {
        color: #6366f1; /* Indigo-500 */
      }

      .dark .theme-midnight .prose-rtl a {
        color: #818cf8; /* Indigo-400 */
      }

      .theme-midnight .prose-rtl a:hover {
        color: #4f46e5; /* Darker indigo */
      }

      .dark .theme-midnight .prose-rtl a:hover {
        color: #a5b4fc; /* Brighter indigo */
      }

      .theme-midnight .prose-rtl blockquote {
        background: rgba(224, 231, 255, 0.3);
        border-color: rgba(99, 102, 241, 0.4);
        color: #4338ca;
      }

      .dark .theme-midnight .prose-rtl blockquote {
        background: rgba(10, 14, 39, 0.4);
        border-color: rgba(129, 140, 248, 0.4);
        color: #c7d2fe;
      }

      /* ============================================
         SIMPLE TEXT COLORS MODE
         ألوان بسيطة (درجات رمادية متدرجة) - غير مرتبطة بالثيم
         ============================================ */
      /* النص الأساسي - الوضع الفاتح */
      .text-simple-mode .prose-rtl {
        color: #2f2f2f !important; /* رمادي داكن متوسط - قيمة 0.18 */
      }

      /* النص الأساسي - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl {
        color: #d5d5d5 !important; /* رمادي فاتح متوسط - قيمة 0.83 */
      }

      /* العنوان الرئيسي h1 - الوضع الفاتح */
      .text-simple-mode .prose-rtl h1 {
        color: #0a0a0a !important; /* أسود تقريباً - قيمة 0.04 */
        font-weight: 800;
      }

      /* العنوان الرئيسي h1 - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl h1 {
        color: #fafafa !important; /* أبيض تقريباً - قيمة 0.98 */
        font-weight: 800;
      }

      /* العنوان h2 - الوضع الفاتح */
      .text-simple-mode .prose-rtl h2 {
        color: #1a1a1a !important; /* رمادي داكن جداً - قيمة 0.1 */
        font-weight: 800;
        border-color: #d1d5db !important; /* رمادي فاتح للحدود */
      }

      /* العنوان h2 - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl h2 {
        color: #eaeaea !important; /* رمادي فاتح جداً - قيمة 0.92 */
        font-weight: 800;
        border-color: #4b5563 !important; /* رمادي متوسط للحدود */
      }

      /* العنوان h3 - الوضع الفاتح */
      .text-simple-mode .prose-rtl h3 {
        color: #2a2a2a !important; /* رمادي داكن - قيمة 0.16 */
        font-weight: 800;
      }

      /* العنوان h3 - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl h3 {
        color: #dadada !important; /* رمادي فاتح - قيمة 0.85 */
        font-weight: 800;
      }

      /* الروابط - الوضع الفاتح */
      .text-simple-mode .prose-rtl a {
        color: #3a3a3a !important; /* رمادي متوسط - قيمة 0.23 */
        text-decoration: underline;
      }

      /* الروابط - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl a {
        color: #cacaca !important; /* رمادي متوسط - قيمة 0.79 */
      }

      /* الروابط عند التمرير - الوضع الفاتح */
      .text-simple-mode .prose-rtl a:hover {
        color: #1a1a1a !important; /* رمادي داكن جداً - قيمة 0.1 */
      }

      /* الروابط عند التمرير - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl a:hover {
        color: #eaeaea !important; /* رمادي فاتح جداً - قيمة 0.92 */
      }

      /* النص العريض - الوضع الفاتح */
      .text-simple-mode .prose-rtl strong {
        color: #1f1f1f !important; /* رمادي داكن - قيمة 0.12 */
      }

      /* النص العريض - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl strong {
        color: #e0e0e0 !important; /* رمادي فاتح - قيمة 0.88 */
      }

      /* الاقتباس - الوضع الفاتح */
      .text-simple-mode .prose-rtl blockquote {
        background: #f9fafb !important; /* رمادي فاتح جداً للخلفية */
        border-color: #d1d5db !important; /* رمادي فاتح للحدود */
        color: #3f3f3f !important; /* رمادي متوسط - قيمة 0.25 */
      }

      /* الاقتباس - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl blockquote {
        background: #1f2937 !important; /* رمادي داكن للخلفية */
        border-color: #4b5563 !important; /* رمادي متوسط للحدود */
        color: #c0c0c0 !important; /* رمادي متوسط - قيمة 0.75 */
      }

      /* الكود - الوضع الفاتح */
      .text-simple-mode .prose-rtl :not(pre) > code {
        background: #e5e7eb !important; /* رمادي فاتح للخلفية */
        color: #252525 !important; /* رمادي داكن - قيمة 0.15 */
      }

      /* الكود - الوضع الداكن */
      .dark .text-simple-mode .prose-rtl :not(pre) > code {
        background: #374151 !important; /* رمادي داكن للخلفية */
        color: #dadada !important; /* رمادي فاتح - قيمة 0.85 */
      }

      /* الفهرس (Table of Contents) - الوضع الفاتح */
      .text-simple-mode [class*="bg-gray-50"] h3 {
        color: #1f1f1f !important; /* رمادي داكن - قيمة 0.12 */
      }

      .dark .text-simple-mode [class*="bg-slate-800"] h3,
      .dark .text-simple-mode [class*="bg-slate-800/50"] h3 {
        color: #e0e0e0 !important; /* رمادي فاتح - قيمة 0.88 */
      }

      /* أزرار الفهرس في الوضع البسيط - الوضع الفاتح */
      .text-simple-mode [class*="bg-gray-50"] ul button {
        color: #353535 !important; /* رمادي متوسط - قيمة 0.21 */
      }

      .text-simple-mode [class*="bg-gray-50"] ul button:hover {
        color: #1a1a1a !important; /* رمادي داكن جداً - قيمة 0.1 */
        background-color: #f3f4f6 !important; /* خلفية رمادية فاتحة - مثل hover:bg-emerald-50 */
        border-color: #9ca3af !important; /* حدود رمادية - مثل hover:border-emerald-500 */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; /* ظل خفيف - مثل hover:shadow-sm */
      }

      /* أزرار الفهرس في الوضع البسيط - الوضع الداكن */
      .dark .text-simple-mode [class*="bg-slate-800"] ul button,
      .dark .text-simple-mode [class*="bg-slate-800/50"] ul button {
        color: #c5c5c5 !important; /* رمادي متوسط - قيمة 0.77 */
      }

      .dark .text-simple-mode [class*="bg-slate-800"] ul button:hover,
      .dark .text-simple-mode [class*="bg-slate-800/50"] ul button:hover {
        color: #eaeaea !important; /* رمادي فاتح جداً - قيمة 0.92 */
        background-color: rgba(
          55,
          65,
          81,
          0.3
        ) !important; /* خلفية رمادية داكنة شفافة - مثل dark:hover:bg-emerald-900/20 */
        border-color: #6b7280 !important; /* حدود رمادية - مثل dark:hover:border-emerald-400 */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important; /* ظل خفيف - مثل hover:shadow-sm */
      }

      /* ============================================
         THEMES - Tiny Stars in Colorful Space
         Very gentle drift - like floating in space
         Small stars with soft glow - peaceful & calming
         ============================================ */

      /* ---- Theme Base Setup ---- */
      .theme-modern,
      .theme-sepia,
      .theme-ocean,
      .theme-forest,
      .theme-midnight {
        position: relative;
        overflow: hidden;
      }

      /* ============================================
         PLAIN THEME - No Animation (for accessibility)
         ============================================ */
      .theme-plain {
        position: relative;
      }

      .theme-plain::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background-image: radial-gradient(
            circle,
            rgba(100, 116, 139, 0.15) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(148, 163, 184, 0.1) 1px, transparent 1px);
        background-size: 200px 200px, 300px 300px;
        /* No animation - static stars */
      }

      .dark .theme-plain::before {
        background-image: radial-gradient(
            circle,
            rgba(148, 163, 184, 0.5) 1.5px,
            transparent 1.5px
          ),
          radial-gradient(
            circle,
            rgba(203, 213, 225, 0.35) 1px,
            transparent 1px
          ),
          radial-gradient(
            circle,
            rgba(226, 232, 240, 0.25) 1px,
            transparent 1px
          );
        background-size: 200px 200px, 280px 280px, 350px 350px;
      }

      .theme-plain > * {
        position: relative;
        z-index: 1;
      }

      .theme-modern::before,
      .theme-sepia::before,
      .theme-ocean::before,
      .theme-forest::before,
      .theme-midnight::before {
        content: "";
        position: fixed;
        top: -100%;
        left: -100%;
        width: 400%;
        height: 400%;
        pointer-events: none;
        z-index: 0;
      }

      /* Ensure content appears above stars */
      .theme-modern > *,
      .theme-sepia > *,
      .theme-ocean > *,
      .theme-forest > *,
      .theme-midnight > * {
        position: relative;
        z-index: 1;
      }

      /* ============================================
         MODERN THEME - Emerald Stars
         ============================================ */
      .theme-modern::before {
        background-image: radial-gradient(
            circle,
            rgba(4, 120, 87, 1) 2px,
            transparent 2px
          ),
          radial-gradient(circle, rgba(5, 150, 105, 1) 1.5px, transparent 1.5px),
          radial-gradient(circle, rgba(16, 185, 129, 0.9) 1px, transparent 1px);
        background-size: 150px 150px, 200px 200px, 250px 250px;
        animation: stars-drift 500s linear infinite;
      }

      .dark .theme-modern::before {
        background-image: radial-gradient(
            circle,
            rgba(52, 211, 153, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(74, 222, 128, 0.6) 1px, transparent 1px);
        background-size: 200px 200px, 280px 280px;
      }

      /* ============================================
         SEPIA THEME - Golden Stars
         ============================================ */
      .theme-sepia::before {
        background-image: radial-gradient(
            circle,
            rgba(120, 53, 15, 1) 2px,
            transparent 2px
          ),
          radial-gradient(circle, rgba(146, 64, 14, 1) 1.5px, transparent 1.5px),
          radial-gradient(circle, rgba(180, 83, 9, 0.9) 1px, transparent 1px);
        background-size: 160px 160px, 210px 210px, 260px 260px;
        animation: stars-rise 480s linear infinite;
      }

      .dark .theme-sepia::before {
        background-image: radial-gradient(
            circle,
            rgba(251, 191, 36, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(245, 158, 11, 0.6) 1px, transparent 1px);
        background-size: 190px 190px, 270px 270px;
        animation: stars-rise 480s linear infinite;
      }

      /* ============================================
         OCEAN THEME - Cyan Stars Rising
         ============================================ */
      .theme-ocean::before {
        background-image: radial-gradient(
            circle,
            rgba(8, 145, 178, 1) 2px,
            transparent 2px
          ),
          radial-gradient(
            circle,
            rgba(14, 116, 144, 1) 1.5px,
            transparent 1.5px
          ),
          radial-gradient(circle, rgba(6, 182, 212, 0.9) 1px, transparent 1px);
        background-size: 140px 140px, 190px 190px, 240px 240px;
        animation: stars-rise 480s linear infinite;
      }

      .dark .theme-ocean::before {
        background-image: radial-gradient(
            circle,
            rgba(34, 211, 238, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(103, 232, 249, 0.6) 1px, transparent 1px);
        background-size: 190px 190px, 270px 270px;
      }

      /* ============================================
         FOREST THEME - Green Stars
         ============================================ */
      .theme-forest::before {
        background-image: radial-gradient(
            circle,
            rgba(4, 120, 87, 1) 2px,
            transparent 2px
          ),
          radial-gradient(circle, rgba(5, 150, 105, 1) 1.5px, transparent 1.5px),
          radial-gradient(circle, rgba(16, 185, 129, 0.9) 1px, transparent 1px);
        background-size: 170px 170px, 220px 220px, 270px 270px;
        animation: stars-rise 480s linear infinite;
      }

      .dark .theme-forest::before {
        background-image: radial-gradient(
            circle,
            rgba(52, 211, 153, 0.85) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(110, 231, 183, 0.6) 1px, transparent 1px);
        background-size: 190px 190px, 270px 270px;
        animation: stars-rise 480s linear infinite;
      }

      /* ============================================
         MIDNIGHT THEME - White Stars in Purple Space
         ============================================ */
      .theme-midnight::before {
        background-image: radial-gradient(
            circle,
            rgba(79, 70, 229, 1) 2px,
            transparent 2px
          ),
          radial-gradient(
            circle,
            rgba(99, 102, 241, 1) 1.5px,
            transparent 1.5px
          ),
          radial-gradient(circle, rgba(139, 92, 246, 0.9) 1px, transparent 1px);
        background-size: 130px 130px, 180px 180px, 230px 230px;
        animation: stars-drift 450s linear infinite;
      }

      .dark .theme-midnight::before {
        background-image: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 1px,
            transparent 1px
          ),
          radial-gradient(circle, rgba(196, 181, 253, 0.6) 1px, transparent 1px);
        background-size: 180px 180px, 260px 260px;
      }

      /* ============================================
         ANIMATIONS - Seamless Infinite Drift
         Like floating peacefully in space forever
         ============================================ */

      /* Diagonal drift - NW to SE (seamless loop) */
      @keyframes stars-drift {
        from {
          transform: translate(0, 0);
        }
        to {
          transform: translate(25%, 25%);
        }
      }

      /* Rising drift - for ocean theme (seamless loop) */
      @keyframes stars-rise {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(-25%);
        }
      }

      /* ============================================
         TOAST NOTIFICATION
         ============================================ */
      .toast-notification {
        position: fixed;
        top: 5rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2),
          0 8px 10px -6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        pointer-events: none;
      }

      .toast-notification.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .toast-notification.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .toast-notification.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
      }

      /* ============================================
         FULLSCREEN PREVIEW MODE
         ============================================ */
      .fullscreen-preview {
        position: fixed;
        inset: 0;
        z-index: 100;
        overflow-y: auto;
      }

      .fullscreen-preview-close {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 110;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        border-radius: 9999px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .dark .fullscreen-preview-close {
        background: rgba(30, 41, 59, 0.9);
        border-color: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .fullscreen-preview-close:hover {
        transform: scale(1.1);
      }

      /* ============================================
         READING PROGRESS BAR
         ============================================ */
      .reading-progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
        z-index: 9999;
        transition: width 0.1s ease-out;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
      }

      .dark .reading-progress-bar {
        background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.5);
      }

      /* ============================================
         SKELETON LOADING
         ============================================ */
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 4px;
      }

      .dark .skeleton {
        background: linear-gradient(
          90deg,
          #334155 25%,
          #475569 50%,
          #334155 75%
        );
        background-size: 200% 100%;
      }

      @keyframes skeleton-loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .skeleton-post {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: auto;
      }

      .dark .skeleton-post {
        background: rgba(30, 41, 59, 0.9);
        border-color: #475569;
      }

      @media (min-width: 768px) {
        .skeleton-post {
          flex-direction: row;
          height: 208px;
        }
      }

      .skeleton-image {
        width: 100%;
        height: 192px;
        background: #f0f0f0;
      }

      .dark .skeleton-image {
        background: #475569;
      }

      @media (min-width: 768px) {
        .skeleton-image {
          width: 33.333333%;
          height: 100%;
        }
      }

      .skeleton-content {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .skeleton-title {
        height: 1.5rem;
        width: 80%;
        margin-bottom: 0.5rem;
      }

      .skeleton-title-short {
        height: 1.5rem;
        width: 60%;
      }

      .skeleton-text {
        height: 0.875rem;
        width: 100%;
      }

      .skeleton-text-short {
        height: 0.875rem;
        width: 70%;
      }

      .skeleton-tags {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }

      .skeleton-tag {
        height: 1.25rem;
        width: 4rem;
        border-radius: 9999px;
      }

      .skeleton-date {
        height: 0.75rem;
        width: 5rem;
        margin-right: 0.5rem;
      }

      /* === Single Post Skeleton Styles === */
      .skeleton-cover-box {
        width: 100%;
        height: 256px; /* h-64 equivalent */
      }
      @media (min-width: 768px) {
        .skeleton-cover-box {
          height: 384px; /* h-96 equivalent */
        }
      }
      .skeleton-article-body {
        max-width: 48rem; /* max-w-3xl */
        margin: 0 auto;
        padding: 2rem;
        background: white;
        border-radius: 1rem;
        position: relative;
        z-index: 10;
        margin-top: -3rem; /* Tweak based on design */
      }
      .dark .skeleton-article-body {
        background: #1e293b; /* dark:bg-slate-800 */
      }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Tajawal", "sans-serif"],
              mono: ["Fira Code", "monospace"],
            },
            colors: { primary: "#10b981", dark: "#0f172a" },
          },
        },
      };
    </script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Highlight.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>
  <body
    class="bg-gray-50 dark:bg-dark text-slate-800 dark:text-slate-100 transition-colors duration-300"
  >
    <!-- Reading Progress Bar - تم استبداله بشريط React -->
    <div
      id="reading-progress-bar"
      class="reading-progress-bar"
      style="display: none"
    ></div>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // --- Icons Definitions (SVG Components) ---
      const IconBase = ({
        children,
        size = 24,
        className = "",
        fill,
        strokeWidth = "2",
      }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill={fill || "none"}
          stroke="currentColor"
          strokeWidth={strokeWidth}
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {children}
        </svg>
      );

      const Sun = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="4" />
          <path d="M12 2v2" />
          <path d="M12 20v2" />
          <path d="m4.93 4.93 1.41 1.41" />
          <path d="m17.66 17.66 1.41 1.41" />
          <path d="M2 12h2" />
          <path d="M20 12h2" />
          <path d="m6.34 17.66-1.41-1.41" />
          <path d="m19.07 4.93-1.41 1.41" />
        </IconBase>
      );
      const Moon = (props) => (
        <IconBase {...props}>
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
        </IconBase>
      );
      const ArrowRight = (props) => (
        <IconBase {...props}>
          <path d="M5 12h14" />
          <path d="m12 5 7 7-7 7" />
        </IconBase>
      );
      const Home = (props) => (
        <IconBase {...props}>
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <path d="M9 22V12h6v10" />
        </IconBase>
      );
      const LoaderIcon = (props) => (
        <IconBase {...props}>
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </IconBase>
      );
      const X = (props) => (
        <IconBase {...props}>
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </IconBase>
      );
      const Edit = (props) => (
        <IconBase {...props}>
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
        </IconBase>
      );
      const TagIcon = (props) => (
        <IconBase {...props}>
          <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />
          <path d="M7 7h.01" />
        </IconBase>
      );
      const ChevronDown = (props) => (
        <IconBase {...props}>
          <path d="m6 9 6 6 6-6" />
        </IconBase>
      );
      const ChevronUp = (props) => (
        <IconBase {...props}>
          <path d="m18 15-6-6-6 6" />
        </IconBase>
      );
      const ChevronLeft = (props) => (
        <IconBase {...props}>
          <path d="m15 18-6-6 6-6" />
        </IconBase>
      );
      const ChevronRight = (props) => (
        <IconBase {...props}>
          <path d="m9 18 6-6-6-6" />
        </IconBase>
      );
      const PlusCircle = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="10" />
          <path d="M8 12h8" />
          <path d="M12 8v8" />
        </IconBase>
      );
      const Palette = (props) => (
        <IconBase {...props}>
          <circle cx="13.5" cy="6.5" r=".5" />
          <circle cx="17.5" cy="10.5" r=".5" />
          <circle cx="8.5" cy="7.5" r=".5" />
          <circle cx="6.5" cy="12.5" r=".5" />
          <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" />
        </IconBase>
      );
      const Type = (props) => (
        <IconBase {...props}>
          <polyline points="4 7 4 4 20 4 20 7" />
          <line x1="9" y1="20" x2="15" y2="20" />
          <line x1="12" y1="4" x2="12" y2="20" />
        </IconBase>
      );
      const ZoomIn = (props) => (
        <IconBase {...props}>
          <circle cx="11" cy="11" r="8" />
          <line x1="21" x2="16.65" y1="21" y2="16.65" />
          <line x1="11" x2="11" y1="8" y2="14" />
          <line x1="8" x2="14" y1="11" y2="11" />
        </IconBase>
      );
      const LinkIcon = (props) => (
        <IconBase {...props}>
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
        </IconBase>
      );
      const Copy = (props) => (
        <IconBase {...props}>
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
        </IconBase>
      );
      const Check = (props) => (
        <IconBase {...props}>
          <path d="M20 6 9 17l-5-5" />
        </IconBase>
      );
      const Layout = (props) => (
        <IconBase {...props}>
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
        </IconBase>
      );
      const Gift = (props) => (
        <IconBase {...props}>
          <path d="M20 12v10H4V12" />
          <path d="M2 7h20v5H2z" />
          <path d="M12 22V7" />
          <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" />
          <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" />
        </IconBase>
      );
      // أيقونة الساعة (لوقت القراءة)
      const Clock = (props) => (
        <IconBase {...props}>
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </IconBase>
      );
      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyAquezWzOJ5w5CZPuQFC01RxdGM2i9oYss",
        authDomain: "tech-stories-archive.firebaseapp.com",
        projectId: "tech-stories-archive",
        storageBucket: "tech-stories-archive.firebasestorage.app",
        messagingSenderId: "345367195836",
        appId: "1:345367195836:web:14719979eaad7bb43220b9",
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();
      const auth = firebase.auth(); // تعريف الـ Auth

      // --- Themes Configuration (Updated) ---
      const themes = {
        plain: {
          name: "بسيط",
          bgLight: "bg-gradient-to-br from-gray-50 to-gray-100",
          bgDark:
            "dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-800 dark:to-blue-950 dark:text-slate-100",
          accent: "text-primary",
          // 👇 الألوان الجديدة للشريط والهدية
          barColor: "bg-emerald-500",
          iconColor: "text-emerald-500",
          // 👇 ألوان الـ tags
          borderColor: "border-emerald-500",
          tagBgColor: "bg-emerald-500/10",
          tagTextColor: "text-emerald-500",
          tagHoverColor: "bg-emerald-500",
          className: "theme-plain",
        },
        sepia: {
          name: "ورقي (Sepia)",
          bgLight: "bg-[#f4ecd8] text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#2a2118] dark:via-[#3a2f25] dark:to-[#2f2620] dark:text-[#f4ecd8]",
          accent: "text-amber-600",
          // 👇 لون ذهبي/بني للورقي
          barColor: "bg-amber-600",
          iconColor: "text-amber-600",
          // 👇 ألوان الـ tags
          borderColor: "border-amber-600",
          tagBgColor: "bg-amber-600/10",
          tagTextColor: "text-amber-600",
          tagHoverColor: "bg-amber-600",
          className: "theme-sepia",
        },
        ocean: {
          name: "محيط (Ocean)",
          bgLight:
            "bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a1a2e] dark:via-[#0d2338] dark:to-[#0f1e3a] dark:text-cyan-100",
          accent: "text-cyan-500",
          // 👇 لون سماوي للمحيط
          barColor: "bg-cyan-500",
          iconColor: "text-cyan-500",
          // 👇 ألوان الـ tags
          borderColor: "border-cyan-500",
          tagBgColor: "bg-cyan-500/10",
          tagTextColor: "text-cyan-500",
          tagHoverColor: "bg-cyan-500",
          className: "theme-ocean",
        },
        forest: {
          name: "غابة (Forest)",
          bgLight:
            "bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a1f18] dark:via-[#0d2a20] dark:to-[#0f1f1a] dark:text-emerald-100",
          accent: "text-emerald-500",
          // 👇 لون أخضر للغابة
          barColor: "bg-emerald-600",
          iconColor: "text-emerald-500",
          // 👇 ألوان الـ tags
          borderColor: "border-emerald-600",
          tagBgColor: "bg-emerald-600/10",
          tagTextColor: "text-emerald-500",
          tagHoverColor: "bg-emerald-600",
          className: "theme-forest",
        },
        midnight: {
          name: "فضاء (Midnight)",
          bgLight:
            "bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 text-slate-800",
          bgDark:
            "dark:bg-gradient-to-br dark:from-[#0a0e27] dark:via-[#1a1b3a] dark:to-[#2d1b3d] dark:text-indigo-100",
          accent: "text-indigo-400",
          // 👇 لون بنفسجي للفضاء
          barColor: "bg-indigo-500",
          iconColor: "text-indigo-500",
          // 👇 ألوان الـ tags
          borderColor: "border-indigo-500",
          tagBgColor: "bg-indigo-500/10",
          tagTextColor: "text-indigo-500",
          tagHoverColor: "bg-indigo-500",
          className: "theme-midnight",
        },
      };

      // --- Image Lightbox Component ---
      const ImageModal = ({
        images,
        currentIndex,
        onClose,
        onNext,
        onPrev,
      }) => {
        // Ensure images is an array
        const imagesArray = Array.isArray(images)
          ? images
          : images
          ? [images]
          : [];
        if (!imagesArray || imagesArray.length === 0) return null;

        // Ensure currentIndex is valid
        const validIndex = Math.max(
          0,
          Math.min(currentIndex || 0, imagesArray.length - 1)
        );
        const currentImage = imagesArray[validIndex];

        useEffect(() => {
          if (!imagesArray || imagesArray.length === 0) return;

          const handleKeyDown = (e) => {
            // Only handle if modal is open and not typing in input
            if (
              e.target.tagName === "INPUT" ||
              e.target.tagName === "TEXTAREA" ||
              e.target.isContentEditable
            ) {
              return;
            }

            if (e.key === "Escape") {
              e.preventDefault();
              e.stopPropagation();
              onClose();
            } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              onNext();
            } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              onPrev();
            }
          };

          // Add event listener with capture phase for better priority
          window.addEventListener("keydown", handleKeyDown, true);

          return () => {
            window.removeEventListener("keydown", handleKeyDown, true);
          };
        }, [onClose, onNext, onPrev, validIndex, imagesArray]);

        return (
          <div
            className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm cursor-zoom-out"
            onClick={onClose}
          >
            {/* Previous Button - Always show if more than 1 image */}
            {imagesArray.length > 1 && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onPrev();
                }}
                className={`absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/10 hover:bg-white/20 text-white p-3 rounded-full transition-colors z-[110] ${
                  validIndex === 0 ? "opacity-50 cursor-not-allowed" : ""
                }`}
                title="الصورة السابقة (←)"
                disabled={validIndex === 0}
                style={{ zIndex: 110 }}
              >
                <ChevronRight size={32} />
              </button>
            )}

            {/* Image Container - Maintain aspect ratio with smaller size */}
            <div className="flex items-center justify-center w-full h-full p-8 relative z-[105]">
              <img
                src={currentImage}
                className="max-w-[90%] max-h-[90%] w-auto h-auto object-contain rounded-lg shadow-2xl transition-transform duration-300"
                onClick={(e) => e.stopPropagation()}
                alt={`صورة ${validIndex + 1} من ${imagesArray.length}`}
                style={{
                  maxWidth: "90%",
                  maxHeight: "90%",
                  width: "auto",
                  height: "auto",
                  objectFit: "contain",
                }}
              />
            </div>

            {/* Next Button - Always show if more than 1 image */}
            {imagesArray.length > 1 && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onNext();
                }}
                className={`absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/10 hover:bg-white/20 text-white p-3 rounded-full transition-colors z-[110] ${
                  validIndex === imagesArray.length - 1
                    ? "opacity-50 cursor-not-allowed"
                    : ""
                }`}
                title="الصورة التالية (→)"
                disabled={validIndex === imagesArray.length - 1}
                style={{ zIndex: 110 }}
              >
                <ChevronLeft size={32} />
              </button>
            )}

            {/* Image Counter */}
            {imagesArray.length > 1 && (
              <div
                className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-full text-sm z-[110]"
                style={{ zIndex: 110 }}
              >
                {validIndex + 1} / {imagesArray.length}
              </div>
            )}

            {/* Close Button */}
            <button
              onClick={onClose}
              className="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white p-2 rounded-full transition-colors"
              title="إغلاق (ESC)"
            >
              <X size={24} />
            </button>
          </div>
        );
      };

      // --- Tag Cloud Component (Updated for Mobile) ---
      const TagCloud = ({
        tags,
        selectedTags,
        onSelectTag,
        currentTheme,
        themes,
      }) => {
        const [isExpanded, setIsExpanded] = useState(false);
        const sortedTags = Object.entries(tags).sort((a, b) => b[1] - a[1]);

        if (sortedTags.length === 0) return null;

        // الحد الذي يظهر عنده زر "عرض المزيد"
        const THRESHOLD = 5;
        const showExpandButton = sortedTags.length > THRESHOLD;

        // الحصول على ألوان الثيم الحالي
        const theme = themes[currentTheme] || themes.midnight;

        // Mapping للـ hover classes لكل theme
        const hoverTextClasses = {
          plain: "hover:text-emerald-500",
          sepia: "hover:text-amber-600",
          ocean: "hover:text-cyan-500",
          forest: "hover:text-emerald-500",
          midnight: "hover:text-indigo-500",
        };

        return (
          <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 mb-6 transition-all duration-300">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-sm font-bold text-gray-500 flex items-center gap-2">
                <TagIcon size={16} /> استكشف المواضيع
              </h3>
              {selectedTags.length > 0 && (
                <button
                  onClick={() => onSelectTag(null, true)}
                  className="text-xs text-red-500 hover:underline"
                >
                  مسح الكل
                </button>
              )}
            </div>

            <div
              className={`flex flex-wrap gap-2 transition-all duration-500 ease-in-out ${
                isExpanded ? "max-h-[1000px]" : "max-h-[120px] overflow-hidden"
              }`}
            >
              {sortedTags.map(([tag, count]) => {
                const isSelected = selectedTags.includes(tag);

                // Mapping للـ hover classes لكل theme عند عدم الاختيار
                const hoverClasses = {
                  plain: "hover:bg-emerald-500 hover:text-white",
                  sepia: "hover:bg-amber-600 hover:text-white",
                  ocean: "hover:bg-cyan-500 hover:text-white",
                  forest: "hover:bg-emerald-600 hover:text-white",
                  midnight: "hover:bg-indigo-500 hover:text-white",
                };

                return (
                  <button
                    key={tag}
                    onClick={() => onSelectTag(tag)}
                    className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 transition-all border ${
                      isSelected
                        ? `${theme.tagHoverColor} text-white ${theme.borderColor} shadow-md scale-105`
                        : `${theme.tagBgColor} ${theme.tagTextColor} ${
                            theme.borderColor
                          }/30 ${
                            hoverClasses[currentTheme] || hoverClasses.midnight
                          }`
                    }`}
                  >
                    <span>#{tag}</span>
                    <span
                      className={`px-1.5 py-0.5 rounded-md text-[10px] ${
                        isSelected
                          ? "bg-white/20"
                          : "bg-gray-200 dark:bg-slate-800"
                      }`}
                    >
                      {count}
                    </span>
                  </button>
                );
              })}
            </div>

            {showExpandButton && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className={`w-full mt-3 pt-2 border-t border-gray-100 dark:border-gray-700 text-xs font-bold ${
                  theme.tagTextColor
                } flex items-center justify-center gap-1 hover:bg-gray-50 dark:hover:bg-slate-700/30 rounded-b-lg transition-colors ${
                  hoverTextClasses[currentTheme] || hoverTextClasses.midnight
                }`}
              >
                {isExpanded ? (
                  <>
                    <span>عرض أقل</span> <ChevronUp size={14} />
                  </>
                ) : (
                  <>
                    <span>عرض المزيد ({sortedTags.length - THRESHOLD}+)</span>{" "}
                    <ChevronDown size={14} />
                  </>
                )}
              </button>
            )}
          </div>
        );
      };

      // --- Single Post Tags Component ---
      const PostTags = ({ topics, onSelectTag, currentTheme, themes }) => {
        const [isExpanded, setIsExpanded] = useState(false);

        if (!topics || topics.length === 0) return null;

        // Limit to 3 lines
        const VISIBLE_COUNT = 15;
        const showExpandButton = topics.length > VISIBLE_COUNT;
        const displayedTags = isExpanded
          ? topics
          : topics.slice(0, VISIBLE_COUNT);

        // الحصول على ألوان الثيم الحالي
        const theme = themes[currentTheme] || themes.midnight;

        // Mapping للـ hover classes لكل theme
        const hoverClasses = {
          plain: "hover:bg-emerald-500",
          sepia: "hover:bg-amber-600",
          ocean: "hover:bg-cyan-500",
          forest: "hover:bg-emerald-600",
          midnight: "hover:bg-indigo-500",
        };

        const hoverTextClasses = {
          plain: "hover:text-emerald-500",
          sepia: "hover:text-amber-600",
          ocean: "hover:text-cyan-500",
          forest: "hover:text-emerald-500",
          midnight: "hover:text-indigo-500",
        };

        return (
          <div className="mb-4">
            <div className="flex flex-wrap gap-2">
              {displayedTags.map((tag, i) => (
                <span
                  key={i}
                  onClick={() => onSelectTag && onSelectTag(tag)}
                  className={`cursor-pointer px-3 py-1 ${theme.tagBgColor} ${
                    theme.tagTextColor
                  } text-xs font-bold rounded-full ${
                    hoverClasses[currentTheme] || hoverClasses.midnight
                  } hover:text-white transition-colors border ${
                    theme.borderColor
                  }/30`}
                >
                  #{tag}
                </span>
              ))}
            </div>
            {showExpandButton && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className={`mt-3 text-xs font-bold text-gray-500 dark:text-gray-400 ${
                  hoverTextClasses[currentTheme] || hoverTextClasses.midnight
                } flex items-center gap-1 transition-colors`}
              >
                {isExpanded ? (
                  <>
                    عرض أقل <ChevronUp size={12} />
                  </>
                ) : (
                  <>
                    عرض المزيد (+{topics.length - VISIBLE_COUNT}){" "}
                    <ChevronDown size={12} />
                  </>
                )}
              </button>
            )}
          </div>
        );
      };

      // --- Skeleton Loading Component ---
      const SkeletonPost = () => (
        <div className="skeleton-post">
          {/* Skeleton Image */}
          <div className="skeleton-image skeleton"></div>

          {/* Skeleton Content */}
          <div className="skeleton-content">
            {/* Title */}
            <div>
              <div className="skeleton skeleton-title"></div>
              <div className="skeleton skeleton-title-short mt-2"></div>
            </div>

            {/* Excerpt */}
            <div className="space-y-2">
              <div className="skeleton skeleton-text"></div>
              <div className="skeleton skeleton-text"></div>
              <div className="skeleton skeleton-text-short"></div>
            </div>

            {/* Tags and Date */}
            <div className="mt-auto flex justify-between items-center">
              <div className="skeleton-tags">
                <div className="skeleton skeleton-tag"></div>
                <div className="skeleton skeleton-tag"></div>
              </div>
              <div className="skeleton skeleton-date"></div>
            </div>
          </div>
        </div>
      );

      // --- Single Post Skeleton Component ---
      const SkeletonSinglePost = () => (
        <div className="min-h-screen pb-20 animate-fade-in">
          {/* Fake Header */}
          <div className="h-16 w-full bg-white/50 dark:bg-slate-900/50 border-b border-gray-200 dark:border-gray-700"></div>

          {/* Cover Image Skeleton */}
          <div className="skeleton skeleton-cover-box"></div>

          {/* Content Container Skeleton */}
          <div className="px-4">
            <div className="skeleton-article-body border border-gray-100 dark:border-gray-700 shadow-sm">
              {/* Meta Info (Date/Tags) */}
              <div className="flex gap-2 mb-6">
                <div className="skeleton h-6 w-20 rounded-full"></div>
                <div className="skeleton h-6 w-20 rounded-full"></div>
              </div>

              {/* Title Skeleton (Big & Multi-line) */}
              <div className="skeleton h-10 w-3/4 rounded-lg mb-4"></div>
              <div className="skeleton h-10 w-1/2 rounded-lg mb-8"></div>

              {/* Text Paragraphs Skeletons */}
              <div className="space-y-4">
                <div className="skeleton h-4 w-full rounded"></div>
                <div className="skeleton h-4 w-full rounded"></div>
                <div className="skeleton h-4 w-11/12 rounded"></div>
                <div className="skeleton h-4 w-full rounded"></div>
                <div className="skeleton h-4 w-4/5 rounded"></div>
                <br />
                <div className="skeleton h-4 w-full rounded"></div>
                <div className="skeleton h-4 w-full rounded"></div>
                <div className="skeleton h-4 w-3/4 rounded"></div>
              </div>
            </div>
          </div>
        </div>
      );

      function App() {
        const [posts, setPosts] = useState([]);
        const [activePost, setActivePost] = useState(null);
        // 👇 حالة لمعرفة هل الزائر هو المشرف أم لا
        const [isAdmin, setIsAdmin] = useState(false);
        // Table of Contents state
        const [tocItems, setTocItems] = useState([]);

        // Load saved preferences from localStorage
        const [darkMode, setDarkMode] = useState(() => {
          const saved = localStorage.getItem("blog-darkMode");
          return saved !== null ? saved === "true" : true;
        });
        const [currentTheme, setCurrentTheme] = useState(() => {
          return localStorage.getItem("blog-theme") || "midnight";
        });

        // 👇 وضع ألوان النصوص: "theme" (ألوان مرتبطة بالثيم) أو "simple" (أبيض/أسود/رمادي)
        const [textColorMode, setTextColorMode] = useState(() => {
          return localStorage.getItem("blog-textColorMode") || "theme";
        });

        const [showThemeMenu, setShowThemeMenu] = useState(false);

        // Save preferences to localStorage when they change
        useEffect(() => {
          localStorage.setItem("blog-darkMode", darkMode);
        }, [darkMode]);

        useEffect(() => {
          localStorage.setItem("blog-theme", currentTheme);
        }, [currentTheme]);

        useEffect(() => {
          localStorage.setItem("blog-textColorMode", textColorMode);
        }, [textColorMode]);

        // 👇 Effect للتحقق من حالة تسجيل الدخول عند فتح الصفحة
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((user) => {
            if (user) {
              setIsAdmin(true); // المستخدم مسجل دخول (مشرف)
            } else {
              setIsAdmin(false); // زائر عادي
            }
          });
          return () => unsubscribe();
        }, []);

        // Image Zoom State
        const [zoomedImage, setZoomedImage] = useState(null);
        const [imageGallery, setImageGallery] = useState(null);
        const [currentImageIndex, setCurrentImageIndex] = useState(0);
        const [templates, setTemplates] = useState([]);

        // Refs to keep latest state for handlers
        const imageGalleryRef = useRef(null);
        const currentImageIndexRef = useRef(0);

        // Update refs when state changes
        useEffect(() => {
          imageGalleryRef.current = imageGallery;
        }, [imageGallery]);

        useEffect(() => {
          currentImageIndexRef.current = currentImageIndex;
        }, [currentImageIndex]);

        // Pagination & Filter State
        const [lastDoc, setLastDoc] = useState(null);
        const [loading, setLoading] = useState(false);
        const [hasMore, setHasMore] = useState(true);
        const [selectedTags, setSelectedTags] = useState([]);

        // Tag Cloud State
        const [allTags, setAllTags] = useState({});

        // Copy Link State
        const [copiedPostId, setCopiedPostId] = useState(null);

        // Scroll to Top State
        const [showScrollTop, setShowScrollTop] = useState(false);

        // Floating Controls State (for single post view)
        const [showFloatingControls, setShowFloatingControls] = useState(true);
        const lastScrollY = useRef(0);

        // State for Celebration - use ref to prevent multiple triggers
        const hasCelebratedRef = useRef(false);

        // State for Reading Progress
        const [readingProgress, setReadingProgress] = useState(0);

        // State لتأثيرات التصفيق (مصفوفة عشان نقدر نضغط ورا بعض بسرعة)
        const [clapParticles, setClapParticles] = useState([]);

        // Ref for content container
        const contentRef = useRef(null);

        // --- Helper: Relative Time Formatter (Arabic) ---
        const formatTimeAgo = (timestamp) => {
          if (!timestamp) return "";
          const date = timestamp.toDate();
          const now = new Date();
          const diffInSeconds = Math.floor((now - date) / 1000);

          // لو فات أكثر من سنة (365 يوم)، اعرض التاريخ العادي
          const oneYearInSeconds = 365 * 24 * 60 * 60;
          if (diffInSeconds >= oneYearInSeconds) {
            return date.toLocaleDateString("ar-EG");
          }

          // حساب المدد الزمنية
          if (diffInSeconds < 60) return "منذ لحظات";

          const diffInMinutes = Math.floor(diffInSeconds / 60);
          if (diffInMinutes < 60) return `منذ ${diffInMinutes} دقيقة`;

          const diffInHours = Math.floor(diffInMinutes / 60);
          if (diffInHours < 24) {
            if (diffInHours === 1) return "منذ ساعة";
            if (diffInHours === 2) return "منذ ساعتين";
            if (diffInHours <= 10) return `منذ ${diffInHours} ساعات`;
            return `منذ ${diffInHours} ساعة`;
          }

          const diffInDays = Math.floor(diffInHours / 24);
          if (diffInDays < 30) {
            if (diffInDays === 1) return "منذ أمس";
            if (diffInDays === 2) return "منذ يومين";
            if (diffInDays <= 10) return `منذ ${diffInDays} أيام`;
            return `منذ ${diffInDays} يوم`;
          }

          const diffInMonths = Math.floor(diffInDays / 30);
          if (diffInMonths === 1) return "منذ شهر";
          if (diffInMonths === 2) return "منذ شهرين";
          if (diffInMonths <= 10) return `منذ ${diffInMonths} أشهر`;
          return `منذ ${diffInMonths} شهر`;
        };

        // دالة حساب وقت القراءة
        const calculateReadingTime = (content) => {
          if (!content) return 0;
          // حذف رموز الماركداون والمسافات الزائدة لحساب الكلمات بدقة
          const text = content.replace(/[#*`~>\[\]\(\)]/g, "").trim();
          const wordCount = text
            .split(/\s+/)
            .filter((word) => word.length > 0).length;
          const readingTime = Math.ceil(wordCount / 200); // متوسط القراءة 200 كلمة/دقيقة
          return readingTime || 1; // على الأقل دقيقة واحدة
        };

        // دالة التعامل مع ضغطة التصفيق
        const handleClap = () => {
          const id = Date.now();
          // إضافة "جسيم" جديد للمصفوفة
          setClapParticles((prev) => [...prev, { id }]);

          // حذف الجسيم بعد انتهاء الانيميشن (1 ثانية) لتنظيف الذاكرة
          setTimeout(() => {
            setClapParticles((prev) => prev.filter((p) => p.id !== id));
          }, 1000);
        };

        useEffect(() => {
          const lightTheme = document.getElementById("hljs-light-theme");
          const darkTheme = document.getElementById("hljs-dark-theme");

          if (darkMode) {
            document.documentElement.classList.add("dark");
            // Switch to dark theme for code highlighting
            if (lightTheme) lightTheme.disabled = true;
            if (darkTheme) darkTheme.disabled = false;
          } else {
            document.documentElement.classList.remove("dark");
            // Switch to light theme for code highlighting
            if (lightTheme) lightTheme.disabled = false;
            if (darkTheme) darkTheme.disabled = true;
          }
        }, [darkMode]);

        // Theme is now saved in localStorage, no auto-change needed

        // Re-highlight code when dark mode changes
        useEffect(() => {
          if (activePost && contentRef.current) {
            setTimeout(() => {
              contentRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 150);
          }
        }, [darkMode, activePost]);

        // --- Click Handler for Images in Markdown ---
        useEffect(() => {
          const handleClick = (e) => {
            if (e.target.tagName === "IMG" && e.target.closest(".prose-rtl")) {
              setZoomedImage(e.target.src);
            }
          };

          document.addEventListener("click", handleClick);
          return () => document.removeEventListener("click", handleClick);
        }, []);

        // --- Close Theme Menu when clicking outside ---
        useEffect(() => {
          const handleClickOutside = (e) => {
            if (showThemeMenu) {
              // Check if click is outside the theme menu and its button
              const isClickInsideMenu =
                e.target.closest(".absolute") &&
                e.target.closest(".absolute").querySelector("button");
              const isClickOnPaletteButton =
                e.target.closest("button") &&
                (e.target.closest("button").querySelector("svg") ||
                  e.target.closest("button").innerHTML.includes("Palette"));
              if (!isClickInsideMenu && !isClickOnPaletteButton) {
                setShowThemeMenu(false);
              }
            }
          };
          if (showThemeMenu) {
            document.addEventListener("click", handleClickOutside);
            return () =>
              document.removeEventListener("click", handleClickOutside);
          }
        }, [showThemeMenu]);

        // --- Syntax Highlighting & Copy Button Injection ---
        useEffect(() => {
          if (activePost && contentRef.current) {
            // Extract Table of Contents from headings (with small delay to ensure DOM is ready)
            setTimeout(() => {
              if (contentRef.current) {
                const headings = Array.from(
                  contentRef.current.querySelectorAll("h2[id]")
                );
                const extractedToc = headings.map((h2) => ({
                  id: h2.id,
                  text: h2.textContent || h2.innerText,
                }));
                setTocItems(extractedToc);

                // DO NOT auto-scroll on page load - only scroll if user explicitly clicked a link with hash
                // The hashchange event handler will handle navigation when user clicks TOC links
              }
            }, 100);

            // 2. Highlight Code (re-highlight when theme changes)
            setTimeout(() => {
              contentRef.current
                .querySelectorAll("pre code")
                .forEach((block) => {
                  hljs.highlightElement(block);
                });
            }, 100);

            // 3. Inject Copy Buttons
            contentRef.current.querySelectorAll("pre").forEach((preBlock) => {
              if (preBlock.querySelector(".copy-code-btn")) return;

              const button = document.createElement("button");
              button.className =
                "copy-code-btn absolute top-2 right-2 bg-gray-800/50 dark:bg-slate-700/50 hover:bg-gray-700 dark:hover:bg-slate-700 text-gray-200 dark:text-slate-300 p-1.5 rounded-md text-xs transition-all opacity-0 group-hover:opacity-100 z-10 flex items-center justify-center backdrop-blur-sm border border-gray-600/30 dark:border-white/10";
              button.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
              button.title = "نسخ الكود";

              button.addEventListener("click", () => {
                const code = preBlock.querySelector("code").innerText;
                navigator.clipboard.writeText(code).then(() => {
                  button.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
                  button.classList.add("text-green-500");
                  setTimeout(() => {
                    button.innerHTML =
                      '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
                    button.classList.remove("text-green-500");
                  }, 2000);
                });
              });

              preBlock.classList.add("group");
              preBlock.appendChild(button);
            });
          } else {
            setTocItems([]);
          }
        }, [activePost]);

        // --- URL Routing Logic ---
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          const idFromUrl = params.get("id");

          if (idFromUrl) {
            loadSinglePost(idFromUrl);
          }

          const handlePopState = () => {
            const newParams = new URLSearchParams(window.location.search);
            const newId = newParams.get("id");
            if (newId) loadSinglePost(newId);
            else setActivePost(null);
          };

          window.addEventListener("popstate", handlePopState);
          return () => {
            window.removeEventListener("popstate", handlePopState);
          };
        }, []);

        // Separate effect for hash navigation - only when user explicitly clicks TOC link
        useEffect(() => {
          if (!activePost || !contentRef.current) return;

          // Handle hash changes (for section navigation) - ONLY when hash actually changes
          const handleHashChange = () => {
            const hash = window.location.hash.substring(1);
            // Only scroll if hash exists, is not empty, and is a valid TOC item
            if (hash && hash.trim() !== "" && tocItems.length > 0) {
              const hashExists = tocItems.some((item) => item.id === hash);
              if (hashExists) {
                setTimeout(() => {
                  const element = document.getElementById(hash);
                  if (element) {
                    const offset = 100;
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition =
                      elementPosition + window.pageYOffset - offset;
                    window.scrollTo({
                      top: Math.max(0, offsetPosition),
                      behavior: "smooth",
                    });
                  }
                }, 200);
              }
            }
          };

          // Only listen to hashchange if there's actually a hash in URL (user clicked a link)
          if (window.location.hash) {
            handleHashChange(); // Handle initial hash if present
          }

          window.addEventListener("hashchange", handleHashChange);
          return () => {
            window.removeEventListener("hashchange", handleHashChange);
          };
        }, [activePost, tocItems]);

        // --- Fetch Tags Stats (Server-side Filtering) ---
        useEffect(() => {
          db.collection("posts")
            .where("deleted", "==", false)
            .orderBy("createdAt", "desc")
            .limit(100)
            .get()
            .then((snapshot) => {
              const tagsMap = {};
              snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.topics && Array.isArray(data.topics)) {
                  data.topics.forEach((tag) => {
                    tagsMap[tag] = (tagsMap[tag] || 0) + 1;
                  });
                }
              });
              setAllTags(tagsMap);
            })
            .catch((err) => console.error("Tags fetch error:", err));
        }, []);

        // --- دالة الاحتفال ---
        const triggerCelebration = () => {
          const duration = 3 * 1000;
          const animationEnd = Date.now() + duration;
          const defaults = {
            startVelocity: 30,
            spread: 360,
            ticks: 60,
            zIndex: 999,
          };

          const randomInRange = (min, max) => Math.random() * (max - min) + min;

          const interval = setInterval(function () {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 50 * (timeLeft / duration);

            // Confetti من ناحية الهدية (اليسار) أكثر
            confetti(
              Object.assign({}, defaults, {
                particleCount,
                origin: { x: 0.1, y: Math.random() - 0.2 },
              })
            );
            confetti(
              Object.assign({}, defaults, {
                particleCount,
                origin: { x: 0.9, y: Math.random() - 0.2 },
              })
            );
          }, 250);
        };

        // --- Scroll Handler: حساب التقدم والاحتفال ---
        useEffect(() => {
          const handleScroll = () => {
            const currentScrollY =
              window.scrollY || document.documentElement.scrollTop;

            // 1. منطق إظهار/إخفاء الأزرار العائمة (فقط في وضع القراءة)
            if (activePost) {
              // إذا كان السكرول للأعلى أو نحن في بداية الصفحة -> أظهر التحكم
              if (
                currentScrollY < lastScrollY.current ||
                currentScrollY < 100
              ) {
                setShowFloatingControls(true);
              } else {
                // إذا كان السكرول للأسفل -> أخفِ التحكم
                setShowFloatingControls(false);
              }
              lastScrollY.current = currentScrollY;
            }

            // 2. حساب زر العودة للأعلى
            setShowScrollTop(currentScrollY > 300);

            // 3. لو مفيش مقال مفتوح، مش محتاجين نحسب شريط التقدم
            if (!activePost) {
              setReadingProgress(0);
              return;
            }

            // 4. حساب نسبة التقدم بدقة
            const winHeight = window.innerHeight;
            const docHeight = document.documentElement.scrollHeight;
            const scrollTop =
              window.pageYOffset || document.documentElement.scrollTop;

            // المعادلة: (المسافة المقطوعة / (الطول الكلي - طول الشاشة)) * 100
            const trackLength = docHeight - winHeight;
            const pct = Math.floor(
              trackLength > 0 ? (scrollTop / trackLength) * 100 : 0
            );

            setReadingProgress(pct);

            // 5. منطق الاحتفال عند الوصول لـ 95% (مرة واحدة فقط لكل مقال)
            // تأكد من أن الاحتفال يحدث مرة واحدة فقط
            if (pct >= 95) {
              if (!hasCelebratedRef.current) {
                triggerCelebration();
                hasCelebratedRef.current = true;
              }
            } else if (pct < 90) {
              // إعادة تعيين فقط إذا رجع المستخدم لأعلى (أقل من 90%)
              // هذا يمنع الاحتفال المتكرر عند الصعود والنزول
              // hasCelebratedRef.current = false; // لا نعيد التعيين - مرة واحدة فقط
            }
          };

          window.addEventListener("scroll", handleScroll);
          return () => window.removeEventListener("scroll", handleScroll);
        }, [activePost]);

        // إعادة تعيين الاحتفال والتقدم والأزرار العائمة لما نفتح مقال جديد
        useEffect(() => {
          if (activePost) {
            // Reset celebration flag ONLY when opening a NEW post (different post ID)
            hasCelebratedRef.current = false;
            setReadingProgress(0);
            setShowFloatingControls(true);
            lastScrollY.current = 0;
            // Reset scroll position to top when opening new post
            window.scrollTo(0, 0);
          } else {
            // Reset when closing post
            hasCelebratedRef.current = false;
          }
        }, [activePost?.id]); // Only reset when post ID changes, not on every render

        // --- Helpers ---
        const updateUrl = (id) => {
          if (id) {
            window.history.pushState({ id }, "", `?id=${id}`);
          } else {
            window.history.pushState({}, "", window.location.pathname);
          }
        };

        const loadSinglePost = async (id) => {
          setLoading(true);
          try {
            const doc = await db.collection("posts").doc(id).get();
            if (doc.exists) {
              const postData = { id: doc.id, ...doc.data() };
              // تحديد status للمنشورات القديمة
              if (!postData.status) {
                postData.status =
                  postData.deleted === true ? "deleted" : "public";
              }
              // التحقق من الصلاحيات: الـ viewer لا يعرض المسودات أو المحذوفات
              // المسودات والمحذوفات متاحة فقط في writer app
              if (
                postData.status === "draft" ||
                postData.status === "deleted"
              ) {
                updateUrl(null);
                setActivePost(null);
                return;
              }
              setActivePost(postData);
            } else {
              updateUrl(null);
            }
          } catch (err) {
            console.error("Error loading post:", err);
          } finally {
            setLoading(false);
          }
        };

        const handlePostClick = (post) => {
          // التحقق من الصلاحيات: الـ viewer لا يعرض المسودات أو المحذوفات
          // المسودات والمحذوفات متاحة فقط في writer app
          const postStatus =
            post.status || (post.deleted === true ? "deleted" : "public");
          if (postStatus === "draft" || postStatus === "deleted") {
            return; // منع فتح المنشور
          }
          setActivePost(post);
          updateUrl(post.id);
        };

        const handleBackToList = () => {
          setActivePost(null);
          updateUrl(null);
        };

        // --- COPY LINK FUNCTION ---
        const handleCopyLink = (id, e) => {
          if (e) e.stopPropagation();
          const baseUrl =
            "https://mabdullah821.github.io/tech-stories-archive/viewer.html";
          const url = `${baseUrl}?id=${id}`;
          navigator.clipboard
            .writeText(url)
            .then(() => {
              setCopiedPostId(id);
              setTimeout(() => {
                setCopiedPostId(null);
              }, 2000);
            })
            .catch((err) => {
              console.error("Failed to copy: ", err);
            });
        };

        const handleTagSelection = (tag, reset = false) => {
          if (reset) {
            setSelectedTags([]);
            return;
          }

          if (selectedTags.includes(tag)) {
            setSelectedTags(selectedTags.filter((t) => t !== tag));
          } else {
            if (selectedTags.length < 5) {
              setSelectedTags([...selectedTags, tag]);
            } else {
              alert("يمكنك اختيار 5 مواضيع كحد أقصى.");
            }
          }
        };

        // --- Fetch List Posts Logic (Server-side Filtering) ---
        const fetchPosts = async (isNewFilter = false) => {
          if (loading || (!hasMore && !isNewFilter)) return;
          setLoading(true);

          try {
            let query;

            // فلترة حسب status: الـ viewer يعرض المنشورات العامة فقط
            // المسودات والمحذوفات متاحة فقط في writer app
            query = db.collection("posts").where("status", "==", "public");

            // إضافة فلتر التاجز إن وجد
            if (selectedTags.length > 0) {
              query = query.where("topics", "array-contains-any", selectedTags);
            }

            // الترتيب
            query = query.orderBy("createdAt", "desc");

            // الباجينيشن (إكمال التحميل)
            if (!isNewFilter && lastDoc) {
              query = query.startAfter(lastDoc);
            }

            // الحد الأقصى
            query = query.limit(5);

            const snapshot = await query.get();

            if (snapshot.empty) {
              setHasMore(false);
              if (isNewFilter) setPosts([]);
            } else {
              const newPosts = snapshot.docs.map((doc) => {
                const data = doc.data();
                // للحفاظ على التوافق مع المنشورات القديمة التي لا تحتوي على status
                // إذا لم يكن status موجوداً، نحدده بناءً على deleted
                if (!data.status) {
                  data.status = data.deleted === true ? "deleted" : "public";
                }
                return {
                  id: doc.id,
                  ...data,
                };
              });

              setLastDoc(snapshot.docs[snapshot.docs.length - 1]);

              if (isNewFilter) {
                setPosts(newPosts);
              } else {
                setPosts((prev) => {
                  const existingIds = new Set(prev.map((p) => p.id));
                  const uniqueNewPosts = newPosts.filter(
                    (p) => !existingIds.has(p.id)
                  );
                  return [...prev, ...uniqueNewPosts];
                });
              }

              if (snapshot.docs.length < 5) setHasMore(false);
            }
          } catch (err) {
            console.error("Error fetching posts:", err);
            // Fallback للحفاظ على التوافق مع المنشورات القديمة
            // إذا فشل الاستعلام بسبب عدم وجود status، نجرب الطريقة القديمة
            if (
              err.code === "failed-precondition" ||
              err.message?.includes("status")
            ) {
              try {
                let fallbackQuery = db
                  .collection("posts")
                  .where("deleted", "==", false);
                if (selectedTags.length > 0) {
                  fallbackQuery = fallbackQuery.where(
                    "topics",
                    "array-contains-any",
                    selectedTags
                  );
                }
                fallbackQuery = fallbackQuery.orderBy("createdAt", "desc");
                if (!isNewFilter && lastDoc) {
                  fallbackQuery = fallbackQuery.startAfter(lastDoc);
                }
                fallbackQuery = fallbackQuery.limit(5);

                const fallbackSnapshot = await fallbackQuery.get();
                if (!fallbackSnapshot.empty) {
                  const newPosts = fallbackSnapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data(),
                    status: "public", // افتراضي للمنشورات القديمة
                  }));
                  setLastDoc(
                    fallbackSnapshot.docs[fallbackSnapshot.docs.length - 1]
                  );
                  if (isNewFilter) {
                    setPosts(newPosts);
                  } else {
                    setPosts((prev) => {
                      const existingIds = new Set(prev.map((p) => p.id));
                      const uniqueNewPosts = newPosts.filter(
                        (p) => !existingIds.has(p.id)
                      );
                      return [...prev, ...uniqueNewPosts];
                    });
                  }
                  if (fallbackSnapshot.docs.length < 5) setHasMore(false);
                } else {
                  setHasMore(false);
                  if (isNewFilter) setPosts([]);
                }
              } catch (fallbackErr) {
                console.error("Fallback query also failed:", fallbackErr);
              }
            }
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => {
          if (!activePost) {
            setLastDoc(null);
            setHasMore(true);
            fetchPosts(true);
          }
        }, [selectedTags, activePost]);

        // Scroll Handler
        useEffect(() => {
          const handleScroll = () => {
            if (activePost) return;
            if (
              window.innerHeight + document.documentElement.scrollTop >=
              document.documentElement.offsetHeight - 100
            ) {
              fetchPosts(false);
            }
          };
          window.addEventListener("scroll", handleScroll);
          return () => window.removeEventListener("scroll", handleScroll);
        }, [lastDoc, loading, hasMore, activePost]);

        // Scroll to Top Button Handler - تم دمجه في handleScroll أعلاه

        // Smooth Scroll to Top Function
        const scrollToTop = () => {
          const startPosition = window.pageYOffset;
          const distance = startPosition;
          const duration = Math.min(800, Math.max(400, distance * 0.5)); // Between 400ms and 800ms
          let start = null;

          const animation = (currentTime) => {
            if (start === null) start = currentTime;
            const timeElapsed = currentTime - start;
            const progress = Math.min(timeElapsed / duration, 1);

            // Easing function for smooth animation (ease-out)
            const easeOut = 1 - Math.pow(1 - progress, 3);

            window.scrollTo(0, startPosition * (1 - easeOut));

            if (timeElapsed < duration) {
              requestAnimationFrame(animation);
            }
          };

          requestAnimationFrame(animation);
        };

        const renderMarkdown = (content) => {
          if (!content) return { __html: "" };

          let processedContent;
          let headingCounter = 0; // Counter for automatic heading numbering

          // If content already contains HTML tags, process it
          // Otherwise parse as markdown
          if (
            content.includes("<div") ||
            content.includes("<img") ||
            content.includes("<a")
          ) {
            // Content already has HTML, process it to add click handlers for images
            processedContent = content;

            // Add automatic numbering to h2 headings from text-group blocks only
            // Match h2 tags that have id starting with "text-group-"
            processedContent = processedContent.replace(
              /<h2([^>]*)>(.*?)<\/h2>/gi,
              (match, attributes, titleText) => {
                // Only process headings with id starting with "text-group-"
                if (!attributes.includes('id="text-group-')) {
                  return match;
                }
                // Remove any existing numbering first
                const cleanText = titleText.replace(/^\d+\.\s*/, "").trim();
                // Skip if text is empty after cleaning
                if (!cleanText) {
                  return match;
                }
                headingCounter++;
                return `<h2${attributes}>${headingCounter}. ${cleanText}</h2>`;
              }
            );

            // Process image groups with data-all-images attribute
            let groupIndex = 0;

            // Match div opening tags with data-all-images='...' (single quotes)
            processedContent = processedContent.replace(
              /<div([^>]*)\s+data-all-images='([^']*)'([^>]*)>/g,
              (match, beforeAttr, allImagesJson, afterAttr) => {
                const groupId = `image-group-${groupIndex++}`;
                return `<div${beforeAttr} data-all-images='${allImagesJson.replace(
                  /'/g,
                  "&#39;"
                )}' data-image-group="${groupId}"${afterAttr}>`;
              }
            );

            // Also handle double quotes version
            processedContent = processedContent.replace(
              /<div([^>]*)\s+data-all-images="([^"]*)"([^>]*)>/g,
              (match, beforeAttr, allImagesJson, afterAttr) => {
                if (match.includes("data-image-group")) {
                  return match;
                }
                const groupId = `image-group-${groupIndex++}`;
                return `<div${beforeAttr} data-all-images="${allImagesJson.replace(
                  /"/g,
                  "&quot;"
                )}" data-image-group="${groupId}"${afterAttr}>`;
              }
            );

            // Handle standalone images - add data-image-src attribute
            processedContent = processedContent.replace(
              /<img([^>]+)src="([^"]+)"([^>]*)>/g,
              (match, before, src, after) => {
                return `<img${before}src="${src.replace(
                  /"/g,
                  "&quot;"
                )}"${after} data-image-src="${src.replace(
                  /"/g,
                  "&quot;"
                )}" class="cursor-pointer">`;
              }
            );
          } else {
            // Parse markdown
            processedContent = marked.parse(content);

            // Add automatic numbering to h2 headings from text-group blocks only
            // Match h2 tags that have id starting with "text-group-"
            processedContent = processedContent.replace(
              /<h2([^>]*)>(.*?)<\/h2>/gi,
              (match, attributes, titleText) => {
                // Only process headings with id starting with "text-group-"
                if (!attributes.includes('id="text-group-')) {
                  return match;
                }
                // Remove any existing numbering first
                const cleanText = titleText.replace(/^\d+\.\s*/, "").trim();
                // Skip if text is empty after cleaning
                if (!cleanText) {
                  return match;
                }
                headingCounter++;
                return `<h2${attributes}>${headingCounter}. ${cleanText}</h2>`;
              }
            );
          }

          // Final sanitization with DOMPurify - remove all dangerous content
          // This is the critical security step that prevents XSS attacks
          const sanitized = DOMPurify.sanitize(processedContent, {
            ALLOWED_TAGS: [
              "p",
              "br",
              "strong",
              "em",
              "u",
              "b",
              "i",
              "h1",
              "h2",
              "h3",
              "h4",
              "h5",
              "h6",
              "ul",
              "ol",
              "li",
              "blockquote",
              "code",
              "pre",
              "a",
              "img",
              "div",
              "span",
              "table",
              "thead",
              "tbody",
              "tr",
              "td",
              "th",
              "hr",
            ],
            ALLOWED_ATTR: [
              "href",
              "src",
              "alt",
              "title",
              "class",
              "id",
              "data-image-group",
              "data-all-images",
              "data-image-src",
              "data-images",
              "style",
            ],
            // Only allow safe URL schemes
            ALLOWED_URI_REGEXP:
              /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
            // Block data attributes that could contain JavaScript
            ALLOW_DATA_ATTR: false,
            // Explicitly forbid dangerous tags
            FORBID_TAGS: [
              "script",
              "iframe",
              "object",
              "embed",
              "form",
              "input",
              "button",
              "style",
            ],
            // Remove all event handlers
            FORBID_ATTR: [
              "onerror",
              "onclick",
              "onload",
              "onmouseover",
              "onfocus",
              "onblur",
              "onchange",
              "onsubmit",
            ],
          });

          return { __html: sanitized };
        };

        // Helper function to get contrast color (same as writer.html)
        const getContrastColor = (hexcolor) => {
          hexcolor = hexcolor.replace("#", "");
          const r = parseInt(hexcolor.substr(0, 2), 16);
          const g = parseInt(hexcolor.substr(2, 2), 16);
          const b = parseInt(hexcolor.substr(4, 2), 16);
          const yiq = (r * 299 + g * 587 + b * 114) / 1000;
          return yiq >= 128 ? "#000000" : "#ffffff";
        };

        // Load templates from Firebase
        useEffect(() => {
          if (!db) return;
          const loadTemplates = async () => {
            try {
              const snapshot = await db
                .collection("posts")
                .where("type", "==", "template")
                .orderBy("updatedAt", "desc")
                .limit(10)
                .get();
              const loadedTemplates = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              setTemplates(loadedTemplates);
            } catch (e) {
              console.error("Error loading templates:", e);
            }
          };
          loadTemplates();
        }, [db]);

        // Function to render template blocks to HTML
        const renderTemplate = (template) => {
          if (!template || !template.blocks || template.blocks.length === 0)
            return "";

          try {
            // Counter for automatic heading numbering (Arabic numerals)
            let headingCounter = 0;

            // Render blocks similar to writer.html
            const parts = template.blocks
              .map((b) => {
                if (b.type === "text") {
                  const content =
                    b.dir === "ltr"
                      ? `\n<div dir="ltr" style="text-align: left;">\n\n${b.content}\n\n</div>\n`
                      : `\n${b.content}\n`;
                  return { type: "markdown", content };
                } else if (b.type === "button-group") {
                  const groupData = b.content || {};
                  const { buttons = [], layout = "block" } = groupData;
                  if (buttons.length === 0) return null;
                  const buttonsHtml = buttons
                    .map((btn) => {
                      if (!btn.text) return "";
                      const textColor =
                        btn.textColorMode === "white"
                          ? "#ffffff"
                          : btn.textColorMode === "black"
                          ? "#000000"
                          : getContrastColor(btn.color || "#10b981");
                      return `<a href="${
                        btn.url || "#"
                      }" style="background-color: ${
                        btn.color || "#10b981"
                      }; color: ${textColor} !important; text-decoration: none !important;" class="inline-block font-bold py-3 px-8 rounded-full shadow-lg no-underline mx-2 mb-2">${
                        btn.text
                      }</a>`;
                    })
                    .filter(Boolean)
                    .join("");
                  const containerClass =
                    layout === "inline"
                      ? "my-6 text-center flex flex-wrap gap-2 justify-center"
                      : "my-6 text-center flex flex-col gap-2 items-center";
                  return {
                    type: "html",
                    content: `<div class="${containerClass}">${buttonsHtml}</div>`,
                  };
                } else if (b.type === "image-group") {
                  const groupData = b.content || {};
                  const { images = [], layout = "block" } = groupData;
                  const validImages = images.filter((img) => img && img.trim());
                  if (validImages.length === 0) return null;
                  const gridClass =
                    layout === "inline"
                      ? validImages.length === 1
                        ? "grid grid-cols-1"
                        : validImages.length === 2
                        ? "grid grid-cols-2"
                        : "grid grid-cols-3"
                      : "grid grid-cols-1";
                  const imagesHtml = validImages
                    .map(
                      (imgUrl) =>
                        `<div class="relative"><img src="${imgUrl}" alt="Image" class="w-full h-full object-cover rounded-lg border border-gray-200 dark:border-gray-700 cursor-zoom-in" style="max-height: ${
                          layout === "inline" ? "120px" : "400px"
                        }; min-height: ${
                          layout === "inline" ? "80px" : "300px"
                        };" /></div>`
                    )
                    .join("");
                  return {
                    type: "html",
                    content: `<div class="my-6 ${gridClass} gap-2" data-all-images='${JSON.stringify(
                      validImages
                    ).replace(/'/g, "&#39;")}'>${imagesHtml}</div>`,
                  };
                } else if (b.type === "text-group") {
                  // Text groups - render each text with title and content
                  const groupData = b.content || {};
                  const { texts = [], layout = "block" } = groupData;
                  const validTexts = texts.filter(
                    (t) => t && (t.title || t.content)
                  );
                  if (validTexts.length === 0) return null;

                  const containerClass =
                    layout === "inline"
                      ? "my-6 grid grid-cols-2 gap-4"
                      : "my-6 flex flex-col gap-6";

                  const textsHtml = validTexts
                    .map((textItem, textIndex) => {
                      let html = "";
                      // Add title if exists - with border-bottom and proper indexing
                      if (textItem.title) {
                        headingCounter++; // Increment counter for each heading
                        const titleId = `text-group-${
                          b.id
                            ? b.id.replace(/[^a-zA-Z0-9]/g, "")
                            : Math.random().toString(36)
                        }-${textIndex}-${textItem.title.replace(
                          /[^a-zA-Z0-9]/g,
                          ""
                        )}`;
                        // Add Arabic numbering (1, 2, 3, etc.) to the heading
                        const numberedTitle = `${headingCounter}. ${textItem.title}`;
                        html += `<h2 id="${titleId}" class="text-2xl font-bold mb-4 mt-8 scroll-mt-20 pb-3 border-b border-gray-200 dark:border-gray-700">${numberedTitle}</h2>`;
                      }
                      // Add content
                      if (textItem.content) {
                        const dirAttr =
                          textItem.dir === "ltr"
                            ? ' dir="ltr" style="text-align: left;"'
                            : "";
                        html += `<div${dirAttr} class="prose dark:prose-invert max-w-none">${marked.parse(
                          textItem.content
                        )}</div>`;
                      }
                      return html ? `<div class="text-item">${html}</div>` : "";
                    })
                    .filter(Boolean)
                    .join("");

                  if (textsHtml) {
                    return {
                      type: "html",
                      content: `<div class="${containerClass}">${textsHtml}</div>`,
                    };
                  }
                  return null;
                }
                return null;
              })
              .filter(Boolean);

            // Build HTML
            let result = "";
            let markdownBuffer = "";
            parts.forEach((part) => {
              if (part.type === "markdown") {
                markdownBuffer += part.content;
              } else {
                if (markdownBuffer) {
                  result += marked.parse(markdownBuffer);
                  markdownBuffer = "";
                }
                result += part.content;
              }
            });
            if (markdownBuffer) {
              result += marked.parse(markdownBuffer);
            }
            return result;
          } catch (e) {
            console.error("Error rendering template:", e);
            return "";
          }
        };

        // Function to render all templates (or first template) at end of post
        // Add template only for posts that don't already have template content
        const renderTemplatesSection = () => {
          if (templates.length === 0) return "";
          // Use first template (most recently updated)
          const firstTemplate = templates[0];
          return renderTemplate(firstTemplate);
        };

        // Handlers for image gallery
        const handleImageClick = (images, index) => {
          // Ensure images is an array
          const imagesArray = Array.isArray(images)
            ? images
            : [images].filter(Boolean);
          if (imagesArray.length > 0) {
            setImageGallery(imagesArray);
            const validIndex = Math.max(
              0,
              Math.min(index, imagesArray.length - 1)
            );
            setCurrentImageIndex(validIndex);
          }
        };

        const handleNextImage = () => {
          const currentGallery = imageGalleryRef.current;
          const currentIndex = currentImageIndexRef.current;
          if (
            currentGallery &&
            Array.isArray(currentGallery) &&
            currentIndex < currentGallery.length - 1
          ) {
            setCurrentImageIndex(currentIndex + 1);
          }
        };

        const handlePrevImage = () => {
          const currentIndex = currentImageIndexRef.current;
          if (currentIndex > 0) {
            setCurrentImageIndex(currentIndex - 1);
          }
        };

        const handleCloseGallery = () => {
          setImageGallery(null);
          setCurrentImageIndex(0);
        };

        // Add click handlers to images after render
        useEffect(() => {
          if (!activePost) return;

          // Helper function to normalize URLs for comparison
          const normalizeUrl = (url) => {
            if (!url) return "";
            // Remove query parameters and fragments for comparison
            try {
              const urlObj = new URL(url, window.location.href);
              return urlObj.origin + urlObj.pathname;
            } catch {
              // If URL parsing fails, try to clean it manually
              return url.split("?")[0].split("#")[0];
            }
          };

          // Helper function to find image index in array - more flexible matching
          const findImageIndex = (imgSrc, imagesArray) => {
            if (!imgSrc || !imagesArray || imagesArray.length === 0) return -1;

            // Clean the source URL
            const cleanSrc = imgSrc.trim();

            // First try exact match (case-insensitive)
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              if (cleanSrc === img || cleanSrc === img.trim()) {
                return i;
              }
            }

            // Then try normalized comparison (without query params)
            const normalizedSrc = normalizeUrl(cleanSrc);
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              const normalizedImg = normalizeUrl(img);
              if (normalizedSrc === normalizedImg) {
                return i;
              }
            }

            // Try filename match (last part of URL)
            const srcFilename = cleanSrc
              .split("/")
              .pop()
              .split("?")[0]
              .split("#")[0];
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              const imgFilename = img
                .split("/")
                .pop()
                .split("?")[0]
                .split("#")[0];
              if (srcFilename && imgFilename && srcFilename === imgFilename) {
                return i;
              }
            }

            // Try if one URL contains the other (for relative vs absolute)
            for (let i = 0; i < imagesArray.length; i++) {
              const img = imagesArray[i];
              if (!img) continue;
              if (cleanSrc.includes(img) || img.includes(cleanSrc)) {
                return i;
              }
              const normalizedImg = normalizeUrl(img);
              if (
                normalizedSrc.includes(normalizedImg) ||
                normalizedImg.includes(normalizedSrc)
              ) {
                return i;
              }
            }

            return -1;
          };

          const handleClick = (e) => {
            // Find the clicked image (could be e.target itself or a parent)
            let clickedImg = null;
            if (e.target.tagName === "IMG") {
              clickedImg = e.target;
            } else {
              // Check if clicked on something inside an image (like overlay)
              clickedImg = e.target.closest("img");
            }

            // If we found an image, handle it
            if (clickedImg) {
              // Search for image group - try both data-image-group and data-all-images
              const imageGroup =
                clickedImg.closest("[data-image-group]") ||
                clickedImg.closest("[data-all-images]");

              if (imageGroup) {
                // Image is part of a group
                try {
                  // Try data-all-images first (original from writer), then data-images
                  let imagesJson =
                    imageGroup.getAttribute("data-all-images") ||
                    imageGroup.getAttribute("data-images");

                  if (imagesJson) {
                    // Handle HTML entities and quotes
                    const cleanedJson = imagesJson
                      .replace(/&#39;/g, "'")
                      .replace(/&quot;/g, '"')
                      .replace(/&amp;/g, "&");

                    let images;
                    try {
                      images = JSON.parse(cleanedJson);
                    } catch (parseErr) {
                      console.error("JSON parse error:", parseErr, cleanedJson);
                      return;
                    }

                    // Ensure images is an array
                    if (!Array.isArray(images) || images.length === 0) {
                      console.error("Invalid images array:", images);
                      return;
                    }

                    // Try multiple ways to get the image source
                    const imgSrc =
                      clickedImg.getAttribute("src") ||
                      clickedImg.getAttribute("data-image-src") ||
                      clickedImg.getAttribute("data-src") ||
                      clickedImg.currentSrc ||
                      clickedImg.src;

                    if (!imgSrc) {
                      console.error("Could not find image source");
                      return;
                    }

                    const index = findImageIndex(imgSrc, images);

                    if (index !== -1) {
                      // Found the image index - open gallery at that index
                      const imagesArray = Array.isArray(images)
                        ? images
                        : [images].filter(Boolean);
                      if (imagesArray.length > 0) {
                        setImageGallery(imagesArray);
                        const validIndex = Math.max(
                          0,
                          Math.min(index, imagesArray.length - 1)
                        );
                        setCurrentImageIndex(validIndex);
                      }
                      e.preventDefault();
                      e.stopPropagation();
                      return;
                    } else {
                      // If index not found, still open gallery with first image
                      // This can happen if URLs don't match exactly
                      const imagesArray = Array.isArray(images)
                        ? images
                        : [images].filter(Boolean);
                      if (imagesArray.length > 0) {
                        setImageGallery(imagesArray);
                        setCurrentImageIndex(0);
                      }
                      e.preventDefault();
                      e.stopPropagation();
                      return;
                    }
                  } else {
                    console.warn(
                      "No data-images or data-all-images attribute found"
                    );
                  }
                } catch (err) {
                  console.error("Error parsing image group:", err);
                }
              } else {
                // Standalone image
                const src =
                  clickedImg.getAttribute("data-image-src") ||
                  clickedImg.getAttribute("src") ||
                  clickedImg.getAttribute("data-src") ||
                  clickedImg.currentSrc ||
                  clickedImg.src;
                if (src) {
                  // Use the component-level handleImageClick
                  setImageGallery([src]);
                  setCurrentImageIndex(0);
                  e.preventDefault();
                  e.stopPropagation();
                  return;
                }
              }
            }

            // If no image was clicked, check if clicked on image group container
            const imageGroupContainer =
              e.target.closest("[data-image-group]") ||
              e.target.closest("[data-all-images]");
            if (imageGroupContainer && !clickedImg) {
              try {
                // Try data-all-images first (original from writer), then data-images
                let imagesJson =
                  imageGroupContainer.getAttribute("data-all-images") ||
                  imageGroupContainer.getAttribute("data-images");

                if (imagesJson) {
                  // Handle HTML entities and quotes
                  const cleanedJson = imagesJson
                    .replace(/&#39;/g, "'")
                    .replace(/&quot;/g, '"')
                    .replace(/&amp;/g, "&");

                  let images;
                  try {
                    images = JSON.parse(cleanedJson);
                  } catch (parseErr) {
                    console.error("JSON parse error:", parseErr, cleanedJson);
                    return;
                  }

                  // Ensure images is an array
                  if (Array.isArray(images) && images.length > 0) {
                    // Use the component-level handleImageClick
                    setImageGallery(images);
                    setCurrentImageIndex(0);
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                  } else {
                    console.error("Invalid images array:", images);
                  }
                } else {
                  console.warn(
                    "No data-images or data-all-images attribute found on container"
                  );
                }
              } catch (err) {
                console.error("Error parsing image group:", err);
              }
            }
          };

          const contentContainer = document.querySelector(".prose-rtl");
          if (contentContainer) {
            contentContainer.addEventListener("click", handleClick, true); // Use capture phase

            return () => {
              contentContainer.removeEventListener("click", handleClick, true);
            };
          }
        }, [activePost]);

        const handleEditPost = (post, e) => {
          e.stopPropagation();
          window.location.href = `writer.html?id=${post.id}`;
        };

        const handleCreateNew = () => {
          window.location.href = `writer.html`;
        };

        // --- Theme Classes ---
        const getThemeClass = () => {
          const theme = themes[currentTheme];
          const textModeClass =
            textColorMode === "simple" ? "text-simple-mode" : "";
          return `${theme.bgLight} ${theme.bgDark} ${
            theme.className || ""
          } ${textModeClass}`;
        };

        // --- Single Post View ---

        // 1. تحديد هل نحن بصدد تحميل مقال منفرد؟
        // نتحقق مما إذا كان هناك ID في الرابط ولكن لم يتم تعيين activePost بعد
        const params = new URLSearchParams(window.location.search);
        const urlId = params.get("id");
        const isSinglePostLoading = loading && urlId && !activePost;

        // الحالة الأولى: جاري تحميل مقال منفرد (Direct Link Loading)
        if (isSinglePostLoading) {
          return (
            <div className={`min-h-screen ${getThemeClass()}`}>
              <SkeletonSinglePost />
            </div>
          );
        }

        // الحالة الثانية: المقال موجود ومحمل
        if (activePost) {
          return (
            <div
              className={`min-h-screen pb-20 ${getThemeClass()} transition-colors duration-500`}
            >
              {/* Legacy single image modal */}
              {zoomedImage && (
                <ImageModal
                  images={[zoomedImage]}
                  currentIndex={0}
                  onClose={() => setZoomedImage(null)}
                  onNext={() => {}}
                  onPrev={() => {}}
                />
              )}

              {/* New image gallery modal */}
              {imageGallery && (
                <ImageModal
                  images={imageGallery}
                  currentIndex={currentImageIndex}
                  onClose={handleCloseGallery}
                  onNext={handleNextImage}
                  onPrev={handlePrevImage}
                />
              )}

              {/* === شريط التقدم الجديد + الهدية === */}
              <div
                className="fixed top-0 left-0 right-0 h-1.5 z-[100] bg-gray-200 dark:bg-gray-700"
                dir="ltr"
              >
                {/* الهدية (أيقونة الهدف) */}
                <div
                  className={`fixed left-2 z-[101] transition-all duration-500 transform origin-top ${
                    readingProgress >= 95
                      ? `${themes[currentTheme].iconColor} scale-110 opacity-100 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)] animate-gentle-bounce`
                      : "text-gray-400 dark:text-gray-600 scale-75 grayscale opacity-50"
                  }`}
                  // 👇 الهدية منخفضة أكثر ولها مسافة كافية من الشريط
                  // القفزة خفيفة (4px فقط) حتى لا تصل للشريط
                  style={{ top: "0.75rem", willChange: "transform, opacity" }}
                >
                  <Gift
                    size={24}
                    strokeWidth={readingProgress >= 95 ? 2.5 : 2}
                    fill="none" // فقط stroke يتلون، بدون fill
                  />
                </div>

                {/* الشريط الملون - يتغير حسب الثيم */}
                <div
                  className={`absolute top-0 right-0 h-full transition-all duration-100 ease-out ${themes[currentTheme].barColor}`}
                  style={{ width: `${readingProgress}%` }}
                >
                  {/* وميض أبيض خفيف جداً في نهاية الشريط لإظهار الحركة */}
                  <div className="absolute top-0 left-0 bottom-0 w-1 bg-white/40 shadow-[0_0_8px_white]"></div>
                </div>
              </div>

              {activePost.coverImage && (
                <div className="w-full h-64 md:h-96 relative">
                  <img
                    src={activePost.coverImage}
                    className="w-full h-full object-cover"
                    onClick={() => setZoomedImage(activePost.coverImage)}
                  />
                  <div className="absolute inset-0 bg-gradient-to-t from-gray-50/100 dark:from-dark to-transparent pointer-events-none"></div>
                </div>
              )}

              <div
                className={`max-w-3xl mx-auto px-1 md:px-4 ${
                  activePost.coverImage
                    ? "-mt-12 md:-mt-20 relative z-10"
                    : "pt-12"
                }`}
              >
                <article className="animate-fade-in bg-white/95 dark:bg-slate-800/95 p-3 md:p-8 rounded-lg md:rounded-2xl shadow-sm backdrop-blur-md relative group border border-gray-100 dark:border-gray-700">
                  {/* Action Buttons */}
                  <div className="absolute top-4 left-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-50">
                    <button
                      onClick={(e) => handleCopyLink(activePost.id, e)}
                      className={`p-2 rounded-full shadow-lg transition-all duration-300 ${
                        copiedPostId === activePost.id
                          ? "bg-green-500 text-white scale-110"
                          : "bg-white text-gray-700 hover:bg-gray-100 hover:scale-110"
                      }`}
                      title={
                        copiedPostId === activePost.id
                          ? "تم النسخ!"
                          : "نسخ رابط المقال"
                      }
                    >
                      {copiedPostId === activePost.id ? (
                        <Check size={18} />
                      ) : (
                        <LinkIcon size={18} />
                      )}
                    </button>
                    {/* 👇 زر التعديل: شرط isAdmin 👇 */}
                    {isAdmin && (
                      <button
                        onClick={(e) => handleEditPost(activePost, e)}
                        className="bg-primary text-white p-2 rounded-full shadow-lg hover:bg-emerald-600 transition-transform hover:scale-110"
                        title="تعديل هذا المقال"
                      >
                        <Edit size={18} />
                      </button>
                    )}
                  </div>

                  <div className="mb-8 border-b border-gray-100 dark:border-gray-700 pb-6">
                    <PostTags
                      topics={activePost.topics}
                      onSelectTag={(tag) => {
                        setActivePost(null);
                        handleTagSelection(tag, true);
                        handleTagSelection(tag);
                      }}
                      currentTheme={currentTheme}
                      themes={themes}
                    />
                    <h1 className="post-title">{activePost.title}</h1>
                    <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                      <span>
                        {formatTimeAgo(activePost.createdAt) || "غير معروف"}
                      </span>
                      <span>•</span>
                      {/* وقت القراءة المتوقع */}
                      <span className="flex items-center gap-1 bg-gray-100 dark:bg-slate-700/50 px-2 py-0.5 rounded-full">
                        <Clock size={12} />
                        <span>
                          {calculateReadingTime(activePost.content)} دقيقة قراءة
                        </span>
                      </span>
                      <span>•</span>
                      <span>قراءة ممتعة ☕</span>
                    </div>
                  </div>
                  {/* Table of Contents */}
                  {tocItems.length > 0 && (
                    <div
                      className="mb-8 p-6 bg-gray-50 dark:bg-slate-800/50 rounded-xl border border-gray-200 dark:border-gray-700"
                      dir="rtl"
                    >
                      <h3 className="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                        <span>📑</span> الفهرس
                      </h3>
                      <ul className="space-y-2" dir="rtl">
                        {tocItems.map((item, idx) => (
                          <li key={idx} className="text-right">
                            <button
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();

                                // Try multiple methods to find and scroll to element
                                const scrollToElement = () => {
                                  // Method 1: Direct ID lookup
                                  let element = document.getElementById(
                                    item.id
                                  );

                                  // Method 2: If not found, try in contentRef
                                  if (!element && contentRef.current) {
                                    element = contentRef.current.querySelector(
                                      `#${item.id}`
                                    );
                                  }

                                  // Method 3: Try finding by text content
                                  if (!element && contentRef.current) {
                                    const headings =
                                      contentRef.current.querySelectorAll("h2");
                                    headings.forEach((h2) => {
                                      if (
                                        h2.textContent === item.text &&
                                        h2.id
                                      ) {
                                        element = h2;
                                      }
                                    });
                                  }

                                  if (element) {
                                    const offset = 100; // Offset for fixed header
                                    const elementPosition =
                                      element.getBoundingClientRect().top;
                                    const offsetPosition =
                                      elementPosition +
                                      window.pageYOffset -
                                      offset;

                                    // Update URL with hash
                                    const currentUrl = new URL(
                                      window.location.href
                                    );
                                    currentUrl.hash = item.id;
                                    window.history.pushState(
                                      {},
                                      "",
                                      currentUrl.toString()
                                    );

                                    // Use smooth scroll
                                    window.scrollTo({
                                      top: Math.max(0, offsetPosition),
                                      behavior: "smooth",
                                    });
                                  } else {
                                    console.warn(
                                      "Element not found:",
                                      item.id,
                                      "Text:",
                                      item.text
                                    );
                                  }
                                };

                                // Small delay to ensure DOM is ready
                                setTimeout(scrollToElement, 50);
                              }}
                              className={`text-right w-full text-base transition-all duration-200 py-2 px-3 rounded-lg cursor-pointer text-right border-2 border-transparent ${
                                textColorMode === "theme"
                                  ? (() => {
                                      // Create hover colors and effects based on current theme
                                      if (currentTheme === "plain") {
                                        return "text-emerald-500 hover:text-emerald-700 dark:hover:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:border-emerald-500 dark:hover:border-emerald-400 hover:shadow-sm";
                                      } else if (currentTheme === "sepia") {
                                        return "text-amber-600 hover:text-amber-800 dark:hover:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/20 hover:border-amber-600 dark:hover:border-amber-500 hover:shadow-sm";
                                      } else if (currentTheme === "ocean") {
                                        return "text-cyan-500 hover:text-cyan-700 dark:hover:text-cyan-300 hover:bg-cyan-50 dark:hover:bg-cyan-900/20 hover:border-cyan-500 dark:hover:border-cyan-400 hover:shadow-sm";
                                      } else if (currentTheme === "forest") {
                                        return "text-emerald-500 hover:text-emerald-700 dark:hover:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:border-emerald-500 dark:hover:border-emerald-400 hover:shadow-sm";
                                      } else if (currentTheme === "midnight") {
                                        return "text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:border-indigo-500 dark:hover:border-indigo-400 hover:shadow-sm";
                                      }
                                      return "text-primary hover:text-emerald-700 dark:hover:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:border-emerald-500 dark:hover:border-emerald-400 hover:shadow-sm";
                                    })()
                                  : "" // الألوان يتم تطبيقها عبر CSS في الوضع البسيط
                              }`}
                              dir="rtl"
                            >
                              {item.text}
                            </button>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                  <div
                    ref={contentRef}
                    className="prose-rtl"
                    dangerouslySetInnerHTML={renderMarkdown(activePost.content)}
                  />
                </article>
              </div>

              {/* ========================================================== */}
              {/* 🔥 Floating Dock: الأزرار العائمة (Theme, Back, Scroll Top) 🔥 */}
              {/* ========================================================== */}
              <div
                className={`fixed bottom-8 right-6 flex flex-col items-center gap-3 z-[100] transition-transform duration-500 ease-in-out ${
                  showFloatingControls ? "translate-y-0" : "translate-y-[200%]"
                }`}
              >
                {/* زر السمة (Theme) - في الأعلى */}
                <div className="relative">
                  <button
                    onClick={() => setShowThemeMenu(!showThemeMenu)}
                    className="w-12 h-12 rounded-full bg-white/90 dark:bg-slate-800/90 text-gray-700 dark:text-gray-200 shadow-lg border border-gray-200 dark:border-gray-600 flex items-center justify-center backdrop-blur-sm hover:scale-110 transition-transform"
                    title="المظهر"
                  >
                    <Palette size={24} />
                  </button>

                  {/* قائمة السمات - تظهر على يسار الزر ومحاذية له من الأعلى */}
                  {showThemeMenu && (
                    <div className="absolute -top-12 right-full mr-3 w-40 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 p-2 overflow-hidden animate-fade-in">
                      <div className="flex flex-col gap-1">
                        {/* زر الوضع الداكن/الفاتح داخل القائمة */}
                        <button
                          onClick={() => setDarkMode(!darkMode)}
                          className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                        >
                          <span>{darkMode ? "نهاري" : "ليلي"}</span>
                          {darkMode ? <Sun size={14} /> : <Moon size={14} />}
                        </button>
                        {/* زر وضع ألوان النصوص */}
                        <button
                          onClick={() =>
                            setTextColorMode(
                              textColorMode === "theme" ? "simple" : "theme"
                            )
                          }
                          className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                        >
                          <span>
                            {textColorMode === "theme"
                              ? "ألوان بسيطة"
                              : "ألوان الثيم"}
                          </span>
                          <Type size={14} />
                        </button>
                        {/* باقي السمات */}
                        {Object.entries(themes).map(([key, t]) => (
                          <button
                            key={key}
                            onClick={() => {
                              setCurrentTheme(key);
                            }}
                            className={`text-right px-3 py-2 text-xs rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                              currentTheme === key
                                ? "text-primary font-bold bg-primary/10"
                                : ""
                            }`}
                          >
                            {t.name}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* زر العودة للصفحة الرئيسية (Home) - في المنتصف */}
                <button
                  onClick={handleBackToList}
                  className="w-12 h-12 rounded-full bg-white/90 dark:bg-slate-800/90 text-gray-800 dark:text-white shadow-lg border border-gray-200 dark:border-gray-600 flex items-center justify-center backdrop-blur-sm hover:scale-110 transition-transform"
                  title="الصفحة الرئيسية"
                >
                  <Home size={24} />
                </button>

                {/* زر التصفيق (Clap Button) */}
                <div className="relative">
                  {/* التأثيرات العائمة (Particles) */}
                  {clapParticles.map((particle) => (
                    <div
                      key={particle.id}
                      className="animate-float-clap absolute -top-8 left-1/2 -translate-x-1/2 text-2xl"
                    >
                      👏 {/* أو ممكن تستخدم ❤️ أو +1 */}
                    </div>
                  ))}

                  <button
                    onClick={handleClap}
                    className={`w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:scale-110 active:scale-95 transition-all duration-200 border border-gray-200 dark:border-gray-600 backdrop-blur-sm 
                      bg-white/90 dark:bg-slate-800/90 text-yellow-500`}
                    title="تفاعل"
                  >
                    <span className="text-2xl">👏</span>
                  </button>
                </div>

                {/* زر الصعود (Scroll Top) - في الأسفل (الأقرب للإبهام) */}
                <button
                  onClick={scrollToTop}
                  className={`w-12 h-12 rounded-full text-white shadow-xl flex items-center justify-center hover:scale-110 transition-all duration-300 ${
                    themes[currentTheme].barColor
                  } ${
                    showScrollTop
                      ? "opacity-100 scale-100"
                      : "opacity-50 scale-75"
                  }`}
                  disabled={!showScrollTop}
                  title="للأعلى"
                >
                  <ChevronUp size={24} />
                </button>
              </div>
            </div>
          );
        }

        // --- List View ---
        return (
          <div
            className={`min-h-screen ${getThemeClass()} transition-colors duration-500`}
          >
            <header className="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-gray-200 dark:border-slate-800 transition-colors">
              <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <h1
                  className={`text-xl font-bold ${
                    themes[currentTheme]?.iconColor || themes.midnight.iconColor
                  } cursor-pointer transition-colors`}
                  onClick={() => {
                    setSelectedTags([]);
                    window.scrollTo(0, 0);
                  }}
                >
                  حكاوي واحد غاوي
                </h1>
                <div className="flex gap-2 items-center">
                  {/* زر إنشاء مقال جديد - يظهر للمشرف فقط */}
                  {isAdmin && (
                    <button
                      onClick={handleCreateNew}
                      className={`p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors ${
                        themes[currentTheme]?.iconColor ||
                        themes.midnight.iconColor
                      } border border-gray-200 dark:border-transparent`}
                      title="إنشاء مقال جديد"
                    >
                      <PlusCircle size={20} />
                    </button>
                  )}

                  {/* Desktop Display Settings - تظهر فقط على الشاشات الكبيرة */}
                  <div className="hidden md:flex gap-2 items-center">
                    <div className="relative">
                      <button
                        onClick={() => setShowThemeMenu(!showThemeMenu)}
                        className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-transparent"
                        title="المظهر"
                      >
                        <Palette size={20} />
                      </button>
                      {showThemeMenu && (
                        <div className="absolute top-12 left-0 w-40 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 p-2 z-[100] overflow-hidden animate-fade-in">
                          <div className="flex flex-col gap-1">
                            {/* زر الوضع الداكن/الفاتح داخل القائمة */}
                            <button
                              onClick={() => setDarkMode(!darkMode)}
                              className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                            >
                              <span>{darkMode ? "نهاري" : "ليلي"}</span>
                              {darkMode ? (
                                <Sun size={14} />
                              ) : (
                                <Moon size={14} />
                              )}
                            </button>
                            {/* زر وضع ألوان النصوص */}
                            <button
                              onClick={() =>
                                setTextColorMode(
                                  textColorMode === "theme" ? "simple" : "theme"
                                )
                              }
                              className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                            >
                              <span>
                                {textColorMode === "theme"
                                  ? "ألوان بسيطة"
                                  : "ألوان الثيم"}
                              </span>
                              <Type size={14} />
                            </button>
                            {/* باقي السمات */}
                            {Object.entries(themes).map(([key, t]) => (
                              <button
                                key={key}
                                onClick={() => {
                                  setCurrentTheme(key);
                                }}
                                className={`text-right px-3 py-2 text-xs rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                  currentTheme === key
                                    ? "text-primary font-bold bg-primary/10"
                                    : ""
                                }`}
                              >
                                {t.name}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Mobile Display Settings Button - يظهر فقط على الشاشات الصغيرة */}
                  <div className="relative md:hidden">
                    <button
                      onClick={() => setShowThemeMenu(!showThemeMenu)}
                      className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-transparent"
                      title="المظهر"
                    >
                      <Palette size={20} />
                    </button>
                    {showThemeMenu && (
                      <div className="absolute top-12 left-0 w-40 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 p-2 z-[100] overflow-hidden animate-fade-in">
                        <div className="flex flex-col gap-1">
                          {/* زر الوضع الداكن/الفاتح داخل القائمة */}
                          <button
                            onClick={() => setDarkMode(!darkMode)}
                            className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                          >
                            <span>{darkMode ? "نهاري" : "ليلي"}</span>
                            {darkMode ? <Sun size={14} /> : <Moon size={14} />}
                          </button>
                          {/* زر وضع ألوان النصوص */}
                          <button
                            onClick={() =>
                              setTextColorMode(
                                textColorMode === "theme" ? "simple" : "theme"
                              )
                            }
                            className="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-xs font-bold border-b border-gray-100 dark:border-gray-700 mb-1"
                          >
                            <span>
                              {textColorMode === "theme"
                                ? "ألوان بسيطة"
                                : "ألوان الثيم"}
                            </span>
                            <Type size={14} />
                          </button>
                          {/* باقي السمات */}
                          {Object.entries(themes).map(([key, t]) => (
                            <button
                              key={key}
                              onClick={() => {
                                setCurrentTheme(key);
                              }}
                              className={`text-right px-3 py-2 text-xs rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 ${
                                currentTheme === key
                                  ? "text-primary font-bold bg-primary/10"
                                  : ""
                              }`}
                            >
                              {t.name}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>

            <main className="max-w-4xl mx-auto px-4 py-8">
              {/* Tag Cloud Section */}
              {!activePost && (
                <TagCloud
                  tags={allTags}
                  selectedTags={selectedTags}
                  onSelectTag={handleTagSelection}
                  currentTheme={currentTheme}
                  themes={themes}
                />
              )}

              <div className="grid gap-6">
                {posts.map((post) => {
                  // الحصول على ألوان الثيم الحالي
                  const theme = themes[currentTheme] || themes.midnight;

                  // Mapping للـ hover classes لكل theme
                  const hoverTextClasses = {
                    plain: "group-hover:text-emerald-500",
                    sepia: "group-hover:text-amber-600",
                    ocean: "group-hover:text-cyan-500",
                    forest: "group-hover:text-emerald-500",
                    midnight: "group-hover:text-indigo-500",
                  };

                  const hoverBgClasses = {
                    plain: "hover:bg-emerald-500",
                    sepia: "hover:bg-amber-600",
                    ocean: "hover:bg-cyan-500",
                    forest: "hover:bg-emerald-600",
                    midnight: "hover:bg-indigo-500",
                  };

                  return (
                    <div
                      key={post.id}
                      onClick={() => handlePostClick(post)}
                      className="group bg-white/90 dark:bg-slate-800/90 rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border border-gray-100 dark:border-slate-700 overflow-hidden flex flex-col md:flex-row h-auto md:h-52 relative backdrop-blur-sm"
                    >
                      {/* Action Buttons in List View */}
                      <div className="absolute top-3 left-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <button
                          onClick={(e) => handleCopyLink(post.id, e)}
                          className={`p-2 rounded-full shadow-sm transition-all duration-300 ${
                            copiedPostId === post.id
                              ? "bg-green-500 text-white scale-110"
                              : "bg-white/90 dark:bg-black/50 hover:bg-gray-200 dark:hover:bg-gray-700"
                          }`}
                          title={
                            copiedPostId === post.id
                              ? "تم النسخ!"
                              : "نسخ الرابط"
                          }
                        >
                          {copiedPostId === post.id ? (
                            <Check size={16} />
                          ) : (
                            <LinkIcon size={16} />
                          )}
                        </button>
                        {/* 👇 زر التعديل: شرط isAdmin 👇 */}
                        {isAdmin && (
                          <button
                            onClick={(e) => handleEditPost(post, e)}
                            className={`bg-white/90 dark:bg-black/50 p-2 rounded-full shadow-sm ${
                              hoverBgClasses[currentTheme] ||
                              hoverBgClasses.midnight
                            } hover:text-white transition-colors`}
                            title="تعديل سريع"
                          >
                            <Edit size={16} />
                          </button>
                        )}
                      </div>

                      {post.coverImage && (
                        <div className="md:w-1/3 h-48 md:h-full overflow-hidden shrink-0">
                          <img
                            src={post.coverImage}
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                            loading="lazy"
                          />
                        </div>
                      )}
                      <div className="p-6 flex-1 flex flex-col justify-center">
                        <h2
                          className={`text-xl md:text-2xl font-bold mb-3 text-slate-900 dark:text-white ${
                            hoverTextClasses[currentTheme] ||
                            hoverTextClasses.midnight
                          } transition-colors md:line-clamp-2 leading-relaxed`}
                        >
                          {post.title}
                        </h2>
                        <p className="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mb-4">
                          {post.excerpt}
                        </p>
                        <div className="mt-auto w-full flex justify-between items-center relative">
                          <div className="flex gap-1 items-center flex-wrap">
                            {/* التاج الأول: يظهر دائماً */}
                            {post.topics?.length > 0 && (
                              <span
                                className={`text-[10px] ${theme.tagBgColor} ${theme.tagTextColor} px-2 py-0.5 rounded font-bold whitespace-nowrap border ${theme.borderColor}/30`}
                              >
                                #{post.topics[0]}
                              </span>
                            )}

                            {/* التاج الثاني: يظهر فقط في الشاشات أكبر من 350px */}
                            {post.topics?.length > 1 && (
                              <span
                                className={`hidden min-[350px]:inline-block text-[10px] ${theme.tagBgColor} ${theme.tagTextColor} px-2 py-0.5 rounded font-bold whitespace-nowrap border ${theme.borderColor}/30`}
                              >
                                #{post.topics[1]}
                              </span>
                            )}

                            {/* التاج الثالث: يظهر فقط في الشاشات المتوسطة (التابلت) فما فوق */}
                            {post.topics?.length > 2 && (
                              <span
                                className={`hidden md:inline-block text-[10px] ${theme.tagBgColor} ${theme.tagTextColor} px-2 py-0.5 rounded font-bold whitespace-nowrap border ${theme.borderColor}/30`}
                              >
                                #{post.topics[2]}
                              </span>
                            )}

                            {/* عداد المتبقي (+X) مع القائمة المنبثقة */}
                            {post.topics?.length > 1 && (
                              <div className="relative group/tags inline-block">
                                <span
                                  className={`cursor-pointer text-[10px] ${
                                    theme.tagBgColor
                                  } ${
                                    theme.tagTextColor
                                  } px-2 py-0.5 rounded font-bold ${
                                    hoverBgClasses[currentTheme] ||
                                    hoverBgClasses.midnight
                                  } hover:text-white transition-colors whitespace-nowrap`}
                                >
                                  + المزيد
                                </span>

                                {/* القائمة المنبثقة (Tooltip) - تعرض جميع الـ tags المخفية */}
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 shadow-xl opacity-0 invisible group-hover/tags:opacity-100 group-hover/tags:visible transition-all duration-200 z-50 pointer-events-none group-hover/tags:pointer-events-auto">
                                  <div className="flex flex-wrap gap-1 justify-center">
                                    {/* عرض جميع الـ tags ما عدا الأول (لأن الأول يظهر دائماً) */}
                                    {post.topics.slice(1).map((t, i) => (
                                      <span
                                        key={i}
                                        className="bg-white/20 px-1.5 py-0.5 rounded text-[9px] whitespace-nowrap"
                                      >
                                        #{t}
                                      </span>
                                    ))}
                                  </div>
                                  {/* سهم صغير يشير للأسفل */}
                                  <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                              </div>
                            )}
                          </div>

                          <div className="text-xs text-gray-400 font-medium shrink-0 mr-2">
                            {formatTimeAgo(post.createdAt) || "الآن"}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {loading && (
                <div className="col-span-full grid gap-6">
                  <SkeletonPost />
                  <SkeletonPost />
                  <SkeletonPost />
                </div>
              )}
              {!hasMore && posts.length > 0 && (
                <div className="col-span-full text-center text-gray-500 py-8 text-sm opacity-50">
                  -- تم عرض جميع المقالات --
                </div>
              )}
              {!loading && posts.length === 0 && (
                <div className="col-span-full text-center py-20 text-gray-500 bg-white/50 dark:bg-slate-800/50 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 backdrop-blur-sm">
                  لا توجد مقالات لعرضها حالياً.
                </div>
              )}
            </main>

            {/* Scroll to Top Button */}
            {showScrollTop && (
              <button
                onClick={scrollToTop}
                className="fixed bottom-8 right-8 z-40 p-3 rounded-full bg-primary text-white shadow-lg hover:bg-emerald-600 transition-all duration-300 hover:scale-110 animate-fade-in backdrop-blur-sm border border-white/20"
                title="العودة للأعلى"
                aria-label="العودة للأعلى"
              >
                <ChevronUp size={24} />
              </button>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
